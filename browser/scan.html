<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gomega • Scan ID</title>
  <style>
    :root { --ink:#e5e7eb; --muted:#94a3b8; --ok:#22c55e; --bad:#ef4444; --bg:#0b1220; }
    html,body{height:100%;margin:0}
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--ink);
         display:flex;align-items:center;justify-content:center;min-height:100vh}
    .wrap{max-width:860px;width:96vw}
    h1{margin:0 0 10px;font-size:22px}
    #preview{position:relative;width:100%;max-height:72vh;border-radius:12px;border:1px solid rgba(148,163,184,.25);overflow:hidden}
    #video,#overlay{width:100%;height:auto;display:block}
    .bar{margin:10px 0 0;color:var(--muted)}
    .bar.ok{color:var(--ok)} .bar.bad{color:var(--bad)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Scan your ID barcode</h1>
    <div id="preview"><div id="video"></div><canvas id="overlay"></canvas></div>
    <div class="bar" id="msg">Initializing camera…</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const session = params.get('session') || '';
    const msg = document.getElementById('msg');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');

    const isDigits = s => /^\d{4,50}$/.test(s);
    function setStatus(t,c){ msg.textContent=t; msg.className='bar ' + (c||''); }

    function drawBox(path, color, width=3){
      ctx.beginPath(); ctx.moveTo(path[0].x, path[0].y);
      for(let i=1;i<path.length;i++) ctx.lineTo(path[i].x, path[i].y);
      ctx.closePath(); ctx.lineWidth=width; ctx.strokeStyle=color; ctx.stroke();
    }

    function submitCode(code){
      setStatus('Unlocking…','');
      fetch('scan_submit.php?session='+encodeURIComponent(session)+'&code='+encodeURIComponent(code),
        {method:'GET',cache:'no-store'}
      )
      .then(r=>r.text())
      .then(t=>{
        if(t.trim()==='OK'){ setStatus('Unlocked — check Gomega Browser','ok'); try{Quagga.stop()}catch(e){} }
        else { setStatus('Failed to sync — try again','bad'); }
      })
      .catch(()=>setStatus('Network error — try again','bad'));
    }

    let last='', streak=0, failTimer=0, sized=false;

    Quagga.init({
      inputStream:{ type:"LiveStream", target:document.getElementById('video'), constraints:{facingMode:"environment"} },
      locator:{ patchSize:"medium", halfSample:true },
      decoder:{ readers:["code_128_reader","ean_reader","ean_8_reader","code_39_reader","codabar_reader","upc_reader","upc_e_reader","i2of5_reader"] },
      locate:true
    }, err=>{
      if(err){ setStatus('Camera error: '+err,'bad'); return; }
      Quagga.start(); setStatus('Point the camera at your ID barcode…','');
      const v = document.querySelector('#video video');
      function size(){ if(!v) return; const w=v.videoWidth||v.clientWidth, h=v.videoHeight||v.clientHeight; if(w&&h){overlay.width=w; overlay.height=h; sized=true;} }
      size(); window.addEventListener('resize', size);
    });

    Quagga.onProcessed(res=>{
      if(!sized) return;
      ctx.clearRect(0,0,overlay.width,overlay.height);
      if(!res) return;
      if(res.boxes){ res.boxes.filter(b=>b!==res.box).forEach(b=>drawBox(b,'rgba(147,197,253,.5)',2)); }
      if(res.box){ drawBox(res.box,'rgba(250,204,21,.9)',3); setStatus('Reading…',''); }
      if(res.codeResult && res.codeResult.code){ drawBox(res.line,'rgba(34,197,94,1)',4); }
    });

    Quagga.onDetected(res=>{
      const code = (res && res.codeResult && res.codeResult.code) ? String(res.codeResult.code).trim() : '';
      if(!isDigits(code)){ streak=0; last=''; setStatus('Reading… (waiting for numeric ID)',''); return; }
      if(code===last) streak++; else { last=code; streak=1; }
      setStatus('Reading… '+code+' ('+streak+'/3)','');
      if(streak>=3) submitCode(code);
    });

    const failInterval=setInterval(()=>{ if(msg.classList.contains('ok')){clearInterval(failInterval);return;} failTimer++; if(failTimer===20) setStatus('Failed — move closer, avoid glare, keep barcode flat','bad'); },1000);
  </script>
</body>
</html>