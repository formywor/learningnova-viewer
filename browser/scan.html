<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Gomega — ID Verification</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--bg:#0f172a;--panel:#111827;--ink:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--warn:#ef4444}
  html,body{height:100%;margin:0;background:linear-gradient(135deg,#0f172a 0%,#1f2937 40%,#0ea5e9 100%);font-family:Segoe UI,Arial,sans-serif;color:var(--ink)}
  .wrap{max-width:920px;margin:0 auto;padding:24px}
  .card{background:rgba(17,24,39,.7);border:1px solid rgba(148,163,184,.25);border-radius:16px;padding:16px 16px 20px;backdrop-filter:blur(10px);box-shadow:0 12px 40px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.04)}
  h1{margin:0 0 4px;font-size:20px}
  p{margin:4px 0;color:var(--muted);font-size:13px}
  #stage{position:relative;display:flex;justify-content:center;align-items:center;margin-top:12px}
  video{width:100%;max-width:820px;border-radius:12px;background:#000;aspect-ratio:16/9;object-fit:cover}
  canvas{position:absolute;inset:0;width:100%;max-width:820px;height:100%;border-radius:12px;pointer-events:none}
  .row{display:flex;align-items:center;gap:10px;margin-top:10px}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#0b1220;border:1px solid rgba(148,163,184,.25);font-size:12px}
  .ok{color:var(--accent)}
  .warn{color:var(--warn)}
  .btn{margin-top:10px;border:1px solid rgba(148,163,184,.35);background:#0b1220;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:active{transform:scale(.99)}
</style>
<!-- ZXing for robust 1D/2D barcode scanning -->
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Gomega — ID Verification</h1>
      <p id="desc">Loading camera…</p>

      <div id="stage">
        <video id="preview" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="row">
        <span class="badge" id="status">Initializing…</span>
        <span class="badge" id="hint">Show your barcode to the camera.</span>
      </div>

      <button class="btn" id="flip" style="display:none">Switch Camera</button>
    </div>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const session = qs.get('session');
  const statusEl = document.getElementById('status');
  const hintEl   = document.getElementById('hint');
  const descEl   = document.getElementById('desc');
  const video    = document.getElementById('preview');
  const overlay  = document.getElementById('overlay');
  const ctx      = overlay.getContext('2d');
  const flipBtn  = document.getElementById('flip');

  if(!session){
    statusEl.textContent = 'Missing session'; statusEl.classList.add('warn');
    descEl.textContent = 'This page must be opened by the launcher.';
    return;
  }

  let currentDeviceId = null;
  let devices = [];
  let submitted = false;
  let drawing = false;

  function setStatus(text, ok){
    statusEl.textContent = text;
    statusEl.classList.remove('ok','warn');
    if(ok === true) statusEl.classList.add('ok');
    if(ok === false) statusEl.classList.add('warn');
  }

  function fitCanvas(){
    const rect = video.getBoundingClientRect();
    overlay.width = rect.width * devicePixelRatio;
    overlay.height= rect.height* devicePixelRatio;
    overlay.style.width = rect.width + 'px';
    overlay.style.height= rect.height+ 'px';
  }
  window.addEventListener('resize', fitCanvas);

  async function enumerate(){
    try{
      const list = await navigator.mediaDevices.enumerateDevices();
      devices = list.filter(d => d.kind === 'videoinput');
      if(devices.length > 1) flipBtn.style.display = '';
    }catch(e){}
  }

  async function startCamera(preferBack=true){
    setStatus('Requesting camera…');
    let constraints = { video: { facingMode: preferBack ? {ideal:'environment'} : 'user' } };
    let stream;
    try{
      stream = await navigator.mediaDevices.getUserMedia(constraints);
    }catch(e){
      // fallback: try any camera
      stream = await navigator.mediaDevices.getUserMedia({video:true});
    }
    video.srcObject = stream;
    await video.play();
    await enumerate();
    // pick a concrete deviceId if possible (better perf for ZXing)
    const tracks = stream.getVideoTracks();
    if(tracks && tracks[0]){
      currentDeviceId = tracks[0].getCapabilities && tracks[0].getCapabilities().deviceId
        ? tracks[0].getCapabilities().deviceId : (tracks[0].getSettings ? tracks[0].getSettings().deviceId : null);
    }
    fitCanvas();
    setStatus('Reading…');
  }

  flipBtn.addEventListener('click', async () => {
    try{
      const stream = video.srcObject;
      if(stream){ stream.getTracks().forEach(t=>t.stop()); }
    }catch(e){}
    // rotate to next device
    if(devices.length>0){
      const idx = Math.max(0, devices.findIndex(d=>d.deviceId===currentDeviceId));
      const next = devices[(idx+1)%devices.length];
      currentDeviceId = next.deviceId;
      const stream = await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact: currentDeviceId}}});
      video.srcObject = stream; await video.play(); fitCanvas();
    }else{
      await startCamera(false);
    }
  });

  // ZXing setup
  const codeReader = new ZXing.BrowserMultiFormatReader();
  let lastDrawTime = 0;

  function drawBox(points, color){
    if(!points || points.length===0) return;
    const now = performance.now();
    if(now - lastDrawTime < 30) return; // throttle
    lastDrawTime = now;
    const r = video.getBoundingClientRect();
    const sx = overlay.width / r.width;
    const sy = overlay.height/ r.height;

    ctx.clearRect(0,0,overlay.width,overlay.height);
    ctx.lineWidth = 4;
    ctx.strokeStyle = color || '#22c55e';
    ctx.beginPath();
    ctx.moveTo(points[0].x*sx, points[0].y*sy);
    for (let i=1;i<points.length;i++)
      ctx.lineTo(points[i].x*sx, points[i].y*sy);
    ctx.closePath();
    ctx.stroke();
  }

  async function submitCode(code){
    if(submitted) return;
    submitted = true;
    setStatus('Unlocking…', true);
    hintEl.textContent = 'Sending scan to launcher…';
    // Try POST first, then GET fallback
    try{
      const body = new URLSearchParams({ session, code });
      await fetch('scan_submit.php', { method:'POST', body, credentials:'include', cache:'no-store', keepalive:true });
    }catch(e){
      try{
        await fetch(`scan_submit.php?session=${encodeURIComponent(session)}&code=${encodeURIComponent(code)}&t=${Date.now()}`, {cache:'no-store', credentials:'include'});
      }catch(e2){}
    }
    // Visual confirmation
    ctx.clearRect(0,0,overlay.width,overlay.height);
    drawBox([{x:20,y:20},{x:overlay.width-20,y:20},{x:overlay.width-20,y:overlay.height-20},{x:20,y:overlay.height-20}], '#22c55e');
    setStatus('Unlocked — You can return to Gomega Launcher.', true);
    descEl.textContent = 'Scan accepted. If the browser didn’t open automatically, it will in a moment.';
  }

  async function scanLoop(){
    try{
      const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
      // prefer currently open track device if known, else prefer back camera label
      let deviceId = currentDeviceId;
      if(!deviceId && devices.length){
        const back = devices.find(d => /back|rear|environment/i.test(d.label));
        deviceId = (back || devices[0]).deviceId;
      }
      await codeReader.decodeFromVideoDevice(deviceId, 'preview', (result, err, controls) => {
        if(result && result.getText){
          const txt = result.getText().trim();
          // draw green box
          const pts = (result.resultPoints || []).map(p => ({x:p.getX(), y:p.getY()}));
          drawBox(pts, '#22c55e');
          if(/^\d{6,20}$/.test(txt)){
            submitCode(txt);
            controls && controls.stop();
          }else{
            setStatus('Invalid code detected', false);
          }
        }else if(err && !(err instanceof ZXing.NotFoundException)){
          // decoding error (not just "not found")
          setStatus('Camera decode error', false);
        }else{
          // not found in this frame: show faint guide
          if(!submitted){
            ctx.clearRect(0,0,overlay.width,overlay.height);
            ctx.strokeStyle = "rgba(255,255,255,.25)";
            ctx.lineWidth = 2;
            const w = overlay.width * .6, h = overlay.height * .3;
            const x = (overlay.width - w)/2, y = (overlay.height - h)/2;
            ctx.strokeRect(x,y,w,h);
          }
        }
      });
    }catch(e){
      setStatus('Failed to start scanner', false);
      hintEl.textContent = (e && e.message) ? e.message : 'Check camera permissions.';
    }
  }

  // Boot
  (async () => {
    descEl.textContent = 'Gomega Intelligence is loading your camera…';
    await startCamera(true);
    await scanLoop();
  })();
})();
</script>
</body>
</html>