<html>
<head>
  <title>Gomega Browser Launcher — V17</title>
  <HTA:APPLICATION
    ID="GomegaBrowser" APPLICATIONNAME="Gomega Browser"
    BORDER="dialog" CAPTION="yes" SHOWINTASKBAR="yes"
    SINGLEINSTANCE="yes" SYSMENU="yes" SCROLL="no" WINDOWSTATE="normal">

  <style>
    html,body{height:100%;margin:0}
    body{font-family:Segoe UI,Arial,sans-serif;background:linear-gradient(135deg,#0f172a 0%,#1e293b 40%,#0ea5e9 100%);color:#e5e7eb;display:flex;align-items:center;justify-content:center}
    .card{width:640px;max-width:92vw;background:rgba(30,41,59,.6);border:1px solid rgba(148,163,184,.25);border-radius:16px;padding:24px 28px;backdrop-filter:blur(10px);box-shadow:0 12px 40px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.04)}
    .title{font-size:22px;font-weight:700;margin:0 0 6px}
    .subtitle{font-size:12px;color:#94a3b8;margin:0}
    .row{display:flex;align-items:center;gap:10px;margin-top:12px}
    .spinner{width:14px;height:14px;border:2px solid rgba(226,232,240,.35);border-top-color:#e5e7eb;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>

<script language="VBScript">
Option Explicit

' ===== Version =====
Dim g_version, g_versionCheckURL
g_version = "17"
g_versionCheckURL = "https://gomega.watch/browser/version.txt"

' ===== Chrome paths =====
Dim g_chromePaths
g_chromePaths = Array( _
  "C:\Program Files\Google\Chrome\Application\chrome.exe", _
  "C:\Program Files (x86)\Google\Chrome\Application\chrome.exe" _
)

' ===== Custom UA (from V7) =====
Dim g_r_customUA, g_customUA
g_r_customUA = StrReverse("Mozilla/5.0 (X11; CrOS aarch64 13099.85.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.110 Safari/537.36 - Google Search")
g_customUA   = StrReverse(g_r_customUA)

' ===== Endpoints =====
Dim SCAN_HTML, PULL_API, VALIDATE_API
SCAN_HTML    = "https://gomega.watch/browser/scan.html"
PULL_API     = "https://gomega.watch/browser/scan_pull.php"
VALIDATE_API = "https://gomega.watch/browser/validate_id.php"

' ===== Objects =====
Dim g_fso, g_shell, g_chrome
Set g_fso   = CreateObject("Scripting.FileSystemObject")
Set g_shell = CreateObject("WScript.Shell")

Sub SetStatus(t)
  On Error Resume Next
  document.getElementById("status").innerText = t
  On Error GoTo 0
End Sub

Function DQ(s): DQ = Replace(s, """", """""") : End Function

Function FirstExistingPath(arr)
  Dim i
  For i = 0 To UBound(arr)
    If g_fso.FileExists(arr(i)) Then FirstExistingPath = arr(i) : Exit Function
  Next
  FirstExistingPath = ""
End Function

Function CleanText(t)
  Dim s : s = CStr(t)
  If Len(s) > 0 Then If AscW(Left(s,1)) = 65279 Then s = Mid(s,2)
  CleanText = Trim(s)
End Function

Function AddCb(u)
  If InStr(u,"?")>0 Then AddCb = u & "&_cb=" & CLng(Timer*1000) Else AddCb = u & "?_cb=" & CLng(Timer*1000)
End Function

Function HttpGet(u)
  Dim r : r = HttpGet_Server(u) : If r = "" Then r = HttpGet_XML(u) : If r = "" Then r = HttpGet_WinHttp(u)
  HttpGet = r
End Function

Function HttpGet_Server(u)
  On Error Resume Next
  Dim x, s : Set x = CreateObject("MSXML2.ServerXMLHTTP.6.0")
  If TypeName(x)="Empty" Or TypeName(x)="Nothing" Then HttpGet_Server="" : Exit Function
  x.setTimeouts 5000,5000,8000,10000
  x.open "GET", AddCb(u), False
  x.setRequestHeader "Cache-Control","no-cache"
  x.setRequestHeader "Accept","text/plain,*/*"
  x.setRequestHeader "User-Agent","GomegaV17"
  x.send
  s = "" : If Err.Number=0 Then If x.Status=200 Then s = CStr(x.responseText)
  Set x = Nothing : On Error GoTo 0
  HttpGet_Server = CleanText(s)
End Function

Function HttpGet_XML(u)
  On Error Resume Next
  Dim x, s : Set x = CreateObject("MSXML2.XMLHTTP")
  If TypeName(x)="Empty" Or TypeName(x)="Nothing" Then HttpGet_XML="" : Exit Function
  x.open "GET", AddCb(u), False
  x.setRequestHeader "Cache-Control","no-cache"
  x.setRequestHeader "Accept","text/plain,*/*"
  x.setRequestHeader "User-Agent","GomegaV17"
  x.send
  s = "" : If Err.Number=0 And x.readyState=4 And x.status=200 Then s = CStr(x.responseText)
  Set x = Nothing : On Error GoTo 0
  HttpGet_XML = CleanText(s)
End Function

Function HttpGet_WinHttp(u)
  On Error Resume Next
  Dim w, s : Set w = CreateObject("WinHttp.WinHttpRequest.5.1")
  If TypeName(w)="Empty" Or TypeName(w)="Nothing" Then HttpGet_WinHttp="" : Exit Function
  w.Open "GET", AddCb(u), False
  w.SetRequestHeader "Cache-Control","no-cache"
  w.SetRequestHeader "Accept","text/plain,*/*"
  w.SetRequestHeader "User-Agent","GomegaV17"
  w.Send
  s = "" : If Err.Number=0 And w.Status=200 Then s = CStr(w.ResponseText)
  Set w = Nothing : On Error GoTo 0
  HttpGet_WinHttp = CleanText(s)
End Function

Function SegNum(seg)
  Dim i, ch, ds : ds = ""
  For i=1 To Len(seg) : ch = Mid(seg,i,1) : If ch>="0" And ch<="9" Then ds = ds & ch Else Exit For : Next
  If ds="" Then SegNum=0 Else SegNum=CLng(ds)
End Function

Function NormalizeVersion(s)
  Dim i, ch, out
  s = CleanText(s) : s = Replace(s,"V","") : s = Replace(s,"v","")
  out = "" : For i=1 To Len(s) : ch = Mid(s,i,1) : If (ch>="0" And ch<="9") Or ch="." Then out = out & ch : Next
  If out="" Then out = s
  NormalizeVersion = Trim(out)
End Function

Function CompareVersions(v1, v2)
  Dim a,b,i,n,x,y
  a = Split(Trim(CStr(v1)),".") : b = Split(Trim(CStr(v2)),".")
  n = UBound(a) : If UBound(b) > n Then n = UBound(b)
  For i=0 To n
    If i<=UBound(a) Then x = SegNum(a(i)) Else x = 0
    If i<=UBound(b) Then y = SegNum(b(i)) Else y = 0
    If x>y Then CompareVersions = 1 : Exit Function
    If x<y Then CompareVersions = -1 : Exit Function
  Next
  CompareVersions = 0
End Function

Function IsAllDigits(s)
  Dim i, ch
  If Len(s) < 6 Or Len(s) > 20 Then IsAllDigits=False : Exit Function
  For i=1 To Len(s) : ch = Mid(s,i,1) : If ch<"0" Or ch>"9" Then IsAllDigits=False : Exit Function : Next
  IsAllDigits=True
End Function

Sub SleepSeconds(sec)
  On Error Resume Next
  g_shell.Run "cmd /c ping -n " & (sec+1) & " 127.0.0.1>NUL", 0, True
  On Error GoTo 0
End Sub

Function RandomHex(n)
  Dim i, s, v : Randomize : s = ""
  For i=1 To n : v = Int(Rnd()*16) : s = s & Hex(v) : Next
  RandomHex = s
End Function

Function ChromeIsRunning()
  On Error Resume Next
  Dim p, out : Set p = g_shell.Exec("cmd /c tasklist /FI ""IMAGENAME eq chrome.exe"" /NH | find /I ""chrome.exe""")
  out = "" : If Not p Is Nothing Then out = LCase(p.StdOut.ReadAll)
  On Error GoTo 0
  ChromeIsRunning = (InStr(out,"chrome.exe")>0)
End Function

' ----- Openers -----
Sub OpenGoogleOnce()
  Dim cmd
  If ChromeIsRunning() Then
    cmd = """" & g_chrome & """ --new-tab ""https://www.google.com"""
  Else
    cmd = """" & g_chrome & """ --new-window ""https://www.google.com"""
  End If
  On Error Resume Next : g_shell.Run cmd, 1, False : On Error GoTo 0
End Sub

Sub OpenScanTab(sessionId)
  Dim url, cmd : url = SCAN_HTML & "?session=" & sessionId
  cmd = """" & g_chrome & """ --new-tab """ & url & """"
  On Error Resume Next : g_shell.Run cmd, 1, False : On Error GoTo 0
End Sub

Sub OpenGoogleWithUA()
  Dim profDir, cmd
  profDir = g_shell.ExpandEnvironmentStrings("%TEMP%") & "\GomegaUA_" & RandomHex(6)
  On Error Resume Next : If Not g_fso.FolderExists(profDir) Then g_fso.CreateFolder profDir : On Error GoTo 0
  cmd = """" & g_chrome & """ --user-data-dir=""" & profDir & _
        """ --new-window --no-first-run --no-default-browser-check " & _
        "--user-agent=""" & DQ(g_customUA) & """ ""https://www.google.com"""
  On Error Resume Next : g_shell.Run cmd, 1, False : On Error GoTo 0
End Sub

' ----- Scan + verify with persistent nudging -----
Function WaitForScan()
  Dim sessionId, resp, url, i, tick
  sessionId = RandomHex(24)

  SetStatus "Opening Google…"
  OpenGoogleOnce

  SetStatus "Opening ID verification tab…"
  ' Initial nudges (helps right-after-relaunch)
  For i = 1 To 6
    OpenScanTab sessionId
    SleepSeconds 1
    url = PULL_API & "?session=" & sessionId & "&_=" & CLng(Timer*1000)
    resp = HttpGet(url)
    If IsAllDigits(resp) Then WaitForScan = resp : Exit Function
  Next

  ' Keep polling; every 5s nudge the scan tab again
  SetStatus "Waiting for scan…"
  tick = 0
  Do
    url = PULL_API & "?session=" & sessionId & "&_=" & CLng(Timer*1000)
    resp = HttpGet(url)
    If IsAllDigits(resp) Then WaitForScan = resp : Exit Function
    SleepSeconds 1
    tick = tick + 1
    If (tick Mod 5) = 0 Then OpenScanTab sessionId
  Loop
End Function

Function ValidateOnlineName(code)
  Dim txt : txt = HttpGet(VALIDATE_API & "?code=" & code & "&_=" & CLng(Timer*1000))
  txt = CleanText(txt)
  If UCase(Left(txt,2)) = "OK" Then
    ValidateOnlineName = Trim(Mid(txt,3))
  Else
    ValidateOnlineName = ""
  End If
End Function

' ===== MAIN =====
Sub Initialize()
  Dim href, filePath, tf, fileContents, remoteV

  ' Integrity
  href = document.location.href
  If Left(href,8)="file:///" Then
    filePath = Mid(href,9)
  ElseIf Left(href,7)="file://" Then
    filePath = Mid(href,8)
  Else
    filePath = href
  End If
  filePath = Replace(filePath,"/","\") : filePath = Replace(filePath,"%20"," ")
  On Error Resume Next
  If g_fso.FileExists(filePath) Then Set tf = g_fso.OpenTextFile(filePath,1,False) : fileContents = tf.ReadAll : tf.Close Else fileContents = ""
  On Error GoTo 0
  If fileContents = "" Then MsgBox "Integrity check failed.", vbCritical, "Gomega" : Exit Sub

  SetStatus "Checking version…"
  remoteV = HttpGet(g_versionCheckURL)
  If remoteV = "" Then MsgBox "Version check failed.", vbExclamation, "Gomega" : Exit Sub
  If CompareVersions(NormalizeVersion(remoteV), NormalizeVersion(g_version)) <> 0 Then
    MsgBox "Version mismatch — download the new one." & vbCrLf & _
           "Installed: v" & g_version & vbCrLf & _
           "Remote: v" & NormalizeVersion(remoteV), vbExclamation, "Gomega"
    Exit Sub
  End If

  g_chrome = FirstExistingPath(g_chromePaths)
  If g_chrome = "" Then MsgBox "Google Chrome not found.", vbExclamation, "Gomega" : Exit Sub

  Dim code, name
  code = WaitForScan()

  SetStatus "Verifying…"
  name = ValidateOnlineName(code) ' optional welcome name
  If name = "" Then name = "User"

  SetStatus "Unlocked — Welcome " & name & ". Opening with UA…"
  OpenGoogleWithUA
  MsgBox "Unlocked — Welcome " & name & ".", vbInformation, "Gomega"
End Sub

Sub Window_OnLoad(): Initialize: End Sub
</script>
</head>
<body>
  <div class="card">
    <div class="title">Gomega Browser — V17</div>
    <div class="subtitle" id="status">Starting…</div>
    <div class="row"><div class="spinner"></div><div>Don’t close this window.</div></div>
  </div>
</body>
</html>
