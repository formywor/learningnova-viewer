<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Gomega Intelligence — Secure Access</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root{--bg:#0f172a;--panel:#111827;--ink:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--accent2:#0ea5e9;--warn:#ef4444;--info:#60a5fa;--border:rgba(148,163,184,.25)}
  html,body{height:100%;margin:0;background:linear-gradient(135deg,#0f172a 0%,#1f2937 40%,#0ea5e9 100%);font-family:Segoe UI,Arial,sans-serif;color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .card{background:rgba(17,24,39,.72);border:1px solid var(--border);border-radius:16px;padding:16px 16px 20px;backdrop-filter:blur(10px);box-shadow:0 12px 40px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.04)}
  .header{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .logo{width:44px;height:44px;border-radius:12px;background:conic-gradient(from 0deg,#22c55e 0 25%,#0ea5e9 0 50%,#7c3aed 0 75%,#22c55e)}
  h1{margin:0;font-size:22px}
  p{margin:4px 0;color:var(--muted);font-size:14px}
  .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--border);font-size:12px}
  .ok{color:var(--accent)} .warn{color:var(--warn)} .info{color:var(--info)}
  #stage{position:relative;display:flex;justify-content:center;align-items:center;margin-top:12px}
  video{width:100%;max-width:980px;border-radius:14px;background:#000;aspect-ratio:16/9;object-fit:cover}
  canvas{position:absolute;inset:0;width:100%;max-width:980px;height:100%;border-radius:14px;pointer-events:none}
  .row{display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap}
  .btn{border:1px solid rgba(148,163,184,.35);background:#0b1220;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:active{transform:scale(.99)}
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.5);backdrop-filter:blur(6px);z-index:50}
  .overlay.show{display:flex}
  .welcome{width:min(640px,92vw);border-radius:18px;padding:20px;background:rgba(17,24,39,.9);border:1px solid var(--border);box-shadow:0 12px 40px rgba(0,0,0,.45),inset 0 1px 0 rgba(255,255,255,.04)}
  .welcome h3{margin:0 0 8px;font-size:22px}
  .welcome p{font-size:14px;color:var(--muted)}
</style>

<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Gomega Intelligence — Secure Overview</h1>
          <p id="desc">Loading camera for barcode access…</p>
          <div class="badges">
            <span class="badge" id="status">Initializing…</span>
            <span class="badge" id="hint">Show your barcode to the camera.</span>
            <span class="badge info" id="reading" hidden>Reading barcode…</span>
          </div>
        </div>
      </div>

      <div id="stage">
        <video id="preview" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="row">
        <button class="btn" id="flip" hidden>Switch Camera</button>
        <button class="btn" id="torchBtn" hidden>Torch</button>
        <button class="btn" id="restartBtn">Force Restart Camera</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="welcomeOverlay" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle">
    <div class="welcome">
      <h3 id="welcomeTitle">Unlocked</h3>
      <p id="welcomeMsg">Return to the Gomega launcher. It will open the browser with the custom agent.</p>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="dismissBtn">Dismiss</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const SUBMIT_URL = 'https://gomega.watch/browser/scan_submit.php';
  const CONFIRM_HITS = 3;
  const session = new URLSearchParams(location.search).get('session');

  const statusEl  = document.getElementById('status');
  const hintEl    = document.getElementById('hint');
  const descEl    = document.getElementById('desc');
  const readingEl = document.getElementById('reading');
  const video     = document.getElementById('preview');
  const overlay   = document.getElementById('overlay');
  const ctx       = overlay.getContext('2d');
  const flipBtn   = document.getElementById('flip');
  const torchBtn  = document.getElementById('torchBtn');
  const restartBtn= document.getElementById('restartBtn');
  const welcomeOverlay = document.getElementById('welcomeOverlay');
  const dismissBtn     = document.getElementById('dismissBtn');

  let reader, controlsRef = null, mediaStream = null;
  let currentDeviceId = null, preferMode = 'fhd';
  let lastDraw = 0, lastText = '', repeatCount = 0;
  let unlocked = false;
  let heartbeatTimer = null, lastVideoTime = 0, stalledTicks = 0;

  function setStatus(text, cls){
    statusEl.textContent = text;
    statusEl.className = 'badge' + (cls ? ' ' + cls : '');
  }

  function fitOverlay(){
    const vw = video.videoWidth || 640, vh = video.videoHeight || 360;
    overlay.width = vw; overlay.height = vh;
    overlay.style.width  = video.clientWidth + 'px';
    overlay.style.height = video.clientHeight + 'px';
  }

  function drawPoly(points, color, width=4){
    if(!points || !points.length) return;
    const now = performance.now();
    if(now - lastDraw < 50) return;
    lastDraw = now;
    const sx = overlay.width  / (video.videoWidth  || overlay.width);
    const sy = overlay.height / (video.videoHeight || overlay.height);
    ctx.clearRect(0,0,overlay.width,overlay.height);
    ctx.lineWidth = width; ctx.strokeStyle = color;
    ctx.beginPath(); ctx.moveTo(points[0].x*sx, points[0].y*sy);
    for(let i=1;i<points.length;i++) ctx.lineTo(points[i].x*sx, points[i].y*sy);
    ctx.closePath(); ctx.stroke();
  }

  function showUnlocked(){
    setStatus('Unlocked — return to launcher','ok');
    welcomeOverlay.classList.add('show');
    try{ if(controlsRef && controlsRef.stop) controlsRef.stop(); }catch(e){}
    stopHeartbeat();
    try{ mediaStream?.getTracks?.().forEach(t=>t.stop()); }catch(e){}
  }

  async function pushToLauncher(code){
    if(!session) return;
    try{
      const body = new URLSearchParams({ session, code });
      await fetch(SUBMIT_URL, { method:'POST', body, cache:'no-store', keepalive:true, credentials:'include' });
    }catch(e){
      try{
        await fetch(`${SUBMIT_URL}?session=${encodeURIComponent(session)}&code=${encodeURIComponent(code)}&t=${Date.now()}`, { cache:'no-store', credentials:'include' });
      }catch(_){}
    }
  }

  async function listCameras(){
    const devs = await navigator.mediaDevices.enumerateDevices();
    return devs.filter(d=>d.kind==='videoinput');
  }

  async function pickBackCamera(){
    const cams = await listCameras();
    if(!cams.length) return null;
    const byLabel = cams.find(c => /back|rear|environment/i.test(c.label));
    return (byLabel || cams[0]).deviceId || null;
  }

  function startHeartbeat(){
    stopHeartbeat();
    lastVideoTime = video.currentTime; stalledTicks = 0;
    heartbeatTimer = setInterval(async ()=>{
      const track = mediaStream?.getVideoTracks?.()[0];
      const stalled = (video.currentTime === lastVideoTime);
      lastVideoTime = video.currentTime;
      if(!track || track.readyState === 'ended' || stalledTicks >= 3){
        await safeRestart();
        stalledTicks = 0;
        return;
      }
      if(stalled) stalledTicks++; else stalledTicks = 0;
    }, 1000);
  }
  function stopHeartbeat(){ if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer = null; } }

  async function stopCamera(){
    stopHeartbeat();
    try{ if(controlsRef && controlsRef.stop) controlsRef.stop(); }catch(e){}
    controlsRef = null;
    try{ mediaStream?.getTracks?.().forEach(t=>t.stop()); }catch(e){}
    mediaStream = null;
    video.srcObject = null;
  }

  let restarting = false;
  async function safeRestart(){
    if(restarting || unlocked) return;
    restarting = true;
    await stopCamera();
    if(preferMode==='fhd') preferMode='hd';
    try{ await startCamera(); await startDecoding(); }catch(e){}
    restarting = false;
  }

  async function startCamera(){
    setStatus('Requesting camera…','info');

    if(!currentDeviceId){
      try { currentDeviceId = await pickBackCamera(); } catch(_) {}
    }

    const bases = [
      (preferMode==='fhd') ? {width:{ideal:1920},height:{ideal:1080}} : {width:{ideal:1280},height:{ideal:720}},
      {width:{ideal:1280},height:{ideal:720}},
      {}
    ];
    let lastErr = null;

    for(const base of bases){
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio:false,
          video:{ deviceId: currentDeviceId?{exact:currentDeviceId}:undefined, facingMode:{ideal:'environment'}, frameRate:{ideal:30,min:10}, ...base }
        });
        break;
      }catch(e){ lastErr = e }
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio:false, video:{ facingMode:{ideal:'environment'}, frameRate:{ideal:30,min:10}, ...base }
        });
        break;
      }catch(e){ lastErr = e }
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio:false, video:{ frameRate:{ideal:30,min:10}, ...base } });
        break;
      }catch(e){ lastErr = e }
    }

    if(!mediaStream){
      const msg = (lastErr && lastErr.name) ? lastErr.name : 'Unknown';
      setStatus('Camera error: ' + msg, 'warn');
      descEl.textContent = 'Allow camera access and reload.';
      return;
    }

    video.srcObject = mediaStream;
    try{ await video.play(); }catch(_){}
    await new Promise(r=>setTimeout(r, 300));
    fitOverlay();

    try{
      const track = mediaStream.getVideoTracks()[0];
      const caps = track.getCapabilities?.() || {};
      torchBtn.hidden = !caps.torch;
      const cams = await listCameras();
      flipBtn.hidden = cams.length <= 1;
      track.onended = () => safeRestart();
    }catch(e){}

    startHeartbeat();
    setStatus('Reading…','info');
  }

  function initReader(){
    reader = new ZXing.BrowserMultiFormatReader();
    try{
      const hints = new Map();
      hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
        ZXing.BarcodeFormat.CODE_128, ZXing.BarcodeFormat.CODE_39, ZXing.BarcodeFormat.CODE_93,
        ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8, ZXing.BarcodeFormat.UPC_A,
        ZXing.BarcodeFormat.ITF, ZXing.BarcodeFormat.CODABAR, ZXing.BarcodeFormat.QR_CODE
      ]);
      reader.setHints(hints);
    }catch(e){}
  }

  function startDecoding(){
    controlsRef = reader.decodeFromConstraints({
      audio:false,
      video:{
        deviceId: currentDeviceId ? {exact: currentDeviceId} : undefined,
        facingMode:{ideal:'environment'},
        width:{ideal:(preferMode==='fhd'?1920:1280)},
        height:{ideal:(preferMode==='fhd'?1080:720)},
        frameRate:{ideal:30,min:10}
      }
    }, 'preview', (result, err
