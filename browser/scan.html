<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Gomega Intelligence — Secure Access</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root{--bg:#0f172a;--panel:#111827;--ink:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--accent2:#0ea5e9;--warn:#ef4444;--info:#60a5fa;--border:rgba(148,163,184,.25)}
  html,body{height:100%;margin:0;background:linear-gradient(135deg,#0f172a 0%,#1f2937 40%,#0ea5e9 100%);font-family:Segoe UI,Arial,sans-serif;color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .card{background:rgba(17,24,39,.72);border:1px solid var(--border);border-radius:16px;padding:16px 16px 20px;backdrop-filter:blur(10px);box-shadow:0 12px 40px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.04)}
  .header{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .logo{width:44px;height:44px;border-radius:12px;background:conic-gradient(from 0deg,#22c55e 0 25%,#0ea5e9 0 50%,#7c3aed 0 75%,#22c55e)}
  h1{margin:0;font-size:22px}
  p{margin:4px 0;color:var(--muted);font-size:14px}
  .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--border);font-size:12px}
  .ok{color:var(--accent)} .warn{color:var(--warn)} .info{color:var(--info)}
  #stage{position:relative;display:flex;justify-content:center;align-items:center;margin-top:12px}
  video{width:100%;max-width:980px;border-radius:14px;background:#000;aspect-ratio:16/9;object-fit:cover}
  canvas{position:absolute;inset:0;width:100%;max-width:980px;height:100%;border-radius:14px;pointer-events:none}
  .row{display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap}
  .btn{border:1px solid rgba(148,163,184,.35);background:#0b1220;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:active{transform:scale(.99)}
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.5);backdrop-filter:blur(6px);z-index:50}
  .overlay.show{display:flex}
  .welcome{width:min(640px,92vw);border-radius:18px;padding:20px;background:rgba(17,24,39,.9);border:1px solid var(--border);box-shadow:0 12px 40px rgba(0,0,0,.45),inset 0 1px 0 rgba(255,255,255,.04)}
  .welcome h3{margin:0 0 8px;font-size:22px}
  .welcome p{font-size:14px;color:var(--muted)}
</style>

<!-- ZXing for camera decoding -->
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Gomega Intelligence — Secure Overview</h1>
          <p id="desc">Loading camera for barcode access…</p>
          <div class="badges">
            <span class="badge" id="status">Initializing…</span>
            <span class="badge" id="hint">Show your barcode to the camera.</span>
            <span class="badge info" id="reading" hidden>Reading barcode…</span>
            <span class="badge" id="sync" hidden>Syncing…</span>
          </div>
        </div>
      </div>

      <div id="stage">
        <video id="preview" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="row">
        <button class="btn" id="flip" hidden>Switch Camera</button>
        <button class="btn" id="torchBtn" hidden>Torch</button>
        <button class="btn" id="restartBtn">Force Restart Camera</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="welcomeOverlay" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle">
    <div class="welcome">
      <h3 id="welcomeTitle">Unlocked</h3>
      <p id="welcomeMsg">Return to the launcher — it will open the browser with Gomega Intelligence.</p>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="dismissBtn">Dismiss</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // ----- endpoints & session -----
  const session = new URLSearchParams(location.search).get('session') || '';
  const SUBMIT_URL = 'https://gomega.watch/browser/scan_submit.php';
  const PULL_URL   = 'https://gomega.watch/browser/scan_pull.php';

  // ----- elements -----
  const statusEl  = document.getElementById('status');
  const hintEl    = document.getElementById('hint');
  const descEl    = document.getElementById('desc');
  const readingEl = document.getElementById('reading');
  const syncEl    = document.getElementById('sync');
  const video     = document.getElementById('preview');
  const overlay   = document.getElementById('overlay');
  const ctx       = overlay.getContext('2d');
  const flipBtn   = document.getElementById('flip');
  const torchBtn  = document.getElementById('torchBtn');
  const restartBtn= document.getElementById('restartBtn');
  const welcomeOverlay = document.getElementById('welcomeOverlay');
  const dismissBtn     = document.getElementById('dismissBtn');

  // ----- state -----
  const CONFIRM_HITS = 3;
  let reader, controlsRef = null, mediaStream = null;
  let currentDeviceId = null, preferMode = 'fhd';
  let lastDraw = 0, lastText = '', repeatCount = 0;
  let unlocked = false;
  let heartbeatTimer = null, lastVideoTime = 0, stalledTicks = 0;

  // ----- UI helpers -----
  function setStatus(text, cls){
    statusEl.textContent = text;
    statusEl.className = 'badge' + (cls ? ' ' + cls : '');
  }
  function fitOverlay(){
    const vw = video.videoWidth || 640, vh = video.videoHeight || 360;
    overlay.width = vw; overlay.height = vh;
    overlay.style.width  = video.clientWidth + 'px';
    overlay.style.height = video.clientHeight + 'px';
  }
  function drawPoly(points, color, width=4){
    if(!points || !points.length) return;
    const now = performance.now();
    if(now - lastDraw < 50) return;
    lastDraw = now;
    const sx = overlay.width  / (video.videoWidth  || overlay.width);
    const sy = overlay.height / (video.videoHeight || overlay.height);
    ctx.clearRect(0,0,overlay.width,overlay.height);
    ctx.lineWidth = width; ctx.strokeStyle = color;
    ctx.beginPath(); ctx.moveTo(points[0].x*sx, points[0].y*sy);
    for(let i=1;i<points.length;i++) ctx.lineTo(points[i].x*sx, points[i].y*sy);
    ctx.closePath(); ctx.stroke();
  }
  function faintGuide(){
    ctx.clearRect(0,0,overlay.width,overlay.height);
    ctx.strokeStyle = "rgba(255,255,255,.25)";
    ctx.lineWidth = 2;
    const w = overlay.width*.6, h = overlay.height*.3;
    const x = (overlay.width-w)/2, y = (overlay.height-h)/2;
    ctx.strokeRect(x,y,w,h);
  }
  function showUnlockedUI(){
    ctx.clearRect(0,0,overlay.width,overlay.height);
    drawPoly([{x:20,y:20},{x:overlay.width-20,y:20},{x:overlay.width-20,y:overlay.height-20},{x:20,y:overlay.height-20}], '#22c55e', 5);
    setStatus('Unlocked — return to launcher','ok');
    readingEl.hidden = true;
    welcomeOverlay.classList.add('show');
  }

  // ----- camera plumbing -----
  async function listCameras(){
    const devs = await navigator.mediaDevices.enumerateDevices();
    return devs.filter(d=>d.kind==='videoinput');
  }
  async function pickBackCamera(){
    const cams = await listCameras();
    if(!cams.length) return null;
    const byLabel = cams.find(c => /back|rear|environment/i.test(c.label));
    return (byLabel || cams[0]).deviceId || null;
  }
  function startHeartbeat(){
    stopHeartbeat();
    lastVideoTime = video.currentTime;
    stalledTicks = 0;
    heartbeatTimer = setInterval(async ()=>{
      const track = mediaStream?.getVideoTracks?.()[0];
      const stalled = (video.currentTime === lastVideoTime);
      lastVideoTime = video.currentTime;
      if(!track || track.readyState === 'ended'){ await safeRestart(); return; }
      if(stalled){ stalledTicks++; } else { stalledTicks = 0; }
      if(stalledTicks >= 3){ await safeRestart(); }
    }, 1000);
  }
  function stopHeartbeat(){ if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer = null; } }
  async function stopCamera(){
    stopHeartbeat();
    try{ if(controlsRef && controlsRef.stop) controlsRef.stop(); }catch(e){}
    controlsRef = null;
    try{ mediaStream?.getTracks?.().forEach(t=>t.stop()); }catch(e){}
    mediaStream = null;
    video.srcObject = null;
  }
  let restarting = false;
  async function safeRestart(){
    if(restarting || unlocked) return;
    restarting = true;
    await stopCamera();
    if(preferMode==='fhd') preferMode='hd';
    try{ await startCamera(); await startDecoding(); }catch(e){}
    restarting = false;
  }
  async function startCamera(){
    setStatus('Requesting camera…','info');
    if(!currentDeviceId){ try{ currentDeviceId = await pickBackCamera(); }catch(_){ } }
    const bases = [
      (preferMode==='fhd') ? {width:{ideal:1920},height:{ideal:1080}} : {width:{ideal:1280},height:{ideal:720}},
      {width:{ideal:1280},height:{ideal:720}},
      {}
    ];
    let lastErr = null;
    for(const base of bases){
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({audio:false, video:{ deviceId: currentDeviceId?{exact:currentDeviceId}:undefined, facingMode:{ideal:'environment'}, frameRate:{ideal:30,min:10}, ...base }});
        if(mediaStream) break;
      }catch(e){ lastErr = e }
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({audio:false, video:{ facingMode:{ideal:'environment'}, frameRate:{ideal:30,min:10}, ...base }});
        if(mediaStream) break;
      }catch(e){ lastErr = e }
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({audio:false, video:{ frameRate:{ideal:30,min:10}, ...base }});
        if(mediaStream) break;
      }catch(e){ lastErr = e }
    }
    if(!mediaStream){
      const msg = (lastErr && lastErr.name) ? lastErr.name : 'Unknown';
      setStatus('Camera error: ' + msg, 'warn');
      descEl.textContent = 'Allow camera access for this site and reload.';
      return;
    }
    video.srcObject = mediaStream;
    try{ await video.play(); }catch(_){}
    await new Promise(r=>setTimeout(r,300));
    try{ await video.play(); }catch(_){}
    fitOverlay();
    try{
      const track = mediaStream.getVideoTracks()[0];
      const caps = track.getCapabilities?.() || {};
      torchBtn.hidden = !caps.torch;
      const cams = await listCameras();
      flipBtn.hidden = cams.length <= 1;
      track.onended = () => safeRestart();
    }catch(e){}
    startHeartbeat();
    setStatus('Reading…','info');
  }

  // ----- ZXing -----
  function initReader(){
    reader = new ZXing.BrowserMultiFormatReader();
    try{
      const hints = new Map();
      hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
        ZXing.BarcodeFormat.CODE_128, ZXing.BarcodeFormat.CODE_39, ZXing.BarcodeFormat.CODE_93,
        ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8, ZXing.BarcodeFormat.UPC_A,
        ZXing.BarcodeFormat.ITF, ZXing.BarcodeFormat.CODABAR, ZXing.BarcodeFormat.QR_CODE
      ]);
      reader.setHints(hints);
    }catch(e){}
  }
  async function startDecoding(){
    controlsRef = reader.decodeFromConstraints({
      audio:false,
      video:{
        deviceId: currentDeviceId ? {exact: currentDeviceId} : undefined,
        facingMode:{ideal:'environment'},
        width:{ideal:(preferMode==='fhd'?1920:1280)},
        height:{ideal:(preferMode==='fhd'?1080:720)},
        frameRate:{ideal:30,min:10}
      }
    }, 'preview', (result, err, controls)=>{
      if(unlocked) return;
      if(result && result.getText){
        const txt = (result.getText()||'').trim();
        const pts = (result.resultPoints || []).map(p => ({x:(p.x ?? p.getX()), y:(p.y ?? p.getY())}));
        fitOverlay();
        const isDigits = /^\d{6,20}$/.test(txt);
        drawPoly(pts, isDigits ? '#22c55e' : '#ef4444');  // green = valid digits
        readingEl.hidden = false;
        if(isDigits){
          if(txt===lastText){ repeatCount++; } else { lastText=txt; repeatCount=1; }
          if(repeatCount >= CONFIRM_HITS){
            unlocked = true;
            try{ controls && controls.stop(); }catch(e){}
            syncToLauncher(txt).then(showUnlockedUI);
          }
        }else{
          setStatus('Invalid code format','warn');
        }
      }else if(err && !(err instanceof ZXing.NotFoundException)){
        setStatus('Decode error — recovering…','warn');
        readingEl.hidden = true;
        safeRestart();
      }else if(!unlocked){
        faintGuide();
      }
    });
  }

  // ----- Robust sync: POST then PULL confirm -----
  async function syncToLauncher(code){
    if(!session){ setStatus('Missing session','warn'); return; }
    setStatus('Syncing with launcher…','info');
    syncEl.hidden = false;

    const params = new URLSearchParams({ session, code });
    const pullURL = (extra=0)=> `${PULL_URL}?session=${encodeURIComponent(session)}&_=${Date.now()+extra}`;

    // up to 10 rounds: POST then poll PULL for a visible echo of digits
    for(let round=0; round<10; round++){
      try{
        // Primary: POST
        await fetch(SUBMIT_URL, {
          method:'POST',
          body: params,
          cache:'no-store',
          credentials:'include',
          keepalive:true,
          headers:{ 'Cache-Control':'no-cache', 'Pragma':'no-cache' }
        });
      }catch(_){ /* fallthrough to GET */ }

      // Fallback: GET-submit if POST is blocked by CORS/CDN
      try{
        await fetch(`${SUBMIT_URL}?session=${encodeURIComponent(session)}&code=${encodeURIComponent(code)}&t=${Date.now()}`, {
          cache:'no-store',
          credentials:'include',
          headers:{ 'Cache-Control':'no-cache', 'Pragma':'no-cache' }
        });
      }catch(_){}

      // Poll PULL to confirm
      try{
        const res = await fetch(pullURL(round), { cache:'no-store', credentials:'include', headers:{ 'Cache-Control':'no-cache', 'Pragma':'no-cache' }});
        const txt = (await res.text()).trim();
        if(/\d{6,20}/.test(txt)){ // any digits present means launcher will see it too
          setStatus('Synced — return to launcher','ok');
          syncEl.hidden = true;
          return;
        }
      }catch(_){}

      await new Promise(r=>setTimeout(r, 500)); // brief pause then retry
    }

    // Even if we didn’t confirm, we still show unlocked UI (launcher may grab on next beat)
    setStatus('Synced (best effort) — return to launcher','ok');
    syncEl.hidden = true;
  }

  // ----- controls -----
  document.getElementById('restartBtn').onclick = async ()=>{
    setStatus('Restarting camera…','info');
    await safeRestart();
  };
  document.getElementById('flip').onclick = async ()=>{
    const cams = await listCameras();
    if(!cams.length) return;
    const idx = currentDeviceId ? Math.max(0, cams.findIndex(d=>d.deviceId===currentDeviceId)) : -1;
    currentDeviceId = cams[(idx+1)%cams.length].deviceId;
    await safeRestart();
  };
  document.getElementById('torchBtn').onclick = async ()=>{
    try{
      const track = mediaStream?.getVideoTracks?.()[0];
      if(!track) return;
      const on = torchBtn.dataset.on==='1';
      await track.applyConstraints({ advanced:[{ torch: !on }] });
      torchBtn.dataset.on = (!on?'1':'0');
      torchBtn.textContent = (!on?'Torch (On)':'Torch');
    }catch(e){}
  };
  document.getElementById('dismissBtn').onclick = ()=>{
    window.open('','_self'); window.close();
    setTimeout(()=>{ // if close blocked, at least stop camera
      try{ video.pause(); }catch(_){}
      try{ mediaStream?.getTracks?.().forEach(t=>t.stop()); }catch(_){}
      welcomeOverlay.classList.remove('show');
    }, 200);
  };

  document.addEventListener('visibilitychange', async ()=>{
    if(document.hidden){ await stopCamera(); }
    else if(!unlocked){ await safeRestart(); }
  });

  // ----- boot -----
  (async ()=>{
    if(!session){
      setStatus('Missing session','warn');
      descEl.textContent = 'This page must be opened by the launcher.';
      return;
    }
    descEl.textContent = 'Gomega Intelligence is loading your camera…';
    try{ await navigator.mediaDevices.getUserMedia({video:true}); }catch(_){}
    initReader();
    await startCamera();
    if(mediaStream){ await startDecoding(); }
    else{
      setStatus('Camera unavailable — check permissions','warn');
      descEl.textContent = 'Allow camera access and reload.';
    }
  })();
})();
</script>
</body>
</html>
