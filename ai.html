<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gomega AI — Smarter Math & Photo BETA</title>

<!-- math.js for safe numeric & symbolic math -->
<script src="https://cdn.jsdelivr.net/npm/mathjs@11.9.1/lib/browser/math.js"></script>

<style>
  :root{
    --bg1:#071021; --bg2:#0b1220; --accent:#34d3ff; --accent2:#7c3aed; --muted:#94a3b8;
    --ok:#28a745; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background: radial-gradient(900px 400px at 10% 10%, rgba(56,189,248,0.04), transparent),
                linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#e6eef6; display:flex; flex-direction:column; align-items:center; padding:18px;
  }
  .topbar{ width:100%; max-width:1100px; display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
  .brand{ display:flex; gap:12px; align-items:center; }
  .logo{ width:56px; height:56px; border-radius:12px; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; transform:rotate(-8deg) }
  .logo b{ color:#062; font-size:20px }
  h1{ margin:0; font-size:20px; color:#e6fbff; text-shadow:0 6px 22px rgba(0,0,0,0.6) }
  .meta{ color:var(--muted); font-size:13px }

  .container{ width:100%; max-width:1100px; display:grid; grid-template-columns: 1fr 380px; gap:18px; align-items:start; }
  .chat-area{ background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); padding:18px; border-radius:14px; min-height:640px; max-height:80vh; overflow:auto; border:1px solid rgba(255,255,255,0.02) }
  .messages{ display:flex; flex-direction:column; gap:12px; padding-right:6px }

  .bubble{ max-width:82%; padding:12px 14px; border-radius:12px; line-height:1.45; position:relative; animation: slideUp .28s ease }
  .bubble.user{ background: linear-gradient(90deg,#0b6b4c,#064e3b); color:#d7fff0; align-self:flex-end; border-bottom-right-radius:6px; }
  .bubble.ai{ background: linear-gradient(90deg,#0b1020,#151827); color:#e6eef6; align-self:flex-start; border-bottom-left-radius:6px; }
  @keyframes slideUp { from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none} }
  .caret{ display:inline-block; width:2px; height:1em; background:var(--accent); margin-left:6px; vertical-align:bottom; animation: blinkCaret 1s steps(2,end) infinite; }
  @keyframes blinkCaret { 50%{ opacity:0 } }

  .controls{ display:flex; gap:10px; align-items:center; margin-top:10px; }
  input.prompt{ flex:1; padding:12px; border-radius:10px; background:transparent; color:#e6eef6; border:1px solid rgba(255,255,255,0.03); outline:none; font-size:15px }
  button.primary{ padding:12px 18px; border-radius:10px; border:none; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#062; cursor:pointer; font-weight:700 }
  button.ghost{ padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--muted); cursor:pointer }
  .disabled{ opacity:0.5; pointer-events:none }

  .sidebar{ padding:18px; border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border:1px solid rgba(255,255,255,0.02); min-height:640px; display:flex; flex-direction:column; gap:12px; }
  .card{ padding:12px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.02) }

  .models{ display:flex; flex-direction:column; gap:8px; }
  .modelRow{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); }
  .small{ font-size:13px; color:var(--muted) }

  .progress{ height:8px; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; width:100% }
  .bar{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent2)); transition:width 180ms linear }

  .photoGrid{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  .photoCard{ width:86px; height:66px; border-radius:6px; overflow:hidden; background:#000; display:flex; align-items:center; justify-content:center; position:relative }
  .photoCard img{ width:100%; height:100%; object-fit:cover }
  .photoActions{ position:absolute; bottom:6px; left:6px; right:6px; display:flex; gap:6px; justify-content:center }

  .explain{ margin-top:8px; font-size:13px; color:var(--muted); border-top:1px dashed rgba(255,255,255,0.03); padding-top:8px }

  @media (max-width:980px){ .container{ grid-template-columns:1fr } .sidebar{ order:2 } .chat-area{ order:1 } }
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo"><b>G</b></div>
      <div>
        <h1>Gomega AI</h1>
        <div class="meta">Client-only • 10-source attempts • Smarter symbolic math & Photo BETA</div>
      </div>
    </div>
    <div style="text-align:right">
      <div class="meta">Local: <span id="localTime">—</span></div>
      <div class="meta">Last: <span id="lastFetch">—</span></div>
    </div>
  </div>

  <div class="container">
    <div class="chat-area">
      <div class="messages" id="messages"></div>

      <div class="controls" style="margin-top:12px">
        <input id="prompt" class="prompt" placeholder="Ask (e.g. 'Simplify 4a-2(5a-7)' or 'Area of circle radius 5')" />
        <button id="askBtn" class="primary">Ask</button>
        <button id="clearBtn" class="ghost">Clear</button>
      </div>

      <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <label class="small">Thinking</label>
        <input type="checkbox" id="thinkingToggle" />
        <label class="small" style="margin-left:8px">Strict</label>
        <input type="checkbox" id="strictToggle" />
      </div>
    </div>

    <div class="sidebar">
      <div class="card">
        <strong>Models</strong>
        <div class="models" id="modelList"></div>
      </div>

      <div class="card">
        <strong>Thinking & Progress</strong>
        <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
          <div class="small">Status:</div><div id="thinkingBadge" class="small">Idle</div>
        </div>
        <div style="margin-top:8px" class="progress"><div id="progressBar" class="bar"></div></div>
        <div style="margin-top:8px" class="small">Confidence: <span id="confidence">—</span></div>
        <div class="explain" id="lastAction">No action yet.</div>
      </div>

      <div class="card">
        <strong>Photos (BETA)</strong>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
          <input type="file" id="photoInput" accept="image/*">
          <button id="addPhotoBtn" class="ghost">Add</button>
        </div>
        <div class="small" style="margin-top:8px">Daily sends left: <span id="photoQuota">5</span>/5</div>
        <div class="photoGrid" id="photoGrid"></div>
        <div class="small" style="margin-top:8px">Photos are stored locally for this page session. You may send up to 5 per day while BETA is active.</div>
      </div>

      <div class="card">
        <strong>Session memory</strong>
        <div id="sessionList" class="small" style="margin-top:8px">No messages yet.</div>
        <div style="margin-top:8px"><button id="clearSession" class="ghost">Clear Memory</button></div>
      </div>

    </div>
  </div>

<script>
/* Gomega AI (single file) - updated:
   - math.js (symbolic simplify + numeric eval)
   - photo upload BETA with daily 5-send quota (localStorage)
   - disabled typing while AI types
   - client-side multi-source attempts (Wikipedia & DuckDuckGo) retained
*/

// UI refs
const messagesEl = document.getElementById('messages');
const promptEl = document.getElementById('prompt');
const askBtn = document.getElementById('askBtn');
const clearBtn = document.getElementById('clearBtn');
const thinkingToggle = document.getElementById('thinkingToggle');
const strictToggle = document.getElementById('strictToggle');
const thinkingBadge = document.getElementById('thinkingBadge');
const progressBar = document.getElementById('progressBar');
const lastAction = document.getElementById('lastAction');
const confidenceEl = document.getElementById('confidence');
const lastFetchEl = document.getElementById('lastFetch');

const photoInput = document.getElementById('photoInput');
const addPhotoBtn = document.getElementById('addPhotoBtn');
const photoGrid = document.getElementById('photoGrid');
const photoQuotaEl = document.getElementById('photoQuota');

const sessionListEl = document.getElementById('sessionList');
const clearSessionBtn = document.getElementById('clearSession');

let session = []; // chat history
let photos = [];  // {id, name, dataURL, sent:false}
let typingLocked = false;

// Model profiles
const MODELS = {
  v8:  {label:'Gomega V8', speed:90, verb:1.4, prefer:10, desc:'Flagship — deep reasoning'},
  v7:  {label:'Gomega V7', speed:70, verb:1.0, prefer:8, desc:'Balanced & timely'},
  v7m: {label:'Gomega V7-mini', speed:22, verb:0.5, prefer:4, desc:'Fast & concise'},
  v6:  {label:'Gomega V6', speed:95, verb:1.6, prefer:10, desc:'Researcher aggressive'},
  v5:  {label:'Gomega V5', speed:60, verb:1.0, prefer:6, desc:'Stable'},
  math:{label:'MathMaster', speed:32, verb:0.2, prefer:1, desc:'Calculation specialist'}
};
let currentModelKey = 'v8';

// render models
const modelListEl = document.getElementById('modelList');
Object.keys(MODELS).forEach(k=>{
  const m = MODELS[k];
  const row = document.createElement('div'); row.className='modelRow';
  row.innerHTML = `<div><strong>${m.label}</strong><div class="small">${m.desc}</div></div>`;
  const btn = document.createElement('button'); btn.textContent = (k===currentModelKey ? 'Selected' : 'Select');
  btn.onclick = () => { currentModelKey = k; Array.from(modelListEl.querySelectorAll('button')).forEach(b=>b.textContent='Select'); btn.textContent='Selected'; thinkingBadge.textContent = `Model: ${m.label}`; };
  row.appendChild(btn); modelListEl.appendChild(row);
});

// --- helpers ---
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function addBubble(role, html){ const el = document.createElement('div'); el.className = 'bubble ' + (role==='user' ? 'user':'ai'); el.innerHTML = html; messagesEl.appendChild(el); messagesEl.scrollTop = messagesEl.scrollHeight; return el; }
function updateSessionUI(){ sessionListEl.innerHTML = session.slice(-6).map(m=>`<div class="small"><strong>${escapeHtml(m.role)}</strong>: ${escapeHtml(m.text).slice(0,140)}</div>`).join('') || 'No messages yet.'; }
function setProgress(p){ progressBar.style.width = Math.max(3, Math.min(100,p)) + '%'; }
function setThinkingText(t){ thinkingBadge.textContent = t; lastAction.textContent = t; }
function setTypingLocked(v){ typingLocked = v; promptEl.disabled = v; askBtn.disabled = v; clearBtn.disabled = v; if(v){ promptEl.classList.add('disabled'); askBtn.classList.add('disabled'); clearBtn.classList.add('disabled'); } else { promptEl.classList.remove('disabled'); askBtn.classList.remove('disabled'); clearBtn.classList.remove('disabled'); } }

// human-like typing into a bubble
async function typeTextInto(node, text, speed){
  node.innerHTML = '';
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    node.innerHTML = escapeHtml(text.slice(0,i+1)).replace(/\n/g,'<br>');
    messagesEl.scrollTop = messagesEl.scrollHeight;
    const variability = 0.8 + Math.random()*0.6;
    let delay = Math.max(8, Math.round(speed * variability));
    if(/[,;]/.test(ch)) delay += 120;
    if(/[.!?]/.test(ch)) delay += 260;
    await new Promise(r=>setTimeout(r, delay));
  }
}

// ---------- math & algebra (math.js) ----------
function algebraSimplify(input){
  // try to simplify symbolically using math.simplify
  try{
    // Remove phrases like "simplify" or "what is"
    const cleaned = input.replace(/^\s*(simplify|what is|calculate)\s*/i, '').trim();
    // if expression contains letters (variables), attempt simplify
    if(/[a-zA-Z]/.test(cleaned)){
      const node = math.simplify(cleaned);
      let out = node.toString(); // e.g., "14 - 6*a"
      // nicer formatting: remove "*"
      out = out.replace(/\*/g, '');
      // replace multiple spaces
      out = out.replace(/\s+/g,' ').trim();
      return out;
    }
    return null;
  } catch(e){
    return null;
  }
}

function numericEval(input){
  try{
    // use math.evaluate for numeric computations
    const cleaned = input.replace(/[^0-9+\-*/().,\s%^]/g,' '); // remove letters etc
    const expr = cleaned.replace(/,/g,'').trim();
    if(!expr) return null;
    const val = math.evaluate(expr);
    if(typeof val === 'number' && Number.isFinite(val)) return +(+val.toFixed(12));
    return null;
  } catch(e){
    return null;
  }
}

// geometry query (client-side)
function tryGeometryQuery(q){
  if(!q) return null;
  const s = q.toLowerCase();
  let m;
  m = s.match(/area of (?:a |the )?circle(?: with)?(?: radius| r)?[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const r=Number(m[1]); if(isFinite(r)) return {result: +(Math.PI*r*r).toFixed(8), explain:`area circle r=${r}`} }
  m = s.match(/circumference of (?:a |the )?circle(?: with)?(?: radius| r)?[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const r=Number(m[1]); if(isFinite(r)) return {result: +(2*Math.PI*r).toFixed(8), explain:`circumference r=${r}`} }
  m = s.match(/area of (?:a |the )?rectangle(?: with)?(?: width)?[^\d\-]*([-+]?\d*\.?\d+)[^\d\-]+(?:height|h)[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const w=Number(m[1]), h=Number(m[2]); if(isFinite(w)&&isFinite(h)) return {result: +(w*h).toFixed(8), explain:`rectangle ${w}×${h}`} }
  m = s.match(/area of (?:a |the )?triangle(?: with)?(?: base)?[^\d\-]*([-+]?\d*\.?\d+)[^\d\-]+(?:height|h)[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const b=Number(m[1]), h=Number(m[2]); if(isFinite(b)&&isFinite(h)) return {result: +((b*h/2)).toFixed(8), explain:`triangle base=${b} height=${h}`} }
  m = s.match(/pythagor(?:ean|e).*a[^\d\-]*([-+]?\d*\.?\d+).*b[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const a=Number(m[1]), b=Number(m[2]); if(isFinite(a)&&isFinite(b)) return {result: +(Math.sqrt(a*a + b*b)).toFixed(8), explain:`hypotenuse from ${a},${b}`} }
  m = s.match(/given\s+a[=\s]*([-+]?\d*\.?\d+)[,;\s]*b[=\s]*([-+]?\d*\.?\d+)/i);
  if(m){ const a=Number(m[1]), b=Number(m[2]); if(isFinite(a)&&isFinite(b)) return {result: +(Math.sqrt(a*a + b*b)).toFixed(8), explain:`hypotenuse from ${a},${b}`} }
  m = s.match(/volume of (?:a |the )?sphere(?: with)?(?: radius)?[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const r=Number(m[1]); if(isFinite(r)) return {result: +((4/3)*Math.PI*r*r*r).toFixed(8), explain:`sphere vol r=${r}`} }
  m = s.match(/volume of (?:a |the )?cylind(?:er|rical).*radius[^\d\-]*([-+]?\d*\.?\d+)[^\d\-]+height[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const r=Number(m[1]), h=Number(m[2]); if(isFinite(r)&&isFinite(h)) return {result: +(Math.PI*r*r*h).toFixed(8), explain:`cylinder r=${r} h=${h}`} }

  // fallback numeric inside text
  const anyNum = q.match(/[-+*/().0-9,\s%^]+/);
  if(anyNum){
    const num = numericEval(anyNum[0]);
    if(num !== null) return {result: num, explain: 'evaluated numeric expression'};
  }
  return null;
}

// ---------- photos BETA + quota ----------
const DAILY_QUOTA = 5;
function quotaKeyForToday(){
  const d = new Date(); const y = d.getFullYear(), m = (d.getMonth()+1).toString().padStart(2,'0'), day = d.getDate().toString().padStart(2,'0');
  return `gomega_photo_quota_${y}${m}${day}`;
}
function getQuotaUsed(){
  const k = quotaKeyForToday(); return parseInt(localStorage.getItem(k) || '0', 10);
}
function incrementQuota(){
  const k = quotaKeyForToday(); const used = getQuotaUsed() + 1; localStorage.setItem(k, String(used)); updateQuotaUI(); return used;
}
function updateQuotaUI(){ const used = getQuotaUsed(); photoQuotaEl.textContent = Math.max(0, DAILY_QUOTA - used); }

// add photo (store as data URL preview, not uploaded anywhere)
addPhotoBtn.addEventListener('click', ()=>{
  const f = photoInput.files && photoInput.files[0];
  if(!f){ alert('Choose an image file first'); return; }
  if(!/^image\//.test(f.type)){ alert('Only images allowed'); return; }
  const reader = new FileReader();
  reader.onload = (ev) => {
    const data = ev.target.result;
    const id = 'p' + Date.now();
    photos.push({id, name: f.name, url: data, sent:false});
    renderPhotos();
  };
  reader.readAsDataURL(f);
});

function renderPhotos(){
  photoGrid.innerHTML = '';
  photos.forEach(p=>{
    const card = document.createElement('div'); card.className='photoCard';
    const img = document.createElement('img'); img.src = p.url; img.alt = p.name;
    card.appendChild(img);
    const actions = document.createElement('div'); actions.className='photoActions';
    const sendBtn = document.createElement('button'); sendBtn.className='ghost'; sendBtn.textContent = p.sent ? 'Sent' : 'Send';
    sendBtn.onclick = () => {
      if(p.sent){ alert('Already sent'); return; }
      const used = getQuotaUsed();
      if(used >= DAILY_QUOTA){ alert('Daily send limit reached (5). Try again tomorrow.'); return; }
      // send to chat (user message containing image)
      addImageToChatAsUser(p);
      p.sent = true;
      incrementQuota();
      renderPhotos();
    };
    const removeBtn = document.createElement('button'); removeBtn.className='ghost'; removeBtn.textContent='Remove';
    removeBtn.onclick = ()=>{ photos = photos.filter(x=>x.id !== p.id); renderPhotos(); };
    actions.appendChild(sendBtn); actions.appendChild(removeBtn);
    card.appendChild(actions);
    photoGrid.appendChild(card);
  });
  updateQuotaUI();
}

// when user sends image to chat, add a user bubble with embedded image and mark as sent
function addImageToChatAsUser(photo){
  const html = `<div style="font-size:13px; color:var(--muted); margin-bottom:6px">Image: ${escapeHtml(photo.name)}</div><img src="${photo.url}" style="max-width:320px; width:100%; border-radius:8px" alt="${escapeHtml(photo.name)}">`;
  addBubble('user', html);
  session.push({role:'user', text:`[image:${photo.name}]`, img:photo});
  updateSessionUI();
}

// ---------- lightweight gather (client-only) ----------
async function fetchWikiSummary(q){
  try{
    const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(q)}`, {mode:'cors'});
    if(!r.ok) return null;
    const j = await r.json(); if(j && j.extract) return j.extract; return null;
  }catch(e){ return null; }
}
async function fetchDDG(q){
  try{
    const r = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(q)}&format=json&no_html=1&skip_disambig=1`);
    if(!r.ok) return null; const j = await r.json(); const t = j.Abstract || (j.RelatedTopics ? j.RelatedTopics.map(t=>t.Text).join('. ') : ''); return t || null;
  }catch(e){ return null; }
}
async function fetchWikiSearchSummaries(q, limit=6){
  const out = [];
  try{
    const r = await fetch(`https://en.wikipedia.org/w/api.php?action=query&format=json&list=search&srsearch=${encodeURIComponent(q)}&srlimit=${limit}&origin=*`);
    if(!r.ok) return out; const j = await r.json(); const hits = j.query?.search || [];
    for(const h of hits){
      const s = await fetchWikiSummary(h.title);
      if(s) out.push(s);
      if(out.length >= limit) break;
    }
  }catch(e){}
  return out;
}
const EXPANSIONS = ['history','release date','overview','timeline','founding','specifications','launch date','origin','background'];
async function gatherSnippets(query, desired=10, aggressive=false, progressCb){
  const snippets = [];
  progressCb && progressCb('Trying Wikipedia summary...');
  const s1 = await fetchWikiSummary(query); if(s1) snippets.push(s1);
  progressCb && progressCb('Trying DuckDuckGo...');
  const d = await fetchDDG(query); if(d) snippets.push(d);
  progressCb && progressCb('Searching wiki hits...');
  const hits = await fetchWikiSearchSummaries(query, Math.max(3, Math.min(8, desired)));
  hits.forEach(h=>snippets.push(h));
  if(aggressive){
    for(const ex of EXPANSIONS){ if(snippets.length>=desired) break; progressCb && progressCb(`Expanding: ${ex}`); const s=await fetchWikiSummary(query + ' ' + ex); if(s) snippets.push(s); }
  }
  // dedupe
  const seen = new Set(); const out = [];
  for(const t of snippets){
    const key = t.slice(0,200).replace(/\s+/g,' ').trim();
    if(!seen.has(key)){ seen.add(key); out.push(t); }
    if(out.length>=desired) break;
  }
  return out;
}

// ---------- answer pick & confidence ----------
function extractYear(text){
  if(!text) return null;
  const m = text.match(/\b(17\d{2}|18\d{2}|19\d{2}|20\d{2}|2100)\b/g);
  if(!m) return null;
  const freq={}; m.forEach(y=>freq[y]=(freq[y]||0)+1);
  return Object.keys(freq).sort((a,b)=>freq[b]-freq[a])[0];
}
function pickBest(snips, q, modelKey, strictOnly){
  if(!snips || snips.length===0) return {answer:"I couldn't find an answer.", confidence:10};
  const wantsYear = /\bwhat\s+year|\bwhen\s+was|\bwhen\s+did\b/i.test(q) || /only the year|just the year/i.test(q);
  if(wantsYear){
    const years=[]; snips.forEach(s=>{ const y=extractYear(s); if(y) years.push(y); });
    if(years.length>0){
      const freq={}; years.forEach(y=>freq[y]=(freq[y]||0)+1);
      const pick = Object.keys(freq).sort((a,b)=>freq[b]-freq[a])[0];
      const conf = Math.min(95, 40 + (freq[pick]-1)*20 + Math.min(40, snips.length*3));
      return {answer: pick, confidence:conf};
    }
  }
  // pick longest snippet
  let best = snips.slice().sort((a,b)=>b.length-a.length)[0];
  const sentences = (best||'').split(/(?<=\.)\s+/).filter(Boolean);
  const verb = MODELS[modelKey].verb || 1;
  const take = Math.max(1, Math.floor(verb * 1.6));
  let answer = sentences.slice(0,take).join(' ').trim();
  if(!answer) answer = (best||'').slice(0,300).trim();
  if(strictOnly && /\bonly the year\b|\bonly the number\b/i.test(q)){
    const n = answer.match(/-?\d+(\.\d+)?/);
    if(n) return {answer:n[0], confidence: Math.min(90, 20 + snips.length*6)};
  }
  const filled = snips.filter(s=>s.length>40).length;
  let conf = Math.min(95, 30 + filled*8 + Math.min(30,(snips.length-1)*3));
  // bump if year agreement
  const yearsFound = {}; snips.forEach(s=>{ const y=extractYear(s); if(y) yearsFound[y]=(yearsFound[y]||0)+1; });
  if(Object.keys(yearsFound).length>0){ const bestY = Object.keys(yearsFound).sort((a,b)=>yearsFound[b]-yearsFound[a])[0]; conf += Math.min(10,(yearsFound[bestY]-1)*5); }
  conf = Math.min(99, Math.max(8, Math.round(conf)));
  return {answer, confidence:conf};
}

// ---------- main ask flow ----------
askBtn.addEventListener('click', handleAsk);
promptEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ handleAsk(); e.preventDefault(); }});
clearBtn.addEventListener('click', ()=>{ messagesEl.innerHTML=''; session=[]; updateSessionUI(); });

function looksLikeMath(q){ return /[0-9\+\-\*\/\^%()a-zA-Z]/.test(q) || /\b(area|circumference|perimeter|volume|pythagor|triangle|circle|radius|height|base)\b/i.test(q); }

async function handleAsk(){
  if(typingLocked) return;
  const qRaw = (promptEl.value || '').trim();
  if(!qRaw) return;
  promptEl.value = '';
  addBubble('user', escapeHtml(qRaw));
  session.push({role:'user', text:qRaw});
  updateSessionUI();

  setTypingLocked(true);
  const aiNode = addBubble('ai', '<span class="small">Gomega is thinking…</span>');
  setThinkingText('Deciding strategy...');
  setProgress(6);

  try{
    // 1) algebra simplification attempt (symbolic)
    const alg = algebraSimplify(qRaw);
    if(alg && /[a-zA-Z]/.test(qRaw)){ // only if variables present and simplify succeeded
      setThinkingText('Simplifying algebra...');
      setProgress(28);
      await typeTextInto(aiNode, alg, MODELS[currentModelKey].speed * 1.4);
      session.push({role:'ai', text:alg});
      updateSessionUI();
      confidenceEl.textContent = '99%';
      lastFetchEl.textContent = new Date().toLocaleString();
      setProgress(100);
      setThinkingText('Idle');
      setTimeout(()=>{ setProgress(0); setTypingLocked(false); }, 600);
      return;
    }

    // 2) geometry/math local compute
    const geom = tryGeometryQuery(qRaw);
    if(geom && (currentModelKey === 'math' || looksLikeMath(qRaw))){
      setThinkingText('Computing geometry/math locally...');
      setProgress(28);
      await typeTextInto(aiNode, String(geom.result), MODELS[currentModelKey].speed * 1.4);
      const meta = document.createElement('div'); meta.className='explain'; meta.textContent = `Reason: ${geom.explain}`;
      aiNode.appendChild(meta);
      session.push({role:'ai', text:String(geom.result)});
      updateSessionUI();
      confidenceEl.textContent = '99%';
      lastFetchEl.textContent = new Date().toLocaleString();
      setProgress(100);
      setThinkingText('Idle');
      setTimeout(()=>{ setProgress(0); setTypingLocked(false); }, 700);
      return;
    }

    // 3) numeric evaluation attempt using math.js for pure numeric expressions
    const numeric = numericEval(qRaw);
    if(numeric !== null && currentModelKey === 'math'){
      setThinkingText('Evaluating expression...');
      setProgress(28);
      await typeTextInto(aiNode, String(numeric), MODELS[currentModelKey].speed * 1.4);
      session.push({role:'ai', text:String(numeric)});
      updateSessionUI();
      confidenceEl.textContent = '99%';
      lastFetchEl.textContent = new Date().toLocaleString();
      setProgress(100);
      setThinkingText('Idle');
      setTimeout(()=>{ setProgress(0); setTypingLocked(false); }, 700);
      return;
    }

    // 4) If not solved locally, attempt multi-source gather
    setThinkingText('Searching multiple sources (client-side) ...');
    setProgress(14);
    const aggressive = thinkingToggle.checked || currentModelKey === 'v6';
    const snippets = await gatherSnippets(qRaw, 10, aggressive, (msg)=>{ lastAction.textContent = msg; const cur = parseInt(progressBar.style.width) || 10; setProgress(Math.min(90, cur + 8)); });

    if(!snippets || snippets.length === 0){
      // final fallback
      await typeTextInto(aiNode, "I couldn't find an answer — I tried looking it up.", MODELS[currentModelKey].speed * 1.8);
      session.push({role:'ai', text:"I couldn't find an answer — I tried looking it up."});
      updateSessionUI();
      confidenceEl.textContent = '8%';
      setTypingLocked(false);
      setThinkingText('Idle');
      setProgress(0);
      return;
    }

    setProgress(86);
    const strict = strictToggle.checked;
    const picked = pickBest(snippets, qRaw, currentModelKey, strict);

    // If expression appears numeric, also compute a numeric verification to append (unless strict asked)
    const verification = numericEval(qRaw);
    let finalAnswer = picked.answer;
    if(verification !== null && !/\bonly the number\b/i.test(qRaw)) {
      finalAnswer += `\n\n(Computed: ${verification})`;
    }

    // If the user has sent images recently, mention them to the AI output in a simple way
    const sentImages = photos.filter(p=>p.sent).slice(-5);
    if(sentImages.length>0){
      finalAnswer += `\n\n(You provided ${sentImages.length} image(s) in this session.)`;
    }

    // Type final answer
    const speed = Math.max(10, Math.round(MODELS[currentModelKey].speed * 1.6));
    await typeTextInto(aiNode, finalAnswer, speed);

    // Append confidence
    const meta = document.createElement('div'); meta.className='explain'; meta.innerHTML = `Confidence: ${picked.confidence}%`;
    aiNode.appendChild(meta);

    session.push({role:'ai', text: finalAnswer});
    updateSessionUI();
    lastFetchEl.textContent = new Date().toLocaleString();
    confidenceEl.textContent = picked.confidence + '%';
    setProgress(100);
    setThinkingText('Idle');
    setTimeout(()=>{ setProgress(0); setTypingLocked(false); }, 700);

  } catch(err){
    console.error(err);
    aiNode.innerHTML = '⚠️ Error: failed to compute';
    session.push({role:'ai', text:'Error: failed to compute'});
    updateSessionUI();
    setTypingLocked(false);
    setThinkingText('Idle');
    setProgress(0);
  }
}

// ---------- photo quota init ----------
function initQuota(){
  const used = localStorage.getItem(quotaKeyForToday());
  if(used === null) localStorage.setItem(quotaKeyForToday(),'0');
  updateQuotaUI();
}
function quotaKeyForToday(){
  const d = new Date(); const y = d.getFullYear(), m = (d.getMonth()+1).toString().padStart(2,'0'), day = d.getDate().toString().padStart(2,'0');
  return `gomega_photo_quota_${y}${m}${day}`;
}
function getQuotaUsed(){ return parseInt(localStorage.getItem(quotaKeyForToday()) || '0', 10); }
function incrementQuota(){ const k = quotaKeyForToday(); const u = getQuotaUsed()+1; localStorage.setItem(k, String(u)); updateQuotaUI(); return u; }
function updateQuotaUI(){ const used = getQuotaUsed(); photoQuotaEl.textContent = Math.max(0, DAILY_QUOTA - used); }
const DAILY_QUOTA = 5;

// ---------- init UI behaviors ----------
addPhotoBtn.addEventListener('click', ()=>{
  const f = photoInput.files && photoInput.files[0];
  if(!f){ alert('Please choose an image to add.'); return; }
  if(!/^image\//.test(f.type)){ alert('Only image files allowed.'); return; }
  const reader = new FileReader();
  reader.onload = (ev) => {
    const id = 'p' + Date.now();
    photos.push({id, name: f.name, url: ev.target.result, sent:false});
    renderPhotos();
  };
  reader.readAsDataURL(f);
});
function renderPhotos(){
  photoGrid.innerHTML = '';
  photos.forEach(p=>{
    const card = document.createElement('div'); card.className='photoCard';
    const img = document.createElement('img'); img.src = p.url; img.alt = p.name;
    card.appendChild(img);
    const actions = document.createElement('div'); actions.className='photoActions';
    const sendBtn = document.createElement('button'); sendBtn.className='ghost'; sendBtn.textContent = p.sent ? 'Sent' : 'Send';
    sendBtn.onclick = () => {
      if(p.sent){ alert('Already sent'); return; }
      if(getQuotaUsed() >= DAILY_QUOTA){ alert('Daily photo send limit reached (5). Try again tomorrow.'); return; }
      addImageToChatAsUser(p);
      p.sent = true; incrementQuota(); renderPhotos();
    };
    const removeBtn = document.createElement('button'); removeBtn.className='ghost'; removeBtn.textContent='Remove';
    removeBtn.onclick = ()=>{ photos = photos.filter(x=>x.id !== p.id); renderPhotos(); };
    actions.appendChild(sendBtn); actions.appendChild(removeBtn);
    card.appendChild(actions);
    photoGrid.appendChild(card);
  });
}

// add image to chat as a user-sent message
function addImageToChatAsUser(photo){
  const html = `<div style="font-size:13px;color:var(--muted);margin-bottom:6px">Image: ${escapeHtml(photo.name)}</div><img src="${photo.url}" style="max-width:320px;width:100%;border-radius:8px" alt="${escapeHtml(photo.name)}">`;
  addBubble('user', html);
  session.push({role:'user', text:`[image:${photo.name}]`, img:photo});
  updateSessionUI();
}

// clear session button
clearSessionBtn.addEventListener('click', ()=>{ session=[]; photos=[]; messagesEl.innerHTML=''; photoGrid.innerHTML=''; updateSessionUI(); localStorage.removeItem(quotaKeyForToday()); updateQuotaUI(); });

// ---------- initial welcome & clock ----------
(function init(){
  addBubble('ai','Hello — I am Gomega AI (client-only). I can simplify algebra, compute geometry, and look things up. Photos: you can add photos and send up to 5 per day while BETA is active.');
  addBubble('ai','Try: "Simplify 4a-2(5a-7)" or "Area of circle radius 5" or "12*(45-5)/3".');
  updateSessionUI();
  initQuota();
  tickLocalTime();
})();

function tickLocalTime(){ document.getElementById('localTime').textContent = new Date().toLocaleString(); setTimeout(tickLocalTime,1000); }

</script>
</body>
</html>