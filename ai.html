<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gomega AI</title>
  <style>
    :root{
      --bg1:#071021; --bg2:#0b1220; --card:#0f1724;
      --accent:#34d3ff; --accent2:#7c3aed; --muted:#94a3b8;
      --user:#0b6b4c; --ai:#081029;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background: radial-gradient(800px 400px at 10% 10%, rgba(56,189,248,0.04), transparent),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      color:#e6eef6; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:18px;
    }
    header{ width:100%; max-width:1200px; display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{ width:56px; height:56px; border-radius:12px; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; transform:rotate(-8deg); box-shadow:0 10px 30px rgba(0,0,0,0.4)}
    .logo b{ color:#062; font-size:20px; }
    h1{ margin:0; font-size:20px; color: #e6fbff; text-shadow:0 6px 22px rgba(0,0,0,0.6) }
    .meta{ color:var(--muted); font-size:13px }

    .top-row{ width:100%; max-width:1200px; display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    .controls{ display:flex; gap:12px; align-items:center; background:var(--glass); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.03) }

    select, input[type="text"], input[type="number"], button, textarea{
      background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px 10px; border-radius:8px; outline:none; font-size:14px;
    }

    .container{ width:100%; max-width:1200px; display:grid; grid-template-columns: 1fr 380px; gap:18px; align-items:start; }
    .chat-area{ background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); padding:18px; border-radius:14px; min-height:600px; max-height:78vh; overflow:auto; border:1px solid rgba(255,255,255,0.02) }
    .messages{ display:flex; flex-direction:column; gap:12px }

    .bubble{ max-width:82%; padding:12px 14px; border-radius:12px; line-height:1.4; position:relative; animation: slideUp .28s ease }
    .bubble.user{ background: linear-gradient(90deg,#0b6b4c,#064e3b); color:#d7fff0; align-self:flex-end; border-bottom-right-radius:6px; }
    .bubble.ai{ background: linear-gradient(90deg,#0b1020,#151827); color:#e6eef6; align-self:flex-start; border-bottom-left-radius:6px; }

    @keyframes slideUp { from{ opacity:0; transform:translateY(8px) } to{ opacity:1; transform:none } }

    .caret{ display:inline-block; width:2px; height:1em; background:var(--accent); margin-left:6px; vertical-align:bottom; animation: blinkCaret 1s steps(2,end) infinite; }
    @keyframes blinkCaret { 50%{ opacity:0 } }

    .controls-bottom{ display:flex; gap:10px; align-items:center; margin-top:12px }
    .prompt-input{ flex:1; padding:12px; border-radius:10px; background:transparent; color:#e6eef6; border:1px solid rgba(255,255,255,0.03); font-size:15px }

    .ask-btn{ padding:12px 18px; border-radius:10px; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#062; font-weight:700; border:none; cursor:pointer }
    .ask-btn:active{ transform:translateY(1px) }

    .right{ padding:18px; border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border:1px solid rgba(255,255,255,0.02); min-height:600px; display:flex; flex-direction:column; gap:12px }
    .card{ padding:12px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.02); }

    .model-list{ display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto; padding-right:6px }
    .model-item{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); }
    .small{ font-size:13px; color:var(--muted) }

    .image-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:8px }
    .image-card{ border-radius:8px; overflow:hidden; background:#000; position:relative; display:flex; align-items:center; justify-content:center; min-height:120px }
    .image-card img{ width:100%; height:100%; object-fit:cover; display:block }

    .download-btn{ position:absolute; right:8px; bottom:8px; background:rgba(0,0,0,0.5); color:#fff; padding:6px 8px; border-radius:6px; font-size:13px; text-decoration:none }

    .footer{ text-align:center; color:var(--muted); font-size:13px; margin-top:6px }

    .source-link{ color:var(--accent); text-decoration:none; font-size:13px; margin-left:8px }

    /* animations */
    .fadeIn{ animation: fadeIn 0.4s ease forwards }
    @keyframes fadeIn { from{ opacity:0; transform:translateY(8px) } to{ opacity:1; transform:none } }

    @media (max-width:1000px){ .container{ grid-template-columns: 1fr } .right{ order:2 } .chat-area{ order:1 } }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo"><b>G</b></div>
      <div>
        <h1>Gomega AI</h1>
        <div class="meta">Multi-source answers • Inline image generator (BETA) • Session memory</div>
      </div>
    </div>
    <div style="text-align:right">
      <div class="meta">Local time: <span id="localTime">—</span></div>
      <div style="height:6px"></div>
      <div class="meta">Last fetch: <span id="lastFetch">—</span></div>
    </div>
  </header>

  <div class="top-row">
    <div class="controls" style="flex:1">
      <label class="small" style="margin-right:8px">Model</label>
      <select id="modelPicker" title="Choose model" style="min-width:220px">
        <option value="v7">Gomega V7 — Balanced & up-to-date</option>
        <option value="v7mini">Gomega V7-mini — Fast short answers</option>
        <option value="v7image">Gomega V7-image (BETA) — Image creator</option>
        <option value="v6">Gomega V6 — Researcher</option>
        <option value="v5">Gomega V5 — Stable</option>
        <option value="math">MathMaster — Calculations</option>
        <option value="browsing">Browsing — Aggressive lookup</option>
      </select>

      <label class="small" style="margin-left:12px">Sources</label>
      <select id="sourceCount" style="min-width:80px">
        <option value="2">2</option><option value="3" selected>3</option><option value="4">4</option>
      </select>

      <label class="small" style="margin-left:12px">Google CSE (optional)</label>
      <input id="googleKey" placeholder="API Key (optional)" style="width:180px" />
      <input id="googleCx" placeholder="CSE ID (optional)" style="width:140px" />
      <button id="applyKeys" style="margin-left:8px;padding:8px 10px">Apply</button>
    </div>
  </div>

  <div class="container">
    <div class="chat-area">
      <div class="messages" id="messages"></div>

      <div class="controls-bottom">
        <input id="prompt" class="prompt-input" placeholder="Ask a question or 'generate: cyberpunk city at night' for images" />
        <button class="ask-btn" id="askBtn">Ask</button>
      </div>
      <div style="height:6px"></div>
      <div class="footer small">Tip: add "only the year" or "only the number" in your question for strict outputs.</div>
    </div>

    <aside class="right">
      <div class="card">
        <h3>Active Model</h3>
        <div id="modelStats" class="small">—</div>
      </div>

      <div class="card">
        <h3>Session Memory</h3>
        <div id="sessionList" class="small">No messages yet.</div>
        <button id="clearSession" style="margin-top:8px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer">Clear Session</button>
      </div>

      <div class="card">
        <h3>Image Generator (BETA)</h3>
        <div class="small">When you select <strong>Gomega V7-image (BETA)</strong> or prefix with <code>generate:</code>, Gomega will attempt to create images from the prompt. Currently uses Unsplash/lexica fallbacks — real generative APIs require keys.</div>
      </div>

      <div class="card">
        <h3>Sources & Tools</h3>
        <div class="small">Gomega uses Wikipedia & DuckDuckGo by default. Paste Google API Key + CSE ID above to enable Google Overview results (optional). For generation we use Unsplash or Lexica as a BETA placeholder.</div>
      </div>

    </aside>
  </div>

  <script>
    /******************************
     * Gomega AI — Client-side app
     * Runs fully in the browser.
     * - Multi-source lookup (Wikipedia, DuckDuckGo)
     * - Optional Google CSE if user provides API Key + CX
     * - Inline image "generator" (BETA) using Unsplash / Lexica fallback
     * - Multiple model profiles with typing & behavior
     ******************************/

    // ----- state -----
    const messagesEl = document.getElementById('messages');
    const modelPicker = document.getElementById('modelPicker');
    const sourceCountEl = document.getElementById('sourceCount');
    const promptEl = document.getElementById('prompt');
    const askBtn = document.getElementById('askBtn');
    const sessionListEl = document.getElementById('sessionList');
    const modelStatsEl = document.getElementById('modelStats');
    const lastFetchEl = document.getElementById('lastFetch');
    const googleKeyInput = document.getElementById('googleKey');
    const googleCxInput = document.getElementById('googleCx');
    const applyKeysBtn = document.getElementById('applyKeys');

    let session = []; // array of {role, text, model}
    let GOOGLE_API_KEY = '';
    let GOOGLE_CX = '';

    // model profiles
    const MODELS = {
      v7: {label:'Gomega V7', speed:70, verb:1.0, sources:3, desc:'Balanced & up-to-date'},
      v7mini: {label:'Gomega V7-mini', speed:22, verb:0.5, sources:2, desc:'Fast, concise'},
      v7image: {label:'Gomega V7-image (BETA)', speed:60, verb:0.5, sources:1, desc:'Image creator (BETA)'},
      v6: {label:'Gomega V6', speed:85, verb:1.6, sources:4, desc:'Researcher — verbose'},
      v5: {label:'Gomega V5', speed:64, verb:1.0, sources:3, desc:'Stable & precise'},
      math: {label:'MathMaster', speed:38, verb:0.2, sources:1, desc:'Calculation specialist'},
      browsing: {label:'Browsing', speed:72, verb:1.1, sources:4, desc:'Aggressive lookup'}
    };

    function renderModelStats(){
      const key = modelPicker.value;
      const m = MODELS[key];
      modelStatsEl.innerHTML = `<div><strong>${m.label}</strong> — ${m.desc}</div>
        <div style="margin-top:6px" class="small">Typing: ${m.speed}ms · Verbosity: ${m.verb} · Preferred sources: ${m.sources}</div>`;
    }
    renderModelStats();
    modelPicker.addEventListener('change', renderModelStats);

    applyKeysBtn.addEventListener('click', () => {
      GOOGLE_API_KEY = googleKeyInput.value.trim();
      GOOGLE_CX = googleCxInput.value.trim();
      alert('Google keys updated. If provided correctly, Gomega will use Google Overview results.');
    });

    // update local time
    const localTimeEl = document.getElementById('localTime');
    function tick(){
      localTimeEl.textContent = new Date().toLocaleString();
      setTimeout(tick, 1000);
    }
    tick();

    // helpers
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function addBubble(role, text, extraHTML){
      const el = document.createElement('div');
      el.className = 'bubble ' + (role==='user' ? 'user' : 'ai');
      el.innerHTML = escapeHtml(text).replace(/\n/g,'<br>') + (extraHTML ? extraHTML : '');
      messagesEl.appendChild(el);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return el;
    }

    function addAIBubbleTypingArea(){
      const el = document.createElement('div');
      el.className = 'bubble ai';
      el.innerHTML = `<div class="typingArea"></div><span class="caret"></span>`;
      messagesEl.appendChild(el);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return el.querySelector('.typingArea');
    }

    // typing with randomness & pauses at punctuation to feel human
    async function humanType(el, text, baseSpeed){
      el.innerHTML = '';
      const punctuationPause = 300;
      for(let i=0;i<text.length;i++){
        const ch = text[i];
        el.innerHTML = escapeHtml(text.slice(0, i+1));
        messagesEl.scrollTop = messagesEl.scrollHeight;
        // randomize speed a bit and slow down on punctuation
        const variability = Math.random()*0.5 + 0.75; // 0.75..1.25
        let delay = Math.max(8, Math.round(baseSpeed * variability));
        if(/[,;:]/.test(ch)) delay += punctuationPause*0.25;
        if(/[.!?]/.test(ch)) delay += punctuationPause;
        await new Promise(r => setTimeout(r, delay));
      }
    }

    // ---------- Data sources ----------
    async function fetchWikiSummary(q){
      try{
        const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(q)}`, {mode:'cors'});
        if(!r.ok) return null;
        const j = await r.json();
        return {source:'Wikipedia', title:j.title||q, text:j.extract||'', url: (j.content_urls && j.content_urls.desktop) ? j.content_urls.desktop.page : `https://en.wikipedia.org/wiki/${encodeURIComponent(q)}`};
      }catch(e){ return null; }
    }

    async function fetchWikiSearch(q, limit=3){
      try{
        const r = await fetch(`https://en.wikipedia.org/w/api.php?action=query&format=json&list=search&srsearch=${encodeURIComponent(q)}&srlimit=${limit}&origin=*`);
        if(!r.ok) return [];
        const j = await r.json();
        const hits = j.query?.search || [];
        const results = [];
        for(const h of hits){
          const s = await fetchWikiSummary(h.title);
          if(s) results.push(s);
        }
        return results;
      }catch(e){ return []; }
    }

    async function fetchDDG(q){
      try{
        const r = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(q)}&format=json&no_html=1&skip_disambig=1`);
        if(!r.ok) return null;
        const j = await r.json();
        let text = j.Abstract || (j.RelatedTopics ? j.RelatedTopics.map(t => t.Text).join('. ') : '');
        let url = j.AbstractURL || '';
        return {source:'DuckDuckGo', title:j.Heading||q, text:text, url:url};
      }catch(e){ return null; }
    }

    // Optional: Google Custom Search (requires key + cx) - user must paste keys in UI
    async function fetchGoogleOverview(q){
      if(!GOOGLE_API_KEY || !GOOGLE_CX) return null;
      try{
        const r = await fetch(`https://www.googleapis.com/customsearch/v1?key=${encodeURIComponent(GOOGLE_API_KEY)}&cx=${encodeURIComponent(GOOGLE_CX)}&q=${encodeURIComponent(q)}&num=1`);
        if(!r.ok) return null;
        const j = await r.json();
        const item = j.items && j.items[0];
        if(!item) return null;
        const snippet = item.snippet || '';
        return {source:'Google', title:item.title||q, text:snippet, url:item.link || ''};
      }catch(e){ return null; }
    }

    // Image generation (BETA): attempt Lexica -> Unsplash fallback
    async function generateImages(prompt, count=2){
      // 1) Try Lexica API (public search) as a generator placeholder
      try{
        const lexicaUrl = `https://lexica.art/api/v1/search?q=${encodeURIComponent(prompt)}`;
        const r = await fetch(lexicaUrl);
        if(r.ok){
          const j = await r.json();
          if(j.images && j.images.length>0){
            return j.images.slice(0, count).map(img => ({src: img.src, prompt: img.prompt || prompt}));
          }
        }
      }catch(e){ /* ignore */ }

      // 2) Unsplash Source fallback (not generative but search-like)
      try{
        const imgs = [];
        for(let i=0;i<count;i++){
          // use unsplash source to get a photo by query - this returns a redirect to an image
          const url = `https://source.unsplash.com/collection/190727/800x600?${encodeURIComponent(prompt)}&sig=${Date.now()+i}`;
          imgs.push({src: url, prompt});
        }
        return imgs;
      }catch(e){ /* ignore */ }

      return [];
    }

    // ---------- Smart helpers ----------
    function extractYear(text){
      if(!text) return null;
      const m = text.match(/\b(17\d{2}|18\d{2}|19\d{2}|20\d{2}|2100)\b/g);
      if(!m) return null;
      const freq = {};
      for(const y of m) freq[y] = (freq[y]||0)+1;
      return Object.keys(freq).sort((a,b)=>freq[b]-freq[a])[0];
    }

    // safe math - allow numbers, whitespace, + - * / ( ) . ^ % only
    function safeEvalMath(expr){
      if(!expr || expr.length>200) return null;
      let s = expr.replace(/×/g,'*').replace(/÷/g,'/').replace(/—/g,'-');
      s = s.replace(/\bplus\b/g,'+').replace(/\bminus\b/g,'-').replace(/\btimes\b/g,'*').replace(/\bdivided by\b/g,'/');
      // allow only safe chars
      if(!/^[0-9+\-*/().\s%^]+$/.test(s)) return null;
      s = s.replace(/\^/g,'**');
      try{
        // eslint-disable-next-line no-new-func
        const v = Function(`"use strict"; return (${s});`)();
        if(typeof v === 'number' && Number.isFinite(v)) return v;
        return null;
      }catch(e){ return null; }
    }

    // gather sources based on query and desired count
    async function gather(query, desired=3, aggressive=false){
      const out = [];
      // 1) Wikipedia direct
      const wiki = await fetchWikiSummary(query);
      if(wiki) out.push(wiki);
      // 2) DuckDuckGo
      const ddg = await fetchDDG(query);
      if(ddg && ddg.text) out.push(ddg);
      // 3) Google overview if possible
      const google = await fetchGoogleOverview(query);
      if(google) out.push(google);
      // 4) wiki search results
      if(out.length < desired){
        const hits = await fetchWikiSearch(query, aggressive ? 5 : 3);
        for(const h of hits){
          if(out.length >= desired) break;
          if(!out.find(o => o.title === h.title)) out.push(h);
        }
      }
      // dedupe & filter
      const dedup = [];
      const seen = new Set();
      for(const r of out){
        const key = (r.title||'') + '|' + (r.source||'');
        if(!seen.has(key) && r.text && r.text.length>20){
          seen.add(key); dedup.push(r);
        }
      }
      return dedup.slice(0, desired);
    }

    // pick best answer from sources
    function pickAnswer(sources, query, modelKey){
      // detect year / when questions
      const wantsYear = /\bwhat\s+year|\bwhen\s+was|\bwhen\s+did/i.test(query);
      // detect math expression
      const mathValue = safeEvalMath(query);

      if(modelKey === 'math' && mathValue !== null) return {answer: String(mathValue), sources: []};
      if(mathValue !== null && modelKey !== 'v7image'){ // non-math models can still show computed value as extra
        // we'll return computed value appended as verification later
      }

      if(wantsYear){
        for(const s of sources){
          const y = extractYear(s.text);
          if(y) return {answer: y, sources: sources.map(s => ({title:s.title, url:s.url}))};
        }
      }

      // choose longest extract
      let best = sources[0];
      for(const s of sources) if((s.text||'').length > (best.text||'').length) best = s;
      let answer = (best && best.text) ? best.text.split(/(?<=\.)\s+/).slice(0, Math.max(1, Math.round(MODELS[modelKey].verb*1.5))).join(' ') : "I couldn't find an answer.";
      // small cleanup
      answer = answer.replace(/\s+/g,' ').trim();

      return {answer, sources: sources.map(s => ({title:s.title, url:s.url, src:s.source}))};
    }

    // compute simple corroboration
    function corroborationText(sources){
      if(!sources || sources.length <= 1) return 'Limited corroboration';
      // look for common year matches
      const years = {};
      for(const s of sources){
        const y = extractYear(s.title + ' ' + (s.text||''));
        if(y) years[y] = (years[y]||0)+1;
      }
      const keys = Object.keys(years);
      if(keys.length===0) return 'Multiple sources';
      const best = keys.sort((a,b)=>years[b]-years[a])[0];
      if(years[best] > 1) return `Corroborated: ${best}`;
      return 'Multiple sources (partial agreement)';
    }

    // ---------- UI actions ----------
    askBtn.addEventListener('click', handleAsk);
    promptEl.addEventListener('keydown', (e) => { if(e.key==='Enter' && !e.shiftKey){ handleAsk(); e.preventDefault(); }});

    document.getElementById('clearSession').addEventListener('click', () => { session = []; sessionListEl.innerText = 'No messages yet.'; messagesEl.innerHTML=''; });

    async function handleAsk(){
      const query = promptEl.value.trim();
      if(!query) return;
      const modelKey = modelPicker.value;
      const desiredSources = parseInt(sourceCountEl.value || MODELS[modelKey].sources, 10);
      // show user bubble
      addBubble('user', query);
      session.push({role:'user', text: query, model:modelKey});
      updateSessionUI();

      // If model is image or query starts with "generate:" treat as image generation
      let isGen = false;
      let genPrompt = '';
      if(modelKey === 'v7image' || /^generate[:\s]/i.test(query)){
        isGen = true;
        genPrompt = (modelKey==='v7image') ? query : query.replace(/^generate[:\s]+/i, '');
      }

      if(isGen){
        // show an AI bubble placeholder with typing
        const typingArea = addAIBubbleTypingArea();
        const baseSpeed = MODELS[modelKey].speed * 1.5;
        await humanType(typingArea, 'Generating images… (BETA)', Math.max(14, Math.round(baseSpeed*0.6)));
        // run image generation fallback
        const imgs = await generateImages(genPrompt, 4);
        // replace bubble content with images
        const imgContainer = document.createElement('div');
        imgContainer.style.display = 'grid';
        imgContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
        imgContainer.style.gap = '8px';
        for(const img of imgs){
          const card = document.createElement('div'); card.className = 'image-card';
          const imageEl = document.createElement('img');
          imageEl.src = img.src;
          imageEl.alt = img.prompt || genPrompt;
          card.appendChild(imageEl);

          // download button fetches image as blob, creates downloadable link
          const dl = document.createElement('a');
          dl.className = 'download-btn';
          dl.textContent = 'Download';
          dl.href = img.src;
          // use download attribute where possible; for cross-origin images this may not always work, but we still provide link
          dl.setAttribute('download', 'gomega-image.jpg');
          card.appendChild(dl);

          imgContainer.appendChild(card);
        }
        // append to last bubble
        const lastBubble = messagesEl.lastElementChild;
        if(lastBubble) lastBubble.innerHTML = ''; // clear typing
        const wrapper = document.createElement('div');
        wrapper.appendChild(imgContainer);
        if(lastBubble) lastBubble.appendChild(wrapper);
        lastFetchEl.textContent = new Date().toLocaleString();
        session.push({role:'ai', text: `Generated ${imgs.length} images for "${genPrompt}"`, model:modelKey});
        updateSessionUI();
        return;
      }

      // non-image flow: prepare typing area
      const typingArea = addAIBubbleTypingArea();

      // show interim text while fetching
      await humanType(typingArea, 'Searching multiple sources…', 40);

      // perform multi-source gather
      lastFetchEl.textContent = 'fetching...';
      let sources = [];
      try{
        sources = await gather(query, desiredSources, modelKey === 'browsing' || modelKey === 'v6' || modelKey === 'v7');
      }catch(e){ console.warn(e); }

      // if still empty and model is aggressive, try again
      if(sources.length === 0 && (modelKey === 'browsing' || modelKey === 'v6')){
        try{ sources = await gather(query, desiredSources, true); } catch(e){ }
      }

      // pick answer
      const picked = pickAnswer(sources, query, modelKey);
      let final = picked.answer || "I couldn't find an answer.";
      // append computed math if present and user didn't ask for strict only-number
      const mathVal = safeEvalMath(query);
      const wantsStrictNumber = /\bonly the year\b|\bonly the number\b|\bjust the year\b/i.test(query);
      if(mathVal !== null && !wantsStrictNumber && modelKey !== 'math'){
        final = final + `\n\n(Computed: ${mathVal})`;
      }
      // for v7mini keep it short
      if(modelKey === 'v7mini') final = final.split(/(?<=\.)\s+/)[0] || final;

      // clear typing area and type nicely (slow, human-like)
      const slowFactor = 1.6; // make slower as requested
      const speed = Math.max(12, Math.round(MODELS[modelKey].speed * slowFactor));
      // clear typingArea before final typing
      typingArea.innerHTML = '';
      await humanType(typingArea, final, speed);

      // append sources & corroboration
      const meta = document.createElement('div');
      meta.style.marginTop = '8px';
      meta.style.fontSize = '13px';
      meta.style.color = 'var(--muted)';
      if(picked.sources && picked.sources.length>0){
        meta.innerHTML = `Sources: ${picked.sources.map(s => `<a class="source-link" href="${s.url||'#'}" target="_blank" rel="noopener">${escapeHtml(s.title||s.src||'source')}</a>`).join(', ')} • ${corroborationText(picked.sources)}`;
      } else {
        meta.innerHTML = 'Sources: none found';
      }
      const lastBubble = messagesEl.lastElementChild;
      if(lastBubble) lastBubble.appendChild(meta);

      session.push({role:'ai', text: final, model:modelKey});
      updateSessionUI();
      lastFetchEl.textContent = new Date().toLocaleString();
    }

    function updateSessionUI(){
      if(session.length===0){ sessionListEl.innerText = 'No messages yet.'; return; }
      sessionListEl.innerHTML = session.slice(-6).map(m => `<div style="margin-bottom:6px"><strong style="color:${m.role==='user' ? '#9ae6b4' : '#93c5fd'}">${escapeHtml(m.role)}</strong>: <span style="color:#cbd5e1">${escapeHtml(m.text).slice(0,140)}</span></div>`).join('');
    }

    // ---------- image download helper (for cross-origin fallback, we use direct link; user can right-click) ----------
    // Note: attempting to fetch images to create same-origin blob may fail due to CORS. We provide direct link + download attribute; browser behavior may vary.

    // ----- initial welcome -----
    (function init(){
      addBubble('ai', 'Hello — I am Gomega AI. I can search multiple sources, do safe math, and (BETA) generate images inline. Paste Google API Key + CSE ID to enable Google Overview results.');
      addBubble('ai', 'Try: "What year was Nokia released in North America?" or "generate: neon city at night".');
    })();

  </script>
</body>
</html>