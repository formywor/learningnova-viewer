<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gomega AI</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  /* ---------- Visuals ---------- */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
  :root{
    --bg1:#071021; --bg2:#0b1220; --card:#0f1724;
    --accent:#34d3ff; --accent2:#7c3aed; --muted:#94a3b8;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; color:#e6eef6;
    background: radial-gradient(900px 400px at 10% 10%, rgba(56,189,248,0.03), transparent),
                linear-gradient(180deg,var(--bg1),var(--bg2));
    -webkit-font-smoothing:antialiased; display:flex; justify-content:center; padding:20px;
  }

  .wrap { width:100%; max-width:1150px; display:grid; grid-template-columns: 1fr 380px; gap:18px; align-items:start; }

  /* Chat area */
  .chat {
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
    padding:18px; border-radius:14px; min-height:640px; max-height:88vh; display:flex; flex-direction:column;
    border:1px solid rgba(255,255,255,0.02); overflow:hidden;
  }
  .top {
    display:flex; align-items:center; gap:12px; margin-bottom:8px;
  }
  .logo { width:56px; height:56px; border-radius:12px; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; transform:rotate(-8deg); box-shadow:0 10px 30px rgba(0,0,0,0.4) }
  .logo b{ color:#062; font-size:20px }
  .title { font-size:18px; margin:0 }
  .subtitle { color:var(--muted); font-size:13px; margin-top:4px; }

  .messages { flex:1; overflow:auto; padding-right:10px; display:flex; flex-direction:column; gap:12px; transition: all 160ms ease; }
  .bubble { max-width:82%; padding:12px 14px; border-radius:12px; line-height:1.45; position:relative; animation: slideUp .28s ease; box-shadow: 0 8px 30px rgba(2,6,23,0.4) }
  .bubble.user { background: linear-gradient(90deg,#0b6b4c,#064e3b); color:#d7fff0; align-self:flex-end; border-bottom-right-radius:6px; transform-origin:100% 50%; }
  .bubble.ai { background: linear-gradient(90deg,#0b1020,#151827); color:#e6eef6; align-self:flex-start; border-bottom-left-radius:6px; transform-origin:0% 50%; }
  @keyframes slideUp { from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none} }

  .controls { display:flex; gap:10px; align-items:center; margin-top:12px; }
  .prompt { flex:1; padding:12px; border-radius:10px; background:transparent; color:#e6eef6; border:1px solid rgba(255,255,255,0.03); outline:none; font-size:15px; transition: box-shadow .18s; }
  .prompt:focus { box-shadow: 0 6px 30px rgba(52,211,255,0.06); }
  .btn { padding:12px 18px; border-radius:10px; border:none; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#062; cursor:pointer; font-weight:700 }
  .ghost { padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--muted); cursor:pointer }

  .infoRow { display:flex; gap:10px; align-items:center; margin-top:8px; color:var(--muted); font-size:13px; }

  /* Sidebar */
  .sidebar { padding:18px; border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border:1px solid rgba(255,255,255,0.02); min-height:640px; display:flex; flex-direction:column; gap:12px; }
  .card { padding:12px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.02); }
  .models { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
  .model { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); cursor:pointer; border:1px solid rgba(255,255,255,0.02); }
  .model.selected { background: linear-gradient(90deg,var(--accent),var(--accent2)); color:#022; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }

  .progress { height:8px; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; width:100% }
  .bar { height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent2)); transition:width 180ms linear }

  .photoGrid { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  .photoCard { width:86px; height:66px; border-radius:6px; overflow:hidden; background:#000; display:flex; align-items:center; justify-content:center; position:relative; border:1px solid rgba(255,255,255,0.02) }
  .photoCard img { width:100%; height:100%; object-fit:cover }
  .photoActions { position:absolute; bottom:6px; left:6px; right:6px; display:flex; gap:6px; justify-content:center }

  .explain { margin-top:8px; font-size:13px; color:var(--muted); border-top:1px dashed rgba(255,255,255,0.03); padding-top:8px }

  .typing { display:inline-flex; gap:6px; align-items:center; margin-left:8px; }
  .dot { width:8px; height:8px; background:#9fb0c8; border-radius:50%; opacity:.9; animation: jump 1s infinite; }
  .dot:nth-child(2){ animation-delay:0.15s } .dot:nth-child(3){ animation-delay:0.3s }
  @keyframes jump { 0%{transform:translateY(0);opacity:0.6} 50%{transform:translateY(-6px);opacity:1} 100%{transform:translateY(0);opacity:0.6} }

  .small { font-size:13px; color:var(--muted) }

  @media (max-width:980px){ .wrap{ grid-template-columns:1fr } .sidebar{ order:2 } .chat{ order:1 } }
</style>
</head>
<body>
  <div class="wrap">
    <!-- CHAT -->
    <div class="chat" role="main" aria-label="Gomega AI chat">
      <div class="top">
        <div class="logo"><b>G</b></div>
        <div>
          <div class="title">Gomega AI</div>
          <div class="subtitle">Fast, focused answers — math & lookups. Photo BETA (5/day free)</div>
        </div>
        <div style="margin-left:auto; text-align:right;">
          <div class="small">Local: <span id="localTime">—</span></div>
          <div class="small">Last: <span id="lastFetch">—</span></div>
        </div>
      </div>

      <div id="warning" class="small" style="background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-bottom:10px;color:var(--muted)">
        Note: The page will attempt to use your API key if available. Do not expose a long-lived secret on public machines. Use a server proxy for production.
      </div>

      <div class="messages" id="messages" aria-live="polite"></div>

      <div class="controls">
        <input id="prompt" class="prompt" placeholder="Ask / math (e.g. 'Simplify 4a-2(5a-7)')"/>
        <select id="modelSelect" title="Choose model" style="border-radius:10px;padding:8px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.03)">
          <!-- filled by JS -->
        </select>
        <button id="askBtn" class="btn">Ask</button>
        <button id="setKeyBtn" class="ghost">Set Key</button>
      </div>

      <div class="infoRow">
        <div><label class="small">Thinking</label> <input type="checkbox" id="thinkingToggle"/></div>
        <div><label class="small">Strict</label> <input type="checkbox" id="strictToggle"/></div>
        <div style="margin-left:auto"><button id="clearBtn" class="ghost">Clear UI</button></div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="sidebar">
      <div class="card">
        <strong>Models</strong>
        <div class="small">Gomega profiles — pick a behavior. Premium models are marked.</div>
        <div class="models" id="modelList"></div>
      </div>

      <div class="card">
        <strong>Progress & session</strong>
        <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
          <div class="small">Status:</div><div id="thinkingBadge" class="small">Idle</div>
        </div>
        <div style="margin-top:8px" class="progress"><div id="progressBar" class="bar"></div></div>
        <div style="margin-top:8px" class="small">Confidence: <span id="confidence">—</span></div>
        <div class="explain" id="lastAction">No action yet.</div>
      </div>

      <div class="card">
        <strong>Photos (BETA)</strong>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <input type="file" id="photoInput" accept="image/*" style="flex:1">
          <button id="addPhotoBtn" class="ghost">Add</button>
        </div>
        <div style="margin-top:8px" class="small">Daily sends left: <span id="photoQuota">5</span>/5</div>
        <div class="photoGrid" id="photoGrid"></div>
        <div class="small" style="margin-top:8px">Photos are local and downloadable. Premium users: unlimited.</div>
      </div>

      <div class="card">
        <strong>Session memory</strong>
        <div id="sessionList" class="small" style="margin-top:8px">No messages yet.</div>
        <div style="margin-top:8px"><button id="clearSession" class="ghost">Clear Memory</button></div>
      </div>
    </aside>
  </div>

<script>
/* ----------------------------
   Gomega AI — updated script
   - safer model fallback to avoid invalid model id errors
   - improved UI behavior, typing lock, premium gating
   - image upload + inline download
   - local math & geometry engine
   - uses API key from window.OpenAPI OR /browser/api.txt OR sessionStorage
-----------------------------*/

/* ---------- Config & state ---------- */
const DAILY_QUOTA = 5;
const NONPREMIUM_MSG_LIMIT = 40;

const MODEL_CONFIG = {
  'gomega-v8':  { label:'Gomega V8', openai:'gpt-4', speed:90, verb:1.6, premium:true },
  'gomega-v6':  { label:'Gomega V6', openai:'gpt-4', speed:88, verb:1.5, premium:true },
  'gomega-v7':  { label:'Gomega V7', openai:'gpt-3.5-turbo', speed:70, verb:1.0, premium:false },
  'gomega-v7mini': { label:'Gomega V7-mini', openai:'gpt-3.5-turbo', speed:28, verb:0.5, premium:false },
  'gomega-v5':  { label:'Gomega V5', openai:'gpt-3.5-turbo', speed:60, verb:1.0, premium:false },
  'mathmaster': { label:'MathMaster', openai:'gpt-3.5-turbo', speed:36, verb:0.2, premium:false }
};

let currentModelKey = 'gomega-v7';
let session = [];
let photos = []; // {id,name,url,sent}
let premiumUnlocked = false;
let premiumCodes = [];
let typingLocked = false;

/* ---------- DOM refs ---------- */
const messagesEl = document.getElementById('messages');
const promptEl = document.getElementById('prompt');
const askBtn = document.getElementById('askBtn');
const setKeyBtn = document.getElementById('setKeyBtn');
const modelSelect = document.getElementById('modelSelect');
const modelListEl = document.getElementById('modelList');
const thinkingToggle = document.getElementById('thinkingToggle');
const strictToggle = document.getElementById('strictToggle');
const thinkingBadge = document.getElementById('thinkingBadge');
const progressBar = document.getElementById('progressBar');
const lastAction = document.getElementById('lastAction');
const confidenceEl = document.getElementById('confidence');
const lastFetchEl = document.getElementById('lastFetch');
const photoInput = document.getElementById('photoInput');
const addPhotoBtn = document.getElementById('addPhotoBtn');
const photoGrid = document.getElementById('photoGrid');
const photoQuotaEl = document.getElementById('photoQuota');
const sessionListEl = document.getElementById('sessionList');
const clearSessionBtn = document.getElementById('clearSession');
const clearBtn = document.getElementById('clearBtn');

/* ---------- API key handling ---------- */
// Sources checked in order:
// 1) window.OpenAPI (you may inject it during your build process)
// 2) /browser/api.txt (optional file on same origin)
// 3) sessionStorage (when user pastes it via Set Key)
const STORAGE_KEY = 'gomega_openai_key';

function setOpenAIKey(k){
  if(!k){ sessionStorage.removeItem(STORAGE_KEY); return; }
  sessionStorage.setItem(STORAGE_KEY, k);
}
function getOpenAIKey(){
  if(window.OpenAPI) return window.OpenAPI;
  const s = sessionStorage.getItem(STORAGE_KEY); if(s) return s;
  return null;
}

async function tryLoadApiTxt(){
  try {
    const res = await fetch('/browser/api.txt', {cache:'no-cache'});
    if(!res.ok) return;
    const txt = (await res.text()).trim();
    if(txt) { sessionStorage.setItem(STORAGE_KEY, txt); console.log('Loaded API key from /browser/api.txt'); }
  } catch(e){
    // ignore
  }
}

// UI set key
setKeyBtn.addEventListener('click', ()=>{
  const prev = getOpenAIKey() || '';
  const k = prompt('Paste your OpenAI API key for this browser session (visible in this browser session). For production, use a secure server proxy.', prev);
  if(k) { setOpenAIKey(k.trim()); alert('API key stored for this browser session.'); }
});

/* ---------- Premium codes (silent load) ---------- */
async function loadPremiumCodes(){
  try {
    const res = await fetch('/browser/premiumcodes.txt', {cache:'no-cache'});
    if(!res.ok) return;
    const txt = await res.text();
    premiumCodes = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    console.log('Premium codes loaded:', premiumCodes.length);
  } catch(e){
    // ignore
  }
}
// apply code input
document.getElementById('applyCodeBtn')?.addEventListener('click', ()=>{
  const code = document.getElementById('premiumCodeInput').value.trim();
  if(!code) return alert('Enter code first');
  if(premiumCodes.includes(code) || code==='PREMIUM'){ premiumUnlocked = true; sessionStorage.setItem('gomega_premium','1'); alert('Premium unlocked for this session!'); renderModels(); updateQuotaUI(); }
  else alert('Invalid code or list not available.');
});

/* ---------- UI helpers ---------- */
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function addBubble(role, html){
  const el = document.createElement('div'); el.className = 'bubble ' + (role==='user' ? 'user' : 'ai'); el.innerHTML = html;
  messagesEl.appendChild(el); messagesEl.scrollTop = messagesEl.scrollHeight; return el;
}
function updateSessionUI(){ sessionListEl.innerHTML = session.slice(-6).map(m=>`<div class="small"><strong>${escapeHtml(m.role)}</strong>: ${escapeHtml(m.text).slice(0,140)}</div>`).join('') || 'No messages yet.'; }
function setProgress(p){ progressBar.style.width = Math.max(3, Math.min(100,p)) + '%'; }
function setThinkingText(t){ thinkingBadge.textContent = t; lastAction.textContent = t; }

/* lock/unlock typing */
function setTypingLocked(v){
  typingLocked = v;
  promptEl.disabled = v;
  askBtn.disabled = v;
  setKeyBtn.disabled = v;
  addPhotoBtn.disabled = v;
  photoInput.disabled = v;
  if(v){ promptEl.classList.add('disabled'); askBtn.classList.add('disabled'); } else { promptEl.classList.remove('disabled'); askBtn.classList.remove('disabled'); }
}

/* typing animation */
async function typeTextInto(node, text, speed){
  node.innerHTML = '';
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    node.innerHTML = escapeHtml(text.slice(0,i+1)).replace(/\n/g,'<br>');
    messagesEl.scrollTop = messagesEl.scrollHeight;
    const variability = 0.8 + Math.random()*0.6;
    let delay = Math.max(6, Math.round(speed * variability));
    if(/[,;]/.test(ch)) delay += 90;
    if(/[.!?]/.test(ch)) delay += 200;
    await new Promise(r=>setTimeout(r, delay));
  }
}

/* ---------- Algebra / geometry / numeric (unchanged engine) ---------- */
/* Tokenizer/Parser/Simplifier + evaluateNumeric + geometryQuery (kept same as earlier robust implementation) */

function tokenize(expr){
  const s = String(expr); const tokens=[]; const isNum = c=>/[0-9.]/.test(c); const isAlpha = c=>/[a-zA-Z]/.test(c);
  let i=0;
  while(i<s.length){
    const c=s[i];
    if(/\s/.test(c)){ i++; continue; }
    if(c==='+'||c==='-'||c==='*'||c==='/'||c==='^'||c==='('||c===')'){ tokens.push({type:c,val:c}); i++; continue; }
    if(isNum(c)){ let j=i; while(j<s.length && /[0-9.]/.test(s[j])) j++; tokens.push({type:'num', val:s.slice(i,j)}); i=j; continue; }
    if(isAlpha(c)){ let j=i; while(j<s.length && /[a-zA-Z0-9_]/.test(s[j])) j++; tokens.push({type:'id', val:s.slice(i,j)}); i=j; continue; }
    i++;
  }
  const out=[];
  for(let k=0;k<tokens.length;k++){
    out.push(tokens[k]);
    if(k+1<tokens.length){
      const a=tokens[k], b=tokens[k+1];
      const aok=(a.type==='num'||a.type==='id'||a.type===')'); const bok=(b.type==='id'||b.type==='num'||b.type==='(');
      if(aok && bok) out.push({type:'*',val:'*'});
    }
  }
  return out;
}
function makeTerm(coeff, vars){ return {coeff, vars:Object.assign({}, vars)}; }
function termKey(vars){ const keys=Object.keys(vars).filter(k=>vars[k]!==0).sort(); if(keys.length===0) return ''; return keys.map(k=>`${k}^${vars[k]}`).join('*'); }
function multiplyVars(a,b){ const r=Object.assign({}, a); for(const k in b) r[k]=(r[k]||0)+b[k]; for(const k in r) if(r[k]===0) delete r[k]; return r; }
function parseExpression(tokens){
  let pos=0;
  function peek(){ return tokens[pos]||null; }
  function consume(t){ const cur=tokens[pos]; if(!cur) return null; if(t && cur.type!==t) return null; pos++; return cur; }
  function parsePrimary(){
    const cur=peek(); if(!cur) return [{coeff:0, vars:{}}];
    if(cur.type==='num'){ consume('num'); return [makeTerm(Number(cur.val),{})]; }
    if(cur.type==='id'){ consume('id'); const v={}; v[cur.val]=1; return [makeTerm(1,v)]; }
    if(cur.type==='('){ consume('('); const expr=parseAddSub(); consume(')'); return expr; }
    consume(); return [{coeff:0,vars:{}}];
  }
  function parsePow(){
    let base=parsePrimary();
    while(peek() && peek().type==='^'){ consume('^'); const right=peek(); if(right && right.type==='num'){ const exp=Number(consume('num').val); let raised=[]; for(const t of base){ let seed=[makeTerm(1,{})]; for(let e=0;e<exp;e++) seed = multiplyTermLists(seed,[t]); for(const s of seed) raised.push(s);} base=raised; } else break; }
    return base;
  }
  function parseMulDiv(){
    let left=parsePow();
    while(peek() && (peek().type==='*' || peek().type==='/')){ const op=consume().type; const right=parsePow(); if(op==='*') left = multiplyTermLists(left,right); else { if(right.length===1 && Object.keys(right[0].vars).length===0 && right[0].coeff!==0){ const d=right[0].coeff; left = left.map(t=>makeTerm(t.coeff/d, t.vars)); } } }
    return left;
  }
  function parseAddSub(){
    let left=parseMulDiv();
    while(peek() && (peek().type==='+'||peek().type==='-')){ const op=consume().type; const right=parseMulDiv(); if(op==='+') left=addTermLists(left,right); else left=addTermLists(left,right.map(t=>makeTerm(-t.coeff,t.vars))); }
    return left;
  }
  function multiplyTermLists(A,B){ const out=[]; for(const a of A) for(const b of B) out.push(makeTerm(a.coeff*b.coeff, multiplyVars(a.vars,b.vars))); return combineLikeTerms(out); }
  function addTermLists(A,B){ return combineLikeTerms(A.concat(B)); }
  const expr=parseAddSub(); return combineLikeTerms(expr);
}
function combineLikeTerms(terms){
  const map=new Map();
  for(const t of terms){ const vars={}; for(const k in t.vars) if(t.vars[k]!==0) vars[k]=t.vars[k]; const key=termKey(vars); const prev=map.get(key)||0; map.set(key, prev + (Number(t.coeff)||0)); }
  const out=[];
  for(const [k,coeff] of map.entries()){ if(Math.abs(coeff) < 1e-12) continue; const vars={}; if(k){ k.split('*').forEach(part=>{ const [name,exp]=part.split('^'); vars[name]=Number(exp); }); } out.push(makeTerm(coeff, vars)); }
  out.sort((a,b)=>{ const av=Object.keys(a.vars).length, bv=Object.keys(b.vars).length; if(av!==bv) return bv-av; const ak=termKey(a.vars), bk=termKey(b.vars); return ak<bk?-1:(ak>bk?1:0); });
  return out;
}
function termsToString(terms){
  if(!terms || terms.length===0) return '0';
  const parts=[];
  for(const t of terms){
    const coeff=t.coeff; const vars=t.vars||{}; const varNames=Object.keys(vars).sort();
    let varStr=varNames.map(v => vars[v]===1 ? v : `${v}^${vars[v]}`).join('*');
    const absCoeff=Math.abs(coeff);
    if(varStr){
      let coeffStr='';
      if(Math.abs(absCoeff-1) < 1e-12) coeffStr = (coeff<0)?'-':'';
      else coeffStr = (coeff<0?'-':'') + (absCoeff%1===0 ? String(absCoeff) : String(Number(absCoeff.toFixed(8))));
      parts.push(coeffStr + varStr);
    } else {
      const num = (coeff%1===0) ? String(coeff) : String(Number(coeff.toFixed(8)));
      parts.push(num);
    }
  }
  let out='';
  for(const p of parts){ if(out==='') out=p; else { if(p[0]==='-') out += ' - ' + p.slice(1); else out += ' + ' + p; } }
  return out.replace(/\*/g,'');
}
function simplifyAlgebra(expr){
  try{ const tokens = tokenize(expr); if(tokens.length===0) return null; const terms = parseExpression(tokens); if(!terms || terms.length===0) return '0'; return termsToString(terms); } catch(e){ return null; }
}
function evaluateNumeric(expr){
  if(!expr || expr.length > 500) return null;
  const allowed = expr.replace(/[^0-9+\-*/().,^\s%]/g,' ');
  const sanitized = allowed.replace(/\^/g,'**').replace(/%/g,'*0.01');
  try{ const fn = Function(`"use strict"; return (${sanitized});`); const val = fn(); if(typeof val === 'number' && Number.isFinite(val)) return +Number(val.toFixed(12)); return null; } catch(e){ return null; }
}
function geometryQuery(q){
  if(!q) return null;
  const s=q.toLowerCase(); let m;
  m = s.match(/area of (?:a |the )?circle(?:.*?)(?:radius|r)?[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const r=Number(m[1]); if(isFinite(r)) return {answer:(Math.PI*r*r).toFixed(8), explain:`area circle r=${r}`}; }
  m = s.match(/circumference of (?:a |the )?circle(?:.*?)(?:radius|r)?[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const r=Number(m[1]); if(isFinite(r)) return {answer:(2*Math.PI*r).toFixed(8), explain:`circumference r=${r}`}; }
  m = s.match(/area of (?:a |the )?triangle(?:.*?)(?:base|b)[^\d\-]*([-+]?\d*\.?\d+)[^\d\-]+(?:height|h)[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const b=Number(m[1]), h=Number(m[2]); if(isFinite(b)&&isFinite(h)) return {answer:((b*h)/2).toFixed(8), explain:`triangle b=${b} h=${h}`}; }
  m = s.match(/area of (?:a |the )?rectangle(?:.*?)(?:width|w)[^\d\-]*([-+]?\d*\.?\d+)[^\d\-]+(?:height|h)[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const w=Number(m[1]), h=Number(m[2]); if(isFinite(w)&&isFinite(h)) return {answer:(w*h).toFixed(8), explain:`rectangle ${w}x${h}`}; }
  return null;
}

/* ---------- Simple snippet gatherers (fallback when OpenAI fails) ---------- */
async function fetchWikiSummary(q){ try{ const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(q)}`); if(!r.ok) return null; const j = await r.json(); return j.extract || null; }catch(e){return null} }
async function fetchDDG(q){ try{ const r = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(q)}&format=json&no_html=1&skip_disambig=1`); if(!r.ok) return null; const j = await r.json(); return j.Abstract || (j.RelatedTopics ? j.RelatedTopics.map(t=>t.Text).join('. ') : null); }catch(e){return null} }
async function gatherSnippets(query, desired=6, aggressive=false, progressCb){
  const snippets = [];
  if(progressCb) progressCb('Trying Wikipedia summary...');
  const s1 = await fetchWikiSummary(query); if(s1) snippets.push(s1);
  if(progressCb) progressCb('Trying DuckDuckGo...');
  const d = await fetchDDG(query); if(d) snippets.push(d);
  if(aggressive){
    const exps=['history','release date','overview','timeline','founding'];
    for(const ex of exps){ if(snippets.length>=desired) break; if(progressCb) progressCb('Expanding: ' + ex); const t = await fetchWikiSummary(query + ' ' + ex); if(t) snippets.push(t); }
  }
  // dedupe
  const seen = new Set(), out=[];
  for(const t of snippets){ const k = t.slice(0,200).replace(/\s+/g,' ').trim(); if(!seen.has(k)){ seen.add(k); out.push(t); } if(out.length>=desired) break; }
  return out;
}

/* ---------- Pick best snippet (same logic) ---------- */
function extractYear(text){
  if(!text) return null;
  const m = text.match(/\b(17\d{2}|18\d{2}|19\d{2}|20\d{2}|2100)\b/g);
  if(!m) return null;
  const freq={}; for(const y of m) freq[y]=(freq[y]||0)+1;
  return Object.keys(freq).sort((a,b)=>freq[b]-freq[a])[0];
}
function pickBest(snips, query, modelKey, strictOnly){
  if(!snips || snips.length===0) return {answer:"I couldn't find an answer.", confidence:8};
  const wantsYear = /\bwhat\s+year|\bwhen\s+was|\bwhen\s+did\b/i.test(query) || /only the year|just the year/i.test(query);
  if(wantsYear){
    const years=[]; for(const s of snips){ const y = extractYear(s); if(y) years.push(y); }
    if(years.length>0){ const freq={}; for(const y of years) freq[y]=(freq[y]||0)+1; const pick = Object.keys(freq).sort((a,b)=>freq[b]-freq[a])[0]; const conf = Math.min(95, 40 + (freq[pick]-1)*20 + Math.min(40, snips.length*3)); return {answer: pick, confidence:conf}; }
  }
  let best = snips.slice().sort((a,b)=>b.length - a.length)[0];
  const sentences = (best||'').split(/(?<=\.)\s+/).filter(Boolean);
  const verb = MODEL_CONFIG[modelKey].verb || 1;
  const take = Math.max(1, Math.floor(verb * 1.6));
  let answer = sentences.slice(0,take).join(' ').trim();
  if(!answer) answer = (best||'').slice(0,300).trim();
  if(strictOnly && /\bonly the year\b|\bonly the number\b/i.test(query)){
    const n = answer.match(/-?\d+(\.\d+)?/);
    if(n) return {answer:n[0], confidence: Math.min(90, 20 + snips.length*6)};
  }
  const filled = snips.filter(s=>s.length>40).length;
  let conf = Math.min(95, 30 + filled*8 + Math.min(30, (snips.length-1)*3));
  const yearsFound = {}; snips.forEach(s=>{ const y = extractYear(s); if(y) yearsFound[y] = (yearsFound[y]||0)+1; });
  if(Object.keys(yearsFound).length>0){ const bestY = Object.keys(yearsFound).sort((a,b)=>yearsFound[b]-yearsFound[a])[0]; conf += Math.min(10, (yearsFound[bestY]-1)*5); }
  conf = Math.min(99, Math.max(8, Math.round(conf)));
  return {answer, confidence:conf};
}

/* ---------- Photo BETA (UI) ---------- */
function quotaKeyForToday(){
  const d = new Date(); const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
  return `gomega_photo_quota_${y}${m}${day}`;
}
function getQuotaUsed(){ return parseInt(localStorage.getItem(quotaKeyForToday()) || '0', 10); }
function incrementQuota(){ const k = quotaKeyForToday(); const u = getQuotaUsed()+1; localStorage.setItem(k,String(u)); updateQuotaUI(); return u; }
function updateQuotaUI(){ photoQuotaEl.textContent = premiumUnlocked ? '∞' : Math.max(0, DAILY_QUOTA - getQuotaUsed()); }

/* photo handlers */
addPhotoBtn.addEventListener('click', ()=>{
  const f = photoInput.files && photoInput.files[0];
  if(!f) { alert('Choose an image file first'); return; }
  if(!/^image\//.test(f.type)) { alert('Only images allowed'); return; }
  if(!premiumUnlocked && getQuotaUsed() >= DAILY_QUOTA){ alert('Daily photo send limit reached (5). Try again tomorrow or unlock premium.'); return; }
  const r = new FileReader();
  r.onload = (ev) => {
    const id = 'p' + Date.now();
    photos.push({id, name: f.name, url: ev.target.result, sent:false});
    renderPhotos();
  };
  r.readAsDataURL(f);
});
function renderPhotos(){
  photoGrid.innerHTML = '';
  photos.forEach(p=>{
    const card = document.createElement('div'); card.className='photoCard';
    const img = document.createElement('img'); img.src = p.url; img.alt = p.name;
    card.appendChild(img);
    const actions = document.createElement('div'); actions.className='photoActions';
    const sendBtn = document.createElement('button'); sendBtn.className='small'; sendBtn.textContent = p.sent ? 'Sent' : 'Send';
    sendBtn.onclick = () => {
      if(p.sent){ alert('Already sent'); return; }
      if(!premiumUnlocked && getQuotaUsed() >= DAILY_QUOTA){ alert('Daily photo send limit reached (5). Try again tomorrow.'); return; }
      addImageToChatAsUser(p);
      p.sent = true; if(!premiumUnlocked) incrementQuota(); renderPhotos();
    };
    const removeBtn = document.createElement('button'); removeBtn.className='small'; removeBtn.textContent='Remove';
    removeBtn.onclick = ()=>{ photos = photos.filter(x=>x.id !== p.id); renderPhotos(); };
    actions.appendChild(sendBtn); actions.appendChild(removeBtn);
    card.appendChild(actions);
    photoGrid.appendChild(card);
  });
  updateQuotaUI();
}
function addImageToChatAsUser(photo){
  const html = `<div style="font-size:13px;color:var(--muted);margin-bottom:6px">Image: ${escapeHtml(photo.name)}</div>
                <a href="${photo.url}" download="${escapeHtml(photo.name)}"><img src="${photo.url}" style="max-width:320px;width:100%;border-radius:8px" alt="${escapeHtml(photo.name)}"></a>`;
  addBubble('user', html);
  session.push({role:'user', text:`[image:${photo.name}]`, img: photo.url});
  updateSessionUI();
}

/* ---------- Model UI ---------- */
function renderModels(){
  modelSelect.innerHTML = '';
  modelListEl.innerHTML = '';
  for(const key of Object.keys(MODEL_CONFIG)){
    const cfg = MODEL_CONFIG[key];
    const opt = document.createElement('option'); opt.value = key; opt.textContent = cfg.label; if(cfg.premium && !premiumUnlocked) opt.disabled = true; modelSelect.appendChild(opt);

    const row = document.createElement('div'); row.className='model'; if(key===currentModelKey) row.classList.add('selected');
    row.innerHTML = `<div><strong>${escapeHtml(cfg.label)}</strong><div class="small">${cfg.premium ? 'Premium' : 'Standard'}</div></div><div class="small">${key===currentModelKey ? 'Selected' : 'Select'}</div>`;
    row.onclick = () => {
      if(cfg.premium && !premiumUnlocked){ alert('This is a premium model. Enter a premium code to unlock.'); return; }
      currentModelKey = key; renderModels(); setThinkingText(`Model: ${cfg.label}`);
    };
    modelListEl.appendChild(row);
  }
  modelSelect.value = currentModelKey;
}
renderModels();

/* ---------- OpenAI call with fallback ---------- */
async function callOpenAI(promptText, modelKey, options = {}){
  const key = getOpenAIKey();
  if(!key) throw new Error('No OpenAI key set. Click "Set Key" and paste your OpenAI API key for this session.');

  const cfg = MODEL_CONFIG[modelKey] || MODEL_CONFIG['gomega-v7'];
  const systemMsg = { role:'system', content: 'You are Gomega AI — concise assistant. Do not reveal your underlying model identifier.' };
  const messages = [ systemMsg, { role:'user', content: promptText } ];

  // Build request
  let body = { model: cfg.openai, messages, temperature: options.temperature ?? 0.2, max_tokens: options.max_tokens ?? 800 };

  // Try primary model, if 400 model error occurs retry with safe fallback
  let res = await fetch('https://api.openai.com/v1/chat/completions', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${key}` },
    body: JSON.stringify(body)
  });

  if(!res.ok){
    const txt = await res.text();
    // If the error suggests invalid model, try fallback to gpt-3.5-turbo
    if(res.status === 400 && /model/i.test(txt)){
      try{
        console.warn('Primary model failed, retrying with fallback gpt-3.5-turbo');
        body.model = 'gpt-3.5-turbo';
        res = await fetch('https://api.openai.com/v1/chat/completions', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${key}` },
          body: JSON.stringify(body)
        });
      }catch(e){}
    }
  }

  if(!res.ok){
    const text = await res.text();
    let err = `OpenAI request failed (${res.status})`;
    try{ const json = JSON.parse(text); if(json.error && json.error.message) err += `: ${json.error.message}`; else err += ': ' + text; } catch(e){ err += ': ' + text; }
    throw new Error(err);
  }

  const data = await res.json();
  const reply = data.choices && data.choices[0] && (data.choices[0].message?.content || data.choices[0].text) ? (data.choices[0].message?.content || data.choices[0].text) : 'No response';
  return reply;
}

/* ---------- Helper override: who made you ---------- */
function whoMadeYouOverride(text){
  if(!text) return null;
  if(/\bwho (made|created) you\b/i.test(text) || /\byou (made|created) by\b/i.test(text)) return 'I was made by ScriptNova. Follow @scriptnovaa on Instagram.';
  return null;
}

/* ---------- Main ask flow ---------- */
askBtn.addEventListener('click', onAsk);
promptEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); onAsk(); }});
clearBtn.addEventListener('click', ()=>{ messagesEl.innerHTML=''; session=[]; updateSessionUI(); });

function looksLikeMath(q){
  return /[0-9\+\-\*\/\^%()]/.test(q) || /\b(area|circumference|perimeter|volume|pythagor|triangle|circle|radius|simplify)\b/i.test(q);
}

async function onAsk(){
  if(typingLocked) return;
  const qRaw = (promptEl.value || '').trim();
  if(!qRaw) return;
  promptEl.value = '';
  addBubble('user', escapeHtml(qRaw));
  session.push({role:'user', text:qRaw});
  updateSessionUI();

  setTypingLocked(true);
  const aiNode = addBubble('ai', '<span class="small">Gomega is thinking…</span>');
  setThinkingText('Deciding strategy...');
  setProgress(6);

  try{
    // quick override
    const who = whoMadeYouOverride(qRaw);
    if(who){
      await typeTextInto(aiNode, who, 48);
      session.push({role:'ai', text:who});
      lastFetchEl.textContent = new Date().toLocaleString(); setProgress(100); setThinkingText('Idle');
      setTimeout(()=>{ setProgress(0); setTypingLocked(false); },700); return;
    }

    // 1) algebra simplification
    const needSimplify = /\bsimplify\b/i.test(qRaw) || /[a-zA-Z]/.test(qRaw) && /[+\-*/^()]/.test(qRaw);
    if(needSimplify){
      setThinkingText('Simplifying algebra locally...');
      setProgress(26);
      const simplified = simplifyAlgebra(qRaw) || simplifyAlgebra(qRaw.replace(/simplify/i,'').trim());
      if(simplified){
        await typeTextInto(aiNode, simplified, MODEL_CONFIG[currentModelKey].speed * 1.4);
        session.push({role:'ai', text:simplified});
        confidenceEl.textContent = '99%';
        lastFetchEl.textContent = new Date().toLocaleString();
        setProgress(100); setThinkingText('Idle');
        setTimeout(()=>{ setProgress(0); setTypingLocked(false); },700); return;
      }
    }

    // 2) geometry/numeric local
    const geom = geometryQuery(qRaw);
    if(geom && (currentModelKey==='mathmaster' || looksLikeMath(qRaw))){
      setThinkingText('Computing geometry locally...');
      setProgress(30);
      await typeTextInto(aiNode, String(geom.answer), MODEL_CONFIG[currentModelKey].speed * 1.4);
      const meta = document.createElement('div'); meta.className='explain'; meta.textContent = `Reason: ${geom.explain}`; aiNode.appendChild(meta);
      session.push({role:'ai', text:String(geom.answer)});
      confidenceEl.textContent = '99%'; lastFetchEl.textContent = new Date().toLocaleString();
      setProgress(100); setThinkingText('Idle'); setTimeout(()=>{ setProgress(0); setTypingLocked(false); },700); return;
    }
    const numeric = evaluateNumeric(qRaw);
    if(numeric !== null && currentModelKey === 'mathmaster'){
      setThinkingText('Evaluating expression...');
      setProgress(30);
      await typeTextInto(aiNode, String(numeric), MODEL_CONFIG[currentModelKey].speed * 1.4);
      session.push({role:'ai', text:String(numeric)});
      confidenceEl.textContent = '99%'; lastFetchEl.textContent = new Date().toLocaleString();
      setProgress(100); setThinkingText('Idle'); setTimeout(()=>{ setProgress(0); setTypingLocked(false); },700); return;
    }

    // 3) OpenAI call
    const key = getOpenAIKey();
    if(key){
      setThinkingText('Calling OpenAI...');
      setProgress(18);
      const selectedModelKey = modelSelect.value || currentModelKey;
      const cfg = MODEL_CONFIG[selectedModelKey];
      if(cfg.premium && !premiumUnlocked) throw new Error('This model is premium. Enter a premium code to unlock.');

      try{
        const reply = await callOpenAI(qRaw, selectedModelKey, { temperature: 0.12, max_tokens: 700 });
        setProgress(70);
        await typeTextInto(aiNode, reply, cfg.speed * 1.4);
        session.push({role:'ai', text: reply});
        updateSessionUI();
        confidenceEl.textContent = '—'; lastFetchEl.textContent = new Date().toLocaleString();
        setProgress(100); setThinkingText('Idle'); setTimeout(()=>{ setProgress(0); setTypingLocked(false); },800);
        return;
      } catch(openErr){
        console.warn('OpenAI failed:', openErr);
        // continue to fallback to client-side lookup
      }
    }

    // 4) fallback: multi-source gather
    setThinkingText('Searching multiple sources (client-side)...');
    setProgress(14);
    const aggressive = thinkingToggle.checked || currentModelKey === 'gomega-v6' || currentModelKey === 'gomega-v8';
    const snippets = await gatherSnippets(qRaw, 10, aggressive, (msg)=>{ lastAction.textContent = msg; const cur = parseInt(progressBar.style.width) || 10; setProgress(Math.min(90, cur + 8)); });

    if(!snippets || snippets.length===0){
      await typeTextInto(aiNode, "I couldn't find an answer — I tried looking it up.", MODEL_CONFIG[currentModelKey].speed * 1.8);
      session.push({role:'ai', text:"I couldn't find an answer — I tried looking it up."});
      updateSessionUI(); confidenceEl.textContent='10%'; setTypingLocked(false); setThinkingText('Idle'); setProgress(0); return;
    }

    setProgress(86);
    const strict = strictToggle.checked;
    const picked = pickBest(snippets, qRaw, currentModelKey, strict);
    const verification = evaluateNumeric(qRaw);
    let finalAnswer = picked.answer;
    if(verification !== null && !/\bonly the number\b/i.test(qRaw)) finalAnswer += `\n\n(Computed: ${verification})`;
    const sentImgs = photos.filter(p=>p.sent).length;
    if(sentImgs>0) finalAnswer += `\n\n(You provided ${sentImgs} image(s) in this session.)`;

    const speed = Math.max(10, Math.round(MODEL_CONFIG[currentModelKey].speed * 1.6));
    await typeTextInto(aiNode, finalAnswer, speed);
    const meta = document.createElement('div'); meta.className='explain'; meta.textContent = `Confidence: ${picked.confidence}%`; aiNode.appendChild(meta);
    session.push({role:'ai', text: finalAnswer}); updateSessionUI();
    lastFetchEl.textContent = new Date().toLocaleString(); confidenceEl.textContent = picked.confidence + '%';
    setProgress(100); setThinkingText('Idle'); setTimeout(()=>{ setProgress(0); setTypingLocked(false); }, 800);

  }catch(err){
    console.error(err);
    aiNode.innerHTML = '⚠️ Error: ' + escapeHtml(err.message || 'failed to compute');
    session.push({role:'ai', text:'Error: ' + (err.message||'failed')});
    updateSessionUI();
    setTypingLocked(false); setThinkingText('Idle'); setProgress(0);
  }
}

/* ---------- Initialization ---------- */
async function init(){
  await tryLoadApiTxt();
  await loadPremiumCodes();
  // check session store for premium
  premiumUnlocked = !!sessionStorage.getItem('gomega_premium');
  // UI seed
  renderModels();
  updateQuotaUI();
  addBubble('ai', '<strong>Hello — I am Gomega AI.</strong><div class="small" style="margin-top:6px">Try: "Simplify 4a-2(5a-7)" or "Area of circle radius 5" or "What year was Nokia released in North America?"</div>');
  updateSessionUI();
  tickLocalTime();
}
init();

function tickLocalTime(){ document.getElementById('localTime').textContent = new Date().toLocaleString(); setTimeout(tickLocalTime,1000); }

/* ---------- Photo send on file selection (auto add) ---------- */
photoInput.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  if(!/^image\//.test(f.type)) { alert('Only image files allowed'); return; }
  if(!premiumUnlocked && getQuotaUsed() >= DAILY_QUOTA){ alert('Daily photo send limit reached (5).'); return; }
  const r = new FileReader();
  r.onload = (ev) => {
    const id = 'p' + Date.now();
    photos.push({id, name: f.name, url: ev.target.result, sent:false});
    renderPhotos();
  };
  r.readAsDataURL(f);
});

/* ---------- Session clear ---------- */
clearSessionBtn.addEventListener('click', ()=>{ if(confirm('Clear session memory and photos?')){ session=[]; photos=[]; messagesEl.innerHTML=''; renderPhotos(); updateSessionUI(); localStorage.removeItem(quotaKeyForToday()); updateQuotaUI(); } });

/* ---------- Utility: quota key ---------- */
function quotaKeyForToday(){ const d=new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `gomega_photo_quota_${y}${m}${day}`; }

/* ---------- initial render of photos & UI ---------- */
renderPhotos();
updateQuotaUI();

/* ---------- End of script ---------- */
</script>
</body>
</html>