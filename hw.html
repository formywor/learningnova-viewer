<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HW Beta — Homework Helper</title>
<!-- Simple, modern styles -->
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#6ee7b7; --muted:#9aa6b2;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  body{
    background: radial-gradient(1200px 600px at 10% 10%, rgba(102,126,234,0.12), transparent),
                linear-gradient(180deg,#071021 0%, #07121b 100%);
    color:#e6eef6; display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .wrap{width:100%;max-width:980px;}
  header{display:flex;align-items:center;gap:16px;margin-bottom:14px}
  .beta{background:linear-gradient(90deg,#ffb86b,#ff7b7b);padding:6px 10px;border-radius:999px;font-weight:700;color:#111}
  h1{margin:0;font-size:20px}
  p.lead{color:var(--muted);margin:6px 0 20px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); padding:18px; border-radius:12px; box-shadow: 0 6px 30px rgba(2,6,23,0.6);}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
  .uploader{display:flex;flex-direction:column;gap:10px}
  input[type=file]{display:block}
  .drop{border:2px dashed rgba(255,255,255,0.04); padding:12px; border-radius:8px; text-align:center; color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{background:linear-gradient(180deg,#0b1b2a,#071026);border:1px solid rgba(255,255,255,0.03); color:#e6eef6;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.primary{background:linear-gradient(90deg,var(--accent),#60a5fa); color:#052123; font-weight:700}
  .result{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02)}
  .links a{color:var(--accent); text-decoration:none; display:inline-block; margin:6px 8px 6px 0}
  .small{font-size:13px;color:var(--muted)}
  footer{margin-top:12px;color:var(--muted);font-size:13px}
  .progress{height:8px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
  .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#6ee7b7)}
  .pill{display:inline-block;padding:6px 9px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:600}
  .feedbacks{margin-top:8px;font-size:13px}
  .muted-note{color:var(--muted);font-size:13px;margin-top:8px}
  @media (max-width:880px){ .grid{grid-template-columns:1fr} .uploader{order:2} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="beta">BETA</div>
    <div>
      <h1>HW Helper — Beta</h1>
      <p class="lead">Upload a photo or file (no <code>.exe</code>) and this page will try to solve or find answers online. Use "Look Deeper" or "Solve Smarter" up to 5×/day each.</p>
    </div>
  </header>

  <div class="card grid" role="main">
    <div class="uploader">
      <div class="drop" id="dropzone">
        <div style="font-weight:700;margin-bottom:6px">Upload or take a photo</div>
        <div class="small">Images (jpg, png, webp), PDF, .txt, .docx — (no .exe). You can also paste images or drag & drop.</div>
        <input id="filein" type="file" accept="image/*,application/pdf,text/plain,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
        <div style="margin-top:8px" class="controls">
          <button id="btnUseCamera">Take Photo (opens camera)</button>
          <button id="btnProcess" class="primary">Process & Solve</button>
          <button id="btnClear">Clear</button>
        </div>
        <div class="muted-note">Privacy: Everything runs in your browser. No files are uploaded to our servers from this page (unless you explicitly click a link to external sites).</div>
      </div>

      <div style="margin-top:12px" class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><strong>Assist tools</strong><div class="small">Try "Solve Smarter" for more aggressive math solving, or "Look Deeper" to gather more links & references.</div></div>
          <div class="pill" id="counterPill">SS: 5 • LD: 5</div>
        </div>

        <div style="margin-top:10px" class="controls">
          <button id="btnSolveSmarter">Solve Smarter</button>
          <button id="btnLookDeeper">Look Deeper</button>
        </div>

        <div class="feedbacks">
          <button id="btnRight">Was this answer right?</button>
          <button id="btnWrong">Was this answer wrong?</button>
          <div id="feedbackNote" class="small" style="margin-top:6px"></div>
        </div>
      </div>

    </div>

    <div>
      <div class="result" id="resultArea">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Answer preview</strong>
          <div class="small">Status: <span id="status">idle</span></div>
        </div>

        <div style="margin-top:10px;">
          <div class="progress" aria-hidden><i id="progBar"></i></div>
          <div id="extracted" style="margin-top:10px;white-space:pre-wrap;color:#cfe7e0"></div>
        </div>

        <div id="solution" style="margin-top:12px"></div>

        <div style="margin-top:12px">
          <strong>Source links</strong>
          <div id="links" class="links small"></div>
        </div>

        <div id="advancedNotes" style="margin-top:10px;color:var(--muted)"></div>
      </div>

      <footer>
        <div class="small">This is experimental (BETA). It uses client-side OCR and open-source solvers. For better results, use clear photos and single questions per upload. <span style="color:var(--accent)">No files are sent off this page by default.</span></div>
      </footer>
    </div>
  </div>
</div>

<!-- Libraries (CDNs) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/algebrite/1.5.0/algebrite.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
<!-- pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<script>
/* ========== Utilities, counters, and limits ========== */
const MAX_USES_PER_DAY = 5;
const KEY_COUNTS = 'hw-helper-counts-v1';

function todayKey(){ // store counts by date
  const d = new Date();
  return d.toISOString().slice(0,10);
}

function loadCounts(){
  const raw = JSON.parse(localStorage.getItem(KEY_COUNTS) || '{}');
  const key = todayKey();
  if(!raw.date || raw.date !== key){
    raw.date = key;
    raw.solveSmarter = 0;
    raw.lookDeeper = 0;
    raw.feedbacks = [];
    localStorage.setItem(KEY_COUNTS, JSON.stringify(raw));
  }
  return raw;
}
function saveCounts(obj){ localStorage.setItem(KEY_COUNTS, JSON.stringify(obj)); updatePill(); }
function updatePill(){
  const c = loadCounts();
  const ss = Math.max(0, MAX_USES_PER_DAY - (c.solveSmarter||0));
  const ld = Math.max(0, MAX_USES_PER_DAY - (c.lookDeeper||0));
  document.getElementById('counterPill').textContent = `SS: ${ss} • LD: ${ld}`;
}
updatePill();

/* ========== DOM refs ========== */
const filein = document.getElementById('filein');
const btnProcess = document.getElementById('btnProcess');
const btnClear = document.getElementById('btnClear');
const btnUseCamera = document.getElementById('btnUseCamera');
const dropzone = document.getElementById('dropzone');
const extractedEl = document.getElementById('extracted');
const statusEl = document.getElementById('status');
const progBar = document.getElementById('progBar');
const solutionEl = document.getElementById('solution');
const linksEl = document.getElementById('links');
const btnSolveSmarter = document.getElementById('btnSolveSmarter');
const btnLookDeeper = document.getElementById('btnLookDeeper');
const btnRight = document.getElementById('btnRight');
const btnWrong = document.getElementById('btnWrong');
const feedbackNote = document.getElementById('feedbackNote');
const advancedNotes = document.getElementById('advancedNotes');

/* ========== Helpers: UI updates ========== */
function setStatus(s){ statusEl.textContent = s; }
function setProgress(p){ progBar.style.width = Math.max(0,Math.min(100,p)) + '%'; }

/* ========== Validation: block .exe and suspicious types ========== */
function validateFile(file){
  const badExt = ['exe','bat','cmd','sh','js','msi'];
  const name = (file.name || '').toLowerCase();
  const ext = name.split('.').pop();
  if(badExt.includes(ext)) return `Files with .${ext} are not allowed.`;
  return null;
}

/* ========== File handling: images, pdf, txt, docx ========== */
async function readFile(file){
  const validation = validateFile(file);
  if(validation) throw new Error(validation);

  if(file.type.startsWith('image/') || /\.(png|jpe?g|webp|gif)$/i.test(file.name || '')){
    return { kind:'image', blob: file };
  }
  if(file.type === 'application/pdf' || /\.pdf$/i.test(file.name||'')){
    return { kind:'pdf', blob: file };
  }
  if(file.type === 'text/plain' || /\.txt$/i.test(file.name||'')){
    const txt = await file.text();
    return { kind:'text', text: txt };
  }
  if(file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || /\.docx$/i.test(file.name||'')){
    const arrayBuffer = await file.arrayBuffer();
    return { kind:'docx', buffer: arrayBuffer };
  }
  // fallback to try reading as text
  try {
    const txt = await file.text();
    return { kind:'text', text: txt };
  } catch(e){
    throw new Error('Unsupported file type.');
  }
}

/* PDF text extraction (simple) using pdf.js */
async function extractTextFromPDF(blob){
  const arrayBuf = await blob.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:arrayBuf}).promise;
  let full = '';
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const txt = await page.getTextContent();
    const pageText = txt.items.map(i => i.str).join(' ');
    full += pageText + '\n\n';
  }
  return full;
}

/* DOCX extraction using Mammoth.js */
async function extractTextFromDOCX(arrayBuffer){
  const result = await mammoth.extractRawText({arrayBuffer});
  return result.value || '';
}

/* OCR image -> text using Tesseract.js */
async function ocrImage(blob, onProgress){
  return new Promise((resolve, reject) => {
    const worker = Tesseract.createWorker({
      logger: m => { if(m.status === 'recognizing text' && onProgress) onProgress(m.progress*100); }
    });
    (async () => {
      await worker.load();
      await worker.loadLanguage('eng');
      await worker.initialize('eng');
      const { data: { text } } = await worker.recognize(blob);
      await worker.terminate();
      resolve(text);
    })().catch(reject);
  });
}

/* ========== Core: analyze text and attempt to answer ========== */
function isMathQuestion(text){
  // quick heuristics: contains =, variables, sqrt, integrate, derivative, sin, cos, integral, solve for x, + - * / ^, and digits
  const lowers = (text||'').toLowerCase();
  const mathKeywords = ['solve','integrate','differentiate','derivative','integral','limit','sqrt','sin(','cos(','tan(','^','x','y','='];
  return mathKeywords.some(k => lowers.includes(k)) || /[0-9]+\s*[\+\-\*\/\^]\s*[0-9]+/.test(text);
}

/* Attempt to extract a succinct question from the text (naive) */
function extractQuestionSnippet(text){
  if(!text) return '';
  // split into lines; prefer lines that end with ? or start with question words
  const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  for(const ln of lines){
    if(ln.endsWith('?')) return ln;
  }
  // look for lines with "solve" or "find" or "what is"
  for(const ln of lines){
    if(/\b(solve|find|what is|calculate|integrate|differentiate)\b/i.test(ln)) return ln;
  }
  // fallback: first 300 chars
  return lines.slice(0,5).join(' ').slice(0,500);
}

/* Basic math solving using Algebrite and mathjs fallback */
function trySolveMath(text){
  try{
    // try to find an equation like "2x+3=7" or "solve x^2-4=0"
    const snippet = text.replace(/\r?\n/g,' ').trim();
    // If snippet contains "solve" use Algebrite's solve
    if(/\bsolve\b/i.test(snippet)){
      // e.g., "solve 2x+3=7 for x"
      const match = snippet.match(/solve\s+(.+?)(?:\s+for\s+([a-zA-Z]\w*))?$/i);
      if(match){
        const expr = match[1].trim();
        const varname = match[2] || null;
        if(varname){
          const cmd = `roots(${expr})`;
          const res = Algebrite.run(cmd);
          return res;
        } else {
          const res = Algebrite.run(`roots(${expr})`);
          return res;
        }
      }
    }
    // if contains "=" try to isolate variable
    if(snippet.includes('=')){
      // replace implicit multiplication like 2x -> 2*x for algebrite (simple transform)
      let normalized = snippet.replace(/([0-9])([a-zA-Z])/g,'$1*$2').replace(/([a-zA-Z])([0-9])/g,'$1*$2');
      // attempt solve using Algebrite: "solve(equation, x)"
      const varMatch = normalized.match(/([a-zA-Z])\b/);
      const varname = varMatch ? varMatch[1] : 'x';
      const cmd = `roots(${normalized})`; // roots handles polynomials nicely
      try {
        const res = Algebrite.run(cmd);
        return res;
      } catch(e){
        // try solve
        try {
          const res2 = Algebrite.run(`solve(${normalized}, ${varname})`);
          return res2;
        } catch(e2){
          // last resort: numeric evaluate
          const evalRes = math.evaluate(normalized);
          return String(evalRes);
        }
      }
    }
    // fallback: try to evaluate expression directly
    try {
      const evalRes = math.evaluate(snippet);
      return String(evalRes);
    } catch(e){}
  }catch(e){
    return null;
  }
  return null;
}

/* Build search links for a query */
function buildSearchLinks(query){
  const encoded = encodeURIComponent(query);
  return [
    {title:'Google (web)', url:`https://www.google.com/search?q=${encoded}`},
    {title:'Bing (web)', url:`https://www.bing.com/search?q=${encoded}`},
    {title:'WolframAlpha (math)', url:`https://www.wolframalpha.com/input?i=${encoded}`},
    {title:'Google Scholar', url:`https://scholar.google.com/scholar?q=${encoded}`},
    {title:'Stack Exchange search', url:`https://stackexchange.com/search?q=${encoded}`},
    {title:'DuckDuckGo', url:`https://duckduckgo.com/?q=${encoded}`}
  ];
}

/* Render links into the UI */
function showLinksForQuery(query){
  linksEl.innerHTML = '';
  const ls = buildSearchLinks(query);
  ls.forEach(l=>{
    const a = document.createElement('a');
    a.href = l.url;
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.textContent = l.title;
    linksEl.appendChild(a);
  });
}

/* ========== Main processing pipeline ========== */
let lastExtractedText = '';
async function processFileWrapper(fileObj, options={smart:false,lookDeeper:false}) {
  try{
    setStatus('processing');
    setProgress(5);
    solutionEl.innerHTML = '';
    linksEl.innerHTML = '';
    advancedNotes.textContent = '';
    extractedEl.textContent = '';
    lastExtractedText = '';

    // read the file into a known kind
    const data = await readFile(fileObj);
    setProgress(12);
    let fullText = '';

    if(data.kind === 'image'){
      setStatus('running OCR on image');
      const text = await ocrImage(data.blob, p=>setProgress(12 + p*0.6));
      fullText = text || '';
    } else if(data.kind === 'pdf'){
      setStatus('extracting PDF text');
      fullText = await extractTextFromPDF(data.blob);
      setProgress(45);
    } else if(data.kind === 'docx'){
      setStatus('extracting docx text');
      fullText = await extractTextFromDOCX(data.buffer);
      setProgress(40);
    } else if(data.kind === 'text'){
      fullText = data.text || '';
      setProgress(40);
    } else {
      fullText = '';
    }

    // safety: trim enormous text for local processing
    const safeText = (fullText || '').trim();
    lastExtractedText = safeText;
    extractedEl.textContent = safeText || '[no readable text found — try a clearer photo or upload a text/PDF/DOCX]';
    setProgress(60);

    // extract compact question snippet
    const snippet = extractQuestionSnippet(safeText);
    setProgress(68);

    // if it looks like math, try math solving
    if(isMathQuestion(safeText || snippet)){
      setStatus('attempting math solve');
      // Solve multiple ways depending on "smart"
      let sol = trySolveMath(snippet || safeText);
      setProgress(85);
      if(!sol && options.smart){
        // more aggressive: try different forms, tidy input
        const alt = (snippet || safeText).replace(/=/g,'=='); // trivial attempts
        try { sol = trySolveMath(alt); } catch(e){}
      }
      if(sol){
        solutionEl.innerHTML = `<pre style="white-space:pre-wrap">${escapeHtml(String(sol))}</pre>`;
        showLinksForQuery(snippet || safeText);
        setStatus('math answer provided (local)');
        setProgress(100);
        advancedNotes.textContent = 'Used local symbolic solver (Algebrite) + heuristics. If this looks off, click "Look Deeper" or "Solve Smarter".';
        return;
      }
    }

    // Not obviously math or math failed -> prepare search and a naive answer attempt
    setStatus('building search & answer attempts');
    setProgress(75);

    // Naive answer attempt: try to summarize first sentence lines and detect MCQ
    const mcMatch = safeText.match(/(?:A\)|A\.|A:)\s*(.+)\s*(?:B\)|B\.|B:)/i);
    let naive = '';
    if(mcMatch){
      naive = 'Detected multiple-choice style question. I can open targeted searches for each choice.';
    } else {
      // produce a tiny heuristic-based "attempt" (we are client-only; do not claim external knowledge)
      const lines = safeText.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      naive = lines.slice(0,6).join(' ').slice(0,800) || 'No clear question text found to answer locally.';
      naive = 'Question snippet: ' + naive;
    }

    solutionEl.innerHTML = `<pre style="white-space:pre-wrap">${escapeHtml(naive)}</pre>`;
    showLinksForQuery(snippet || safeText || 'homework question');

    setStatus('links provided (click to open sources)');
    setProgress(100);
    advancedNotes.textContent = options.lookDeeper ? 'Look Deeper used: added supplementary search flavors.' : '';
  } catch(err){
    setStatus('error');
    setProgress(0);
    solutionEl.innerHTML = `<div style="color:#ff9b9b">Error: ${escapeHtml(err.message || String(err))}</div>`;
  }
}

/* ========== Button handlers & UX ========== */
btnProcess.addEventListener('click', async ()=>{
  const f = filein.files[0];
  if(!f){ alert('Please choose or take a photo/file first.'); return; }
  try{
    await processFileWrapper(f, {smart:false});
  }catch(e){ alert(e.message || e); }
});

btnClear.addEventListener('click', ()=>{
  filein.value = '';
  extractedEl.textContent = '';
  solutionEl.innerHTML = '';
  linksEl.innerHTML = '';
  setStatus('idle');
  setProgress(0);
  advancedNotes.textContent = '';
});

btnUseCamera.addEventListener('click', ()=>{
  // trigger file input with camera constraints (mobile browsers will open camera)
  const camera = document.createElement('input');
  camera.type = 'file';
  camera.accept = 'image/*';
  camera.capture = 'environment';
  camera.onchange = ()=> {
    if(camera.files && camera.files[0]){
      filein.files = camera.files;
      // auto-process for convenience
      btnProcess.click();
    }
  };
  camera.click();
});

/* Drag & drop */
dropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropzone.style.borderColor = '#1f7a60'; });
dropzone.addEventListener('dragleave', ()=>{ dropzone.style.borderColor = ''; });
dropzone.addEventListener('drop', (e)=>{ e.preventDefault(); dropzone.style.borderColor = ''; if(e.dataTransfer.files && e.dataTransfer.files[0]){ filein.files = e.dataTransfer.files; } });

/* Solve Smarter (aggressive local solving) */
btnSolveSmarter.addEventListener('click', async ()=>{
  const counts = loadCounts();
  if((counts.solveSmarter||0) >= MAX_USES_PER_DAY){
    alert(`"Solve Smarter" limit reached for today (${MAX_USES_PER_DAY}). It resets daily.`);
    return;
  }
  const f = filein.files[0];
  if(!f){ alert('Please upload or take a photo first.'); return; }
  counts.solveSmarter = (counts.solveSmarter||0) + 1;
  saveCounts(counts);
  updatePill();
  await processFileWrapper(f, {smart:true});
});

/* Look Deeper (opens more sources & extended heuristics) */
btnLookDeeper.addEventListener('click', async ()=>{
  const counts = loadCounts();
  if((counts.lookDeeper||0) >= MAX_USES_PER_DAY){
    alert(`"Look Deeper" limit reached for today (${MAX_USES_PER_DAY}). It resets daily.`);
    return;
  }
  const f = filein.files[0];
  if(!f){ alert('Please upload or take a photo first.'); return; }
  counts.lookDeeper = (counts.lookDeeper||0) + 1;
  saveCounts(counts);
  updatePill();

  // Process normally but add more link flavors (chegg, coursehero, youtube)
  await processFileWrapper(f, {smart:false,lookDeeper:true});
  // append extra links (some paywalled but sometimes helpful)
  const q = encodeURIComponent(extractQuestionSnippet(lastExtractedText) || lastExtractedText || 'homework question');
  const extra = [
    {title:'YouTube (video explanations)', url:`https://www.youtube.com/results?search_query=${q}`},
    {title:'CourseHero', url:`https://www.coursehero.com/search?q=${q}`},
    {title:'Chegg', url:`https://www.chegg.com/search/${q}`},
    {title:'Khan Academy (search)', url:`https://www.google.com/search?q=${q}+khan+academy`},
  ];
  extra.forEach(l=>{
    const a = document.createElement('a'); a.href = l.url; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent = l.title;
    linksEl.appendChild(a);
  });
  advancedNotes.textContent = 'Look Deeper appended additional sites like YouTube, CourseHero, and Chegg (paywalled content may require login).';
});

/* Feedback buttons */
btnRight.addEventListener('click', ()=>{
  const counts = loadCounts();
  counts.feedbacks = counts.feedbacks || [];
  counts.feedbacks.push({time: new Date().toISOString(), verdict:'right', snippet: lastExtractedText.slice(0,400)});
  saveCounts(counts);
  feedbackNote.textContent = 'Thanks — marked as correct. Your feedback is stored locally in your browser (privacy-friendly).';
});
btnWrong.addEventListener('click', ()=>{
  const counts = loadCounts();
  counts.feedbacks = counts.feedbacks || [];
  counts.feedbacks.push({time: new Date().toISOString(), verdict:'wrong', snippet: lastExtractedText.slice(0,400)});
  saveCounts(counts);
  feedbackNote.textContent = 'Thanks — marked as incorrect. Consider clicking "Look Deeper" or "Solve Smarter".';
});

/* small helper */
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' })[c]); }

/* Initialize UI */
setProgress(0);
setStatus('idle');
updatePill();

/* Optional: auto process pasted images */
window.addEventListener('paste', (e)=>{
  const items = (e.clipboardData || window.clipboardData).items;
  if(!items) return;
  for(const it of items){
    if(it.type && it.type.indexOf('image') !== -1){
      const file = it.getAsFile();
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      filein.files = dataTransfer.files;
      btnProcess.click();
      break;
    }
  }
});

/* End of script */
</script>
</body>
</html>