<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Gomega Intelligence — HW Helper (BETA)</title>

<style>
  :root{
    --bg:#060e19; --bg2:#0a1526; --card:rgba(255,255,255,.04);
    --glass:rgba(255,255,255,.06);
    --accent:#7dd3fc; --accent2:#34d399; --muted:#9aa6b2; --ink:#eaf2fa;
    --ring:rgba(125,211,252,.45);
    --shadow:0 16px 60px rgba(2,6,23,.55);
  }

  /* Layout: fluid + zoom resilient */
  html,body{height:100%;margin:0}
  body{
    min-height:100svh;
    font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;
    color:var(--ink);
    background:
      radial-gradient(1400px 700px at 10% 0%, rgba(56,189,248,.15), transparent 60%),
      radial-gradient(1000px 500px at 90% 0%, rgba(52,211,153,.12), transparent 60%),
      linear-gradient(180deg,var(--bg) 0%, var(--bg2) 100%);
    display:flex; align-items:center; justify-content:center;
    padding:clamp(12px,2.2vw,28px);
    overflow-x:hidden;
  }

  /* Subtle animated watermark “Gomega Intelligence — BETA” */
  .watermark{
    position:fixed; inset:0; pointer-events:none; opacity:.07; z-index:0;
    background-image:
      url('data:image/svg+xml;utf8,\
        <svg xmlns="http://www.w3.org/2000/svg" width="600" height="180" viewBox="0 0 600 180">\
          <defs>\
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">\
              <stop offset="0%" stop-color="%23a5f3fc"/><stop offset="100%" stop-color="%23bbf7d0"/>\
            </linearGradient>\
          </defs>\
          <rect width="600" height="180" fill="transparent"/>\
          <text x="20" y="110" font-family="Inter,Segoe UI,Arial" font-size="28" fill="url(%23g)" opacity="0.85">Gomega Intelligence — BETA</text>\
        </svg>');
    background-size: 420px 126px;
    animation: drift 30s linear infinite;
  }
  @keyframes drift {
    0%{ background-position: 0 0; }
    100%{ background-position: 420px 126px; }
  }

  .wrap{
    width:100%;
    max-width:min(1160px, 100vw);
    position:relative; z-index:1;
  }

  header{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; margin-bottom:clamp(8px,1.2vw,14px);
    padding-inline: clamp(6px,1vw,12px);
  }
  .brand{display:flex; align-items:center; gap:clamp(8px,1.2vw,14px)}
  .logo{
    width:clamp(34px,4.8vw,44px); height:clamp(34px,4.8vw,44px); border-radius:12px;
    background: conic-gradient(from 160deg,#38bdf8, #22c55e,#8b5cf6,#38bdf8);
    position:relative; overflow:hidden; flex:0 0 auto;
  }
  .logo::after{
    content:""; position:absolute; inset:3px; border-radius:9px;
    background: radial-gradient(60% 60% at 30% 30%, rgba(255,255,255,.22), transparent 60%),
                linear-gradient(180deg,#0b1220, #0b1526);
    box-shadow: inset 0 0 12px rgba(255,255,255,.08);
  }
  h1{margin:0; font-size:clamp(18px,2.3vw,22px); letter-spacing:.2px}
  .beta{background:linear-gradient(90deg,#ffb86b,#ff7b7b); padding:.35em .65em; border-radius:999px; font-weight:800; color:#111; margin-left:.5ch}

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    border:1px solid rgba(255,255,255,.06);
    border-radius:14px; box-shadow:var(--shadow);
  }

  /* Responsive grid that collapses gracefully at any zoom */
  .grid{
    display:grid;
    grid-template-columns: minmax(0, 420fr) minmax(0, 640fr);
    gap:clamp(10px,1.4vw,18px);
  }
  @media (max-width: 920px){
    .grid{ grid-template-columns: 1fr; }
  }

  .panel, .result{ padding:clamp(12px,1.6vw,16px) }
  .section{
    background:rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.06);
    border-radius:12px;
    padding:clamp(10px,1.4vw,12px);
  }
  .section + .section{ margin-top:clamp(10px,1.2vw,12px) }

  .muted{color:var(--muted)}
  .pill{
    display:inline-flex; align-items:center; gap:8px; padding:.45em .72em;
    border-radius:999px; background:rgba(255,255,255,.06); font-weight:700; white-space:nowrap;
  }
  .badge{display:inline-block;font-size:.72rem;padding:.18em .56em;border-radius:999px;background:rgba(125,211,252,.22);border:1px solid rgba(125,211,252,.35);color:#9de1ff;margin-left:.5ch}

  .controls{display:flex; gap:8px; flex-wrap:wrap}
  button{
    background:linear-gradient(180deg,#0b1b2a,#071026);
    border:1px solid rgba(255,255,255,.06); color:var(--ink);
    padding:.62em .8em; border-radius:10px; cursor:pointer;
    transition:.18s transform ease,.18s background ease;
    min-height:40px;
  }
  button:hover{ transform: translateY(-1px) }
  button.primary{
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    color:#052123; font-weight:800; border:none;
  }

  .drop{
    border:2px dashed rgba(255,255,255,.08); padding:clamp(12px,1.6vw,14px); border-radius:12px;
    text-align:center; color:var(--muted);
    transition:border-color .2s ease, background .2s ease;
    word-break:break-word;
  }
  .drop.drag{ border-color:#22c55e; background:rgba(34,197,94,.05); }
  input[type="file"]{ width:100% }

  .toprow{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .status{font-size:.86rem;color:var(--muted)}
  .progress{height:8px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden}
  .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#6ee7b7)}

  .answer{padding:12px;border-radius:12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06)}
  .links a{color:var(--accent);text-decoration:none;display:inline-block;margin:6px 8px 0 0;word-break:break-all}
  .small{font-size:.86rem}

  footer{margin-top:10px;color:var(--muted);font-size:.85rem}

  /* Make everything wrap instead of overflow on tiny screens or heavy zoom */
  .wrap, header, .grid, .controls, .links{min-width:0}
</style>
</head>
<body>
<div class="watermark" aria-hidden="true"></div>

<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Gomega Intelligence <span class="beta">BETA</span></h1>
        <div class="muted small">Homework Helper — Powered by Gomega Intelligence (answers, steps, and PDF fill). <span class="badge">BETA</span></div>
      </div>
    </div>
    <div class="pill" id="counterPill">SS: 5 • LD: 5</div>
  </header>

  <div class="card grid" role="main">
    <!-- LEFT -->
    <div class="panel">
      <!-- Mode & model (no user keys anywhere) -->
      <div class="section">
        <div class="controls" style="justify-content:space-between">
          <div style="flex:1;min-width:180px">
            <div class="small muted">Mode</div>
            <select id="modeSel" style="width:100%;padding:.6em;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(10,18,32,.6);color:var(--ink);outline:none">
              <option value="answers">Answers only (on-page)</option>
              <option value="fillpdf">Fill PDF (fields) or add Answer Sheet</option>
            </select>
          </div>
          <div style="flex:1;min-width:220px">
            <div class="small muted">Gomega Model (BETA specializations)</div>
            <select id="modelSel" style="width:100%;padding:.6em;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(10,18,32,.6);color:var(--ink);outline:none">
              <option value="gomega-v1">gomega-v1 — Language & history</option>
              <option value="gomega-v2">gomega-v2 — Math & physics</option>
              <option value="gomega-v3">gomega-v3 — Biology & chemistry</option>
              <option value="gomega-v3-turbo">gomega-v3-turbo — Coding & debugging</option>
              <option value="gomega-vision">gomega-vision — Solve from images</option>
            </select>
          </div>
        </div>
        <div class="small muted" style="margin-top:6px">All models are tuned to be “smart at one topic” (BETA).</div>
      </div>

      <div class="section">
        <div class="drop" id="dropzone">
          <div style="font-weight:800;margin-bottom:6px">Upload or take a photo</div>
          <div class="small muted">Images (jpg, png, webp), PDF, .txt, .docx. You can also paste images or drag & drop.</div>
          <input id="filein" type="file" accept="image/*,application/pdf,text/plain,application/vnd.openxmlformats-officedocument.wordprocessingml.document" style="margin-top:10px"/>
          <div class="controls" style="margin-top:10px">
            <button id="btnUseCamera">Take Photo</button>
            <button id="btnProcess" class="primary">Process & Solve</button>
            <button id="btnFill" title="Build answered PDF">Fill PDF</button>
            <button id="btnClear">Clear</button>
          </div>
          <div class="small muted" style="margin-top:6px">Privacy: Files stay in your browser except model calls made with Gomega Intelligence.</div>
        </div>
      </div>

      <div class="section">
        <strong>Assist</strong>
        <div class="small muted" style="margin:4px 0 8px">“Solve Smarter” boosts local math & parsing. “Look Deeper” adds search links.</div>
        <div class="controls">
          <button id="btnSolveSmarter">Solve Smarter</button>
          <button id="btnLookDeeper">Look Deeper</button>
        </div>
      </div>

      <div class="section">
        <strong>Feedback</strong>
        <div class="controls" style="margin-top:8px">
          <button id="btnRight">Answer was right</button>
          <button id="btnWrong">Answer was wrong</button>
        </div>
        <div id="feedbackNote" class="small muted" style="margin-top:6px"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="result">
      <div class="toprow">
        <div><strong>Answer preview</strong> <span class="badge">Gomega Intelligence — BETA</span></div>
        <div class="status">Status: <span id="status">idle</span></div>
      </div>

      <div style="margin-top:10px" class="progress" aria-hidden><i id="progBar"></i></div>

      <div style="margin-top:12px">
        <div id="extracted" style="white-space:pre-wrap;color:#cfe7e0; font-size:clamp(13px,1.2vw,14px)"></div>
      </div>

      <div id="solution" class="answer" style="margin-top:12px"></div>

      <div style="margin-top:12px">
        <strong>Source links</strong>
        <div id="links" class="links"></div>
      </div>

      <div id="advancedNotes" class="small muted" style="margin-top:10px"></div>

      <div id="pdfOut" style="margin-top:14px"></div>

      <footer>
        Gomega Intelligence is in <strong>BETA</strong>. For best results, use clear photos and one question per upload.
      </footer>
    </div>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/algebrite/1.5.0/algebrite.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<script>
/* ==============================
   CONFIG — Gomega Intelligence
   ==============================
   Paste your shared key below. Nothing is shown in the UI.
   NOTE: putting secrets in client code exposes them to users.
   Use a proxy/server for production if needed.
*/
const GOMEGA_API_KEY = '/*** PASTE YOUR SHARED KEY HERE ***/'.replace(/,/g,'').trim();

/* Map Gomega model names (what users see) to backend models/endpoints. */
const GOMEGA_BACKING = {
  'gomega-v1':       { provider:'openai', model:'gpt-4o-mini',    purpose:'language-history' },
  'gomega-v2':       { provider:'openai', model:'gpt-4o',         purpose:'math-physics' },
  'gomega-v3':       { provider:'openai', model:'o4-mini',        purpose:'bio-chem' },
  'gomega-v3-turbo': { provider:'openai', model:'o4-mini',        purpose:'coding-debug' },
  'gomega-vision':   { provider:'openai', model:'gpt-4o-mini',    purpose:'vision' } // image+text
};

/* ====== Daily counters ====== */
const MAX_USES_PER_DAY = 5;
const KEY_COUNTS = 'hw-helper-counts-v1';

function todayKey(){ return new Date().toISOString().slice(0,10); }
function loadCounts(){
  const raw = JSON.parse(localStorage.getItem(KEY_COUNTS) || '{}');
  if(raw.date !== todayKey()){ Object.assign(raw, {date:todayKey(), solveSmarter:0, lookDeeper:0, feedbacks:[]}); }
  localStorage.setItem(KEY_COUNTS, JSON.stringify(raw));
  return raw;
}
function saveCounts(o){ localStorage.setItem(KEY_COUNTS, JSON.stringify(o)); updatePill(); }
function updatePill(){
  const c = loadCounts();
  const ss = Math.max(0, MAX_USES_PER_DAY - (c.solveSmarter||0));
  const ld = Math.max(0, MAX_USES_PER_DAY - (c.lookDeeper||0));
  document.getElementById('counterPill').textContent = `SS: ${ss} • LD: ${ld}`;
}

/* ====== UI helpers ====== */
function setStatus(s){ document.getElementById('status').textContent = s; }
function setProgress(p){ document.getElementById('progBar').style.width = Math.max(0,Math.min(100,p)) + '%'; }
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' })[c]); }

/* ====== Elements ====== */
const filein = document.getElementById('filein');
const btnProcess = document.getElementById('btnProcess');
const btnFill = document.getElementById('btnFill');
const btnClear = document.getElementById('btnClear');
const btnUseCamera = document.getElementById('btnUseCamera');
const dropzone = document.getElementById('dropzone');
const extractedEl = document.getElementById('extracted');
const solutionEl = document.getElementById('solution');
const linksEl = document.getElementById('links');
const advancedNotes = document.getElementById('advancedNotes');
const pdfOut = document.getElementById('pdfOut');
const modelSel = document.getElementById('modelSel');
const modeSel = document.getElementById('modeSel');

/* ====== File utils ====== */
function validateFile(file){
  const badExt = ['exe','bat','cmd','sh','js','msi'];
  const name = (file.name || '').toLowerCase();
  const ext = name.split('.').pop();
  if(badExt.includes(ext)) return `Files with .${ext} are not allowed.`;
  return null;
}

async function extractTextFromPDF(blob){
  const arrayBuf = await blob.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:arrayBuf}).promise;
  let full = '';
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const txt = await page.getTextContent({normalizeWhitespace:true});
    const pageText = txt.items.map(i => i.str).join(' ');
    full += pageText + '\n\n';
  }
  return full.trim();
}

async function extractTextFromDOCX(arrayBuffer){
  const result = await mammoth.extractRawText({arrayBuffer});
  return (result.value || '').trim();
}

async function ocrImage(blob, onProgress){
  return new Promise((resolve, reject) => {
    const worker = Tesseract.createWorker({
      logger: m => { if(m.status === 'recognizing text' && onProgress) onProgress(Math.round(m.progress*100)); }
    });
    (async () => {
      await worker.load(); await worker.loadLanguage('eng'); await worker.initialize('eng');
      const { data:{ text } } = await worker.recognize(blob);
      await worker.terminate(); resolve(text || '');
    })().catch(reject);
  });
}

async function readFile(file){
  const v = validateFile(file); if(v) throw new Error(v);
  if(file.type.startsWith('image/') || /\.(png|jpe?g|webp|gif)$/i.test(file.name||'')) return { kind:'image', blob:file };
  if(file.type === 'application/pdf' || /\.pdf$/i.test(file.name||'')) return { kind:'pdf', blob:file };
  if(file.type === 'text/plain' || /\.txt$/i.test(file.name||'')) return { kind:'text', text: await file.text() };
  if(file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || /\.docx$/i.test(file.name||'')) return { kind:'docx', buffer: await file.arrayBuffer() };
  try{ return { kind:'text', text: await file.text() }; } catch{ throw new Error('Unsupported file type.'); }
}

/* ====== Heuristics ====== */
function extractQuestionSnippet(text){
  if(!text) return '';
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  for(const ln of lines){ if(ln.endsWith('?')) return ln; }
  for(const ln of lines){ if(/\b(solve|find|what is|calculate|integrate|differentiate|explain)\b/i.test(ln)) return ln; }
  return lines.slice(0,6).join(' ').slice(0,800);
}
function isMathQuestion(text){
  const s = (text||'').toLowerCase();
  const kws = ['solve','integrate','differentiate','derivative','integral','limit','sqrt','sin(','cos(','tan(','^','x','y','='];
  return kws.some(k => s.includes(k)) || /[0-9]+\s*[\+\-\*\/\^]\s*[0-9]+/.test(s);
}
function trySolveMath(text){
  try{
    const snippet = text.replace(/\r?\n/g,' ').trim();
    if(/\bsolve\b/i.test(snippet)){
      const m = snippet.match(/solve\s+(.+?)(?:\s+for\s+([a-zA-Z]\w*))?$/i);
      if(m){ const expr = m[1].trim(); return Algebrite.run(`roots(${expr})`); }
    }
    if(snippet.includes('=')){
      let normalized = snippet.replace(/([0-9])([a-zA-Z])/g,'$1*$2').replace(/([a-zA-Z])([0-9])/g,'$1*$2');
      const vMatch = normalized.match(/([a-zA-Z])\b/); const v = vMatch ? vMatch[1] : 'x';
      try { return Algebrite.run(`roots(${normalized})`); } catch(e){}
      try { return Algebrite.run(`solve(${normalized}, ${v})`); } catch(e2){}
      try { return String(math.evaluate(normalized)); } catch(e3){}
    }
    try { return String(math.evaluate(snippet)); } catch(e){}
  }catch(e){ return null; }
  return null;
}
function buildSearchLinks(query){
  const q = encodeURIComponent(query||'homework question');
  return [
    {title:'Google', url:`https://www.google.com/search?q=${q}`},
    {title:'WolframAlpha', url:`https://www.wolframalpha.com/input?i=${q}`},
    {title:'YouTube', url:`https://www.youtube.com/results?search_query=${q}`},
    {title:'Scholar', url:`https://scholar.google.com/scholar?q=${q}`}
  ];
}
function showLinksForQuery(query){
  linksEl.innerHTML = '';
  buildSearchLinks(query).forEach(l=>{
    const a = document.createElement('a'); a.href=l.url; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent=l.title;
    linksEl.appendChild(a);
  });
}

/* ====== Vision & chat call ====== */
function backingFor(name){
  const meta = GOMEGA_BACKING[name] || GOMEGA_BACKING['gomega-v2'];
  return meta;
}
function requireKey(){
  const cleaned = (GOMEGA_API_KEY || '').replace(/,/g,'').trim();
  if(!cleaned) throw new Error('No backend key set. Edit the HTML and paste your shared key in the CONFIG section.');
  return cleaned;
}
async function blobToBase64(blob){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = () => resolve((r.result||'').toString().split(',').pop());
    r.onerror = reject;
    r.readAsDataURL(blob);
  });
}

async function gomegaAsk({modelName, text, imageBlob, style='concise'}){
  const key = requireKey();
  const meta = backingFor(modelName);
  const wantSteps = (style === 'full');

  // Build messages: support vision content for gomega-vision or any with imageBlob
  const userParts = [];
  if(text){ userParts.push({type:'text', text}); }
  if(imageBlob){
    const b64 = await blobToBase64(imageBlob);
    userParts.push({type:'image_url', image_url:{url:`data:${imageBlob.type};base64,${b64}`}});
  }

  const systemText = [
    "You are Gomega Intelligence, a precise homework assistant (BETA).",
    "Extract clear question(s), solve accurately, and return JSON `{answers:[{number?:string,question?:string,answer:string,steps?:string}]}`.",
    "Be concise by default; include steps only when asked."
  ].join(' ');

  // Currently using OpenAI-style API with mapped model ids.
  const body = {
    model: meta.model,
    temperature: wantSteps ? 0.5 : 0.2,
    response_format: { type: "json_object" },
    messages: [
      {role:'system', content:systemText},
      {role:'user', content:userParts}
    ],
    max_tokens: 1500
  };

  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const t = await res.text().catch(()=>res.statusText);
    throw new Error('Gomega backend error: '+ t);
  }
  const data = await res.json();
  let content = data?.choices?.[0]?.message?.content || '{}';
  try{ return JSON.parse(content); }catch(e){ return {answers:[{answer: content}]} }
}

/* ====== Pipeline ====== */
let lastExtractedText = '';
async function processFile(file, {smart=false, forFill=false}={}){
  setStatus('processing'); setProgress(6);
  solutionEl.innerHTML=''; linksEl.innerHTML=''; advancedNotes.textContent=''; pdfOut.innerHTML=''; extractedEl.textContent='';

  const data = await readFile(file);
  setProgress(14);
  let fullText = '';

  if(data.kind==='image'){
    setStatus('OCR on image'); fullText = await ocrImage(data.blob, p=>setProgress(14 + p*0.6));
  }else if(data.kind==='pdf'){
    setStatus('Extracting PDF text'); fullText = await extractTextFromPDF(data.blob); setProgress(45);
  }else if(data.kind==='docx'){
    setStatus('Extracting DOCX text'); fullText = await extractTextFromDOCX(data.buffer); setProgress(40);
  }else if(data.kind==='text'){
    fullText = data.text || ''; setProgress(38);
  }

  lastExtractedText = (fullText||'').trim();
  extractedEl.textContent = lastExtractedText || '[no readable text found]';
  const snippet = extractQuestionSnippet(lastExtractedText); setProgress(58);

  // Local quick math (fast path)
  if(!forFill && isMathQuestion(lastExtractedText || snippet)){
    setStatus('local math attempt');
    let sol = trySolveMath(snippet || lastExtractedText);
    setProgress(72);
    if(!sol && smart){
      const alt = (snippet || lastExtractedText).replace(/=/g,'==');
      try{ sol = trySolveMath(alt); }catch(e){}
    }
    if(sol){
      solutionEl.innerHTML = `<pre style="white-space:pre-wrap">${escapeHtml(String(sol))}</pre>`;
      showLinksForQuery(snippet||lastExtractedText);
      setStatus('math answer (local)'); setProgress(100);
      advancedNotes.textContent = 'Local solver used. You can also run Gomega Intelligence for steps.';
      return;
    }
  }

  // Gomega Intelligence call
  setStatus('asking Gomega Intelligence'); setProgress(76);
  const modelName = modelSel.value;
  const style = 'concise'; // keep concise in UI; change to 'full' if you want steps by default
  const ai = await gomegaAsk({
    modelName,
    text: lastExtractedText || snippet || 'Solve:',
    imageBlob: (modelName==='gomega-vision' || data.kind==='image') ? data.blob : null,
    style
  });

  setProgress(88);
  const answers = ai.answers || ai.items || ai.result || [];

  if(!forFill || data.kind!=='pdf'){
    const out = Array.isArray(answers) ? answers : [answers];
    const html = out.map((a,i)=> {
      const q = a.question ? `<div style="color:#9cc5ff;margin-bottom:4px"><strong>Q${a.number||i+1}.</strong> ${escapeHtml(a.question||'')}</div>` : '';
      const steps = a.steps ? `<details style="margin-top:6px"><summary>Steps (BETA)</summary><pre style="white-space:pre-wrap">${escapeHtml(a.steps)}</pre></details>` : '';
      return `<div style="padding:10px;border:1px solid rgba(255,255,255,.06);border-radius:10px;margin-bottom:10px">
        ${q}
        <div><strong>Answer:</strong> ${escapeHtml(a.answer || JSON.stringify(a))}</div>
        ${steps}
      </div>`;
    }).join('');
    solutionEl.innerHTML = html || `<pre>${escapeHtml(JSON.stringify(ai,null,2))}</pre>`;
    showLinksForQuery(snippet || lastExtractedText);
    setStatus('answers ready'); setProgress(100);
    advancedNotes.textContent = 'Returned by Gomega Intelligence (BETA).';
    return;
  }

  // Fill PDF mode
  setStatus('building answered PDF'); setProgress(92);
  const pdfBytes = await file.arrayBuffer();
  const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes, { updateMetadata: false });
  const form = pdfDoc.getForm ? pdfDoc.getForm() : null;

  const normalizedAnswers = (Array.isArray(answers)?answers:[answers]).map((a,i)=>({
    num: a.number || (i+1).toString(),
    question: a.question || '',
    answer: (typeof a.answer==='string'? a.answer : JSON.stringify(a.answer||a)),
    steps: a.steps || ''
  }));

  let filled = false;
  try{
    if(form){
      const fields = form.getFields().map(f => f.getName());
      normalizedAnswers.forEach(a=>{
        const key = (fields.find(n => n.toLowerCase().includes(('q'+a.num).toLowerCase())) || '').toString();
        if(key){
          try{ form.getTextField(key).setText(a.answer); filled = true; }catch(e){}
        }
      });
    }
  }catch(e){ /* ignore */ }

  if(!filled){
    let page = pdfDoc.addPage();
    const title = 'Gomega Intelligence — Answer Sheet (BETA)';
    let { width, height } = page.getSize();
    const margin = 40;
    const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
    page.drawText(title, { x: margin, y: height - margin - 10, size: 18, font, color: PDFLib.rgb(0.6,0.85,1) });

    let y = height - margin - 34;
    function drawWrapped(pg, text, x, y, maxWidth, size, color){
      const words = String(text).split(/\s+/);
      let line = '';
      const lineHeight = size + 4;
      words.forEach((w, idx)=>{
        const test = (line ? line + ' ' : '') + w;
        const wpx = font.widthOfTextAtSize(test, size);
        if(wpx > maxWidth && line){
          pg.drawText(line, {x, y, size, font, color}); y -= lineHeight; line = w;
        }else{ line = test; }
        if(idx === words.length-1){ pg.drawText(line, {x, y, size, font, color}); y -= lineHeight; }
      });
      return y;
    }

    for(const a of normalizedAnswers){
      const qline = (a.question ? `Q${a.num}. ${a.question}` : `Q${a.num}`);
      y = drawWrapped(page, qline, margin, y, width - margin*2, 12, PDFLib.rgb(0.7,0.9,1)); y -= 6;
      y = drawWrapped(page, `Answer: ${a.answer}`, margin+12, y, width - margin*2-12, 12, PDFLib.rgb(0.9,1,0.9));
      if(a.steps){ y -= 4; y = drawWrapped(page, `Steps: ${a.steps}`, margin+12, y, width - margin*2-12, 11.5, PDFLib.rgb(0.85,0.92,1)); }
      y -= 10;
      if(y < 80){
        page.drawText('— continued on next page —', { x: margin, y: 30, size: 10, font, color: PDFLib.rgb(.7,.7,.8)});
        page = pdfDoc.addPage(); ({ width, height } = page.getSize());
        page.drawText(title+' (cont.)', { x: margin, y: height-40, size: 14, font, color: PDFLib.rgb(0.6,0.85,1) });
        y = height-62;
      }
    }
  }

  const outBytes = await pdfDoc.save();
  const blob = new Blob([outBytes], {type:'application/pdf'});
  const url = URL.createObjectURL(blob);
  pdfOut.innerHTML = `<a class="pill" href="${url}" download="answers.pdf">Download answered PDF</a>`;
  setStatus(filled ? 'PDF form filled' : 'Answer Sheet added'); setProgress(100);
  advancedNotes.textContent = 'Gomega Intelligence (BETA).';
}

/* ===== Buttons & events ===== */
btnProcess.addEventListener('click', async ()=>{
  const f = filein.files?.[0];
  if(!f) return alert('Choose a file first.');
  try{
    const fill = (modeSel.value === 'fillpdf');
    await processFile(f, {smart:false, forFill:fill});
  }catch(e){ setStatus('error'); setProgress(0); solutionEl.innerHTML = `<div style="color:#ff9b9b">Error: ${escapeHtml(e.message||e)}</div>`; }
});

btnFill.addEventListener('click', async ()=>{
  const f = filein.files?.[0];
  if(!f) return alert('Upload a PDF to fill.');
  if(!/\.pdf$/i.test(f.name||'') && f.type!=='application/pdf') return alert('Please select a PDF file.');
  try{ await processFile(f, {smart:true, forFill:true}); }catch(e){
    setStatus('error'); setProgress(0);
    pdfOut.innerHTML = `<div style="color:#ff9b9b">Error: ${escapeHtml(e.message||e)}</div>`;
  }
});

btnClear.addEventListener('click', ()=>{
  filein.value=''; extractedEl.textContent=''; solutionEl.innerHTML=''; linksEl.innerHTML='';
  pdfOut.innerHTML=''; setStatus('idle'); setProgress(0); advancedNotes.textContent='';
});

btnUseCamera.addEventListener('click', ()=>{
  const input = document.createElement('input');
  input.type='file'; input.accept='image/*'; input.capture='environment';
  input.onchange=()=>{ if(input.files?.[0]){ filein.files = input.files; } };
  input.click();
});

dropzone.addEventListener('dragover', e=>{ e.preventDefault(); dropzone.classList.add('drag'); });
dropzone.addEventListener('dragleave', ()=> dropzone.classList.remove('drag'));
dropzone.addEventListener('drop', e=>{
  e.preventDefault(); dropzone.classList.remove('drag');
  if(e.dataTransfer.files && e.dataTransfer.files[0]) filein.files = e.dataTransfer.files;
});

window.addEventListener('paste', e=>{
  const items = (e.clipboardData||window.clipboardData).items || [];
  for(const it of items){
    if(it.type && it.type.indexOf('image') !== -1){
      const file = it.getAsFile();
      const dt = new DataTransfer(); dt.items.add(file); filein.files = dt.files;
      break;
    }
  }
});

/* Assist */
const btnSolveSmarter = document.getElementById('btnSolveSmarter');
const btnLookDeeper = document.getElementById('btnLookDeeper');
btnSolveSmarter.addEventListener('click', async ()=>{
  const c = loadCounts();
  if((c.solveSmarter||0) >= MAX_USES_PER_DAY) return alert(`"Solve Smarter" limit reached for today (${MAX_USES_PER_DAY}).`);
  const f = filein.files?.[0]; if(!f) return alert('Upload a file first.');
  c.solveSmarter = (c.solveSmarter||0)+1; saveCounts(c); updatePill();
  await processFile(f, {smart:true, forFill:false});
});
btnLookDeeper.addEventListener('click', async ()=>{
  const c = loadCounts();
  if((c.lookDeeper||0) >= MAX_USES_PER_DAY) return alert(`"Look Deeper" limit reached for today (${MAX_USES_PER_DAY}).`);
  const f = filein.files?.[0]; if(!f) return alert('Upload a file first.');
  c.lookDeeper = (c.lookDeeper||0)+1; saveCounts(c); updatePill();
  await processFile(f, {smart:false, forFill:false});
  const q = encodeURIComponent(extractQuestionSnippet(lastExtractedText) || lastExtractedText || 'homework question');
  [
    {title:'Google', url:`https://www.google.com/search?q=${q}`},
    {title:'WolframAlpha', url:`https://www.wolframalpha.com/input?i=${q}`},
    {title:'YouTube', url:`https://www.youtube.com/results?search_query=${q}`},
    {title:'Scholar', url:`https://scholar.google.com/scholar?q=${q}`}
  ].forEach(l=>{
    const a = document.createElement('a'); a.href=l.url; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent=l.title; linksEl.appendChild(a);
  });
});

/* Feedback */
const btnRight = document.getElementById('btnRight');
const btnWrong = document.getElementById('btnWrong');
const feedbackNote = document.getElementById('feedbackNote');
btnRight.addEventListener('click', ()=>{
  const c = loadCounts(); c.feedbacks.push({time:new Date().toISOString(), verdict:'right', snippet: lastExtractedText.slice(0,400)});
  saveCounts(c); feedbackNote.textContent='Thanks — saved locally.';
});
btnWrong.addEventListener('click', ()=>{
  const c = loadCounts(); c.feedbacks.push({time:new Date().toISOString(), verdict:'wrong', snippet: lastExtractedText.slice(0,400)});
  saveCounts(c); feedbackNote.textContent='Thanks — saved locally.';
});

/* Init */
updatePill(); setProgress(0); setStatus('idle');
</script>
</body>
</html>