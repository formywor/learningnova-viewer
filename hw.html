<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gomega Intelligence — HW Helper (BETA)</title>

<style>
  :root{
    --bg:#070f1a; --bg2:#0b1423; --card:#0b1220; --glass:rgba(255,255,255,.06);
    --accent:#7dd3fc; --accent2:#34d399; --muted:#9aa6b2; --ink:#e6eef6; --ring:rgba(125,211,252,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  body{
    color:var(--ink);
    background:
      radial-gradient(1200px 600px at 8% 2%, rgba(56,189,248,.18), transparent 60%),
      radial-gradient(900px 400px at 96% 8%, rgba(52,211,153,.14), transparent 60%),
      linear-gradient(180deg,#06101b 0%, #070e18 100%);
    padding:28px; display:flex; align-items:center; justify-content:center;
  }
  .wrap{width:100%;max-width:1100px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  .brand{display:flex;align-items:center;gap:14px}
  .logo{width:42px;height:42px;border-radius:12px;background:conic-gradient(from 160deg,#38bdf8,#22c55e,#8b5cf6,#38bdf8)}
  h1{margin:0;font-size:20px;letter-spacing:.2px}
  .beta{background:linear-gradient(90deg,#ffb86b,#ff7b7b);padding:6px 10px;border-radius:999px;font-weight:700;color:#111;margin-left:8px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.06);border-radius:14px;box-shadow:0 12px 40px rgba(2,6,23,.55)}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .panel{padding:16px}
  .section{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:12px;padding:12px}
  .section + .section{margin-top:12px}
  label.small{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="text"], input[type="password"], select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
    background:rgba(10,18,32,.6); color:var(--ink); outline:none;
  }
  input:focus, select:focus{ box-shadow:0 0 0 3px var(--ring); border-color:transparent }
  .keyline{display:flex;gap:8px}
  .keyline input{flex:1}
  .muted{color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{
    background:linear-gradient(180deg,#0b1b2a,#071026);
    border:1px solid rgba(255,255,255,.06); color:#e6eef6; padding:10px 12px; border-radius:10px; cursor:pointer;
    transition:.2s transform ease,.2s background ease;
  }
  button:hover{transform:translateY(-1px)}
  button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#052123;font-weight:800;border:none}
  .drop{border:2px dashed rgba(255,255,255,.07); padding:14px; border-radius:12px; text-align:center; color:var(--muted)}
  .drop.drag{ border-color:#22c55e; background:rgba(34,197,94,.05) }

  .result{padding:16px}
  .toprow{display:flex;justify-content:space-between;align-items:center}
  .status{font-size:13px;color:var(--muted)}
  .progress{height:8px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden}
  .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#6ee7b7)}
  .answer{padding:12px;border-radius:12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06)}
  .links a{color:var(--accent);text-decoration:none;display:inline-block;margin:6px 8px 0 0}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);font-weight:600}
  footer{margin-top:10px;color:var(--muted);font-size:12.5px}
  .toast{position:fixed;right:18px;bottom:18px;background:rgba(14,23,38,.9);border:1px solid rgba(255,255,255,.08);padding:12px 14px;border-radius:12px;font-size:13px;color:#e6eef6;box-shadow:0 10px 32px rgba(0,0,0,.45);opacity:0;transform:translateY(8px);pointer-events:none;transition:.22s}
  .toast.show{opacity:1;transform:translateY(0);pointer-events:auto}
  .badge{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;background:rgba(125,211,252,.18);border:1px solid rgba(125,211,252,.35);color:#9de1ff;margin-left:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Gomega Intelligence — HW Helper <span class="beta">BETA</span></h1>
        <div class="muted">Gomega Models are in <strong>BETA</strong>: each is tuned for one topic. “Vision” solves questions from images.</div>
      </div>
    </div>
    <div class="pill" id="counterPill">SS: 5 • LD: 5</div>
  </header>

  <div class="card grid" role="main">
    <!-- Left -->
    <div class="panel">
      <!-- Public key (site-wide) + user override -->
      <div class="section">
        <label class="small">Site API Key (for everyone) — commas are ignored</label>
        <div class="keyline">
          <input id="siteKeyInput" type="password" placeholder="SITE sk-..." autocomplete="off" spellcheck="false">
          <button id="saveSiteKeyBtn">Save Site Key</button>
        </div>
        <div class="muted" style="margin-top:6px">Used by all users if they don’t provide their own. Stored locally in this browser.</div>
      </div>

      <div class="section">
        <label class="small">My API Key (optional, overrides Site Key)</label>
        <div class="keyline">
          <input id="userKeyInput" type="password" placeholder="sk-..." autocomplete="off" spellcheck="false">
          <button id="saveUserKeyBtn">Save My Key</button>
        </div>
        <div class="muted" style="margin-top:6px">Only used on this device. We’ll strip any random commas you add.</div>
      </div>

      <div class="section">
        <div class="controls" style="gap:10px;align-items:flex-end;flex-wrap:wrap">
          <div style="flex:1;min-width:200px">
            <label class="small">Gomega Model (BETA)</label>
            <select id="modelSel">
              <option value="gomega-v3">gomega-v3 — STEM word-problems</option>
              <option value="gomega-v3-turbo">gomega-v3-turbo — Fast general HW</option>
              <option value="gomega-v2">gomega-v2 — Reading/Writing/Humanities</option>
              <option value="gomega-v1">gomega-v1 — Math & Algebra</option>
              <option value="gomega-vision">gomega-vision — Image question solver</option>
            </select>
          </div>
          <div style="flex:1;min-width:200px">
            <label class="small">Answer Style</label>
            <select id="styleSel">
              <option value="concise">Concise answers</option>
              <option value="full">Show steps & reasoning</option>
            </select>
          </div>
          <div style="flex:1;min-width:200px">
            <label class="small">Mode</label>
            <select id="modeSel">
              <option value="answers">Answers only (on-page)</option>
              <option value="fillpdf">Fill PDF or add Answer Sheet</option>
            </select>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="drop" id="dropzone">
          <div style="font-weight:700;margin-bottom:6px">Upload or take a photo</div>
          <div class="muted">Images (jpg, png, webp), PDF, .txt, .docx. Paste images or drag & drop.</div>
          <input id="filein" type="file" accept="image/*,application/pdf,text/plain,application/vnd.openxmlformats-officedocument.wordprocessingml.document" style="margin-top:10px"/>
          <div class="controls" style="margin-top:10px">
            <button id="btnUseCamera">Take Photo</button>
            <button id="btnProcess" class="primary">Process & Solve</button>
            <button id="btnFill" title="Return a filled/annotated PDF">Fill PDF</button>
            <button id="btnClear">Clear</button>
          </div>
          <div class="muted" style="margin-top:6px">Privacy: Files stay in your browser, except calls you choose to make to Gomega Intelligence (via OpenAI).</div>
        </div>
      </div>

      <div class="section">
        <strong>Assist</strong>
        <div class="muted" style="margin:4px 0 8px">“Solve Smarter” = aggressive math & parsing. “Look Deeper” = extra search links.</div>
        <div class="controls">
          <button id="btnSolveSmarter">Solve Smarter</button>
          <button id="btnLookDeeper">Look Deeper</button>
        </div>
      </div>

      <div class="section">
        <strong>Feedback</strong>
        <div class="controls" style="margin-top:8px">
          <button id="btnRight">Answer was right</button>
          <button id="btnWrong">Answer was wrong</button>
        </div>
        <div id="feedbackNote" class="muted" style="margin-top:6px"></div>
      </div>
    </div>

    <!-- Right -->
    <div class="result">
      <div class="toprow">
        <div><strong>Answer preview</strong> <span class="badge">Gomega Models — BETA</span></div>
        <div class="status">Status: <span id="status">idle</span></div>
      </div>

      <div style="margin-top:10px" class="progress" aria-hidden><i id="progBar"></i></div>

      <div style="margin-top:12px">
        <div id="extracted" style="white-space:pre-wrap;color:#cfe7e0;font-size:13.5px"></div>
      </div>

      <div id="solution" class="answer" style="margin-top:12px"></div>

      <div style="margin-top:12px">
        <strong>Source links</strong>
        <div id="links" class="links"></div>
      </div>

      <div id="advancedNotes" class="muted" style="margin-top:10px"></div>
      <div id="pdfOut" style="margin-top:14px"></div>

      <footer>Gomega Models are experimental (BETA). Best with clear photos and one question per upload.</footer>
    </div>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/algebrite/1.5.0/algebrite.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<script>
/* ================== Keys & Model Map (BETA) ================== */
/* Put your site-wide OpenAI key here (everyone can use it).
   We will also strip commas automatically. */
const SITE_KEY_STORAGE = 'gomega-hw-site-key';
const USER_KEY_STORAGE = 'gomega-hw-user-key';
const MODEL_STORAGE = 'gomega-hw-model';
const STYLE_STORAGE = 'gomega-hw-style';
const COUNTS_STORAGE = 'hw-helper-counts-v1';
const MAX_USES_PER_DAY = 5;

function stripCommas(s){ return (s||'').replace(/,/g,'').trim(); }

const GOMEGA_MODELS = {
  // Each Gomega model maps to an underlying OpenAI model + a specialization prompt
  'gomega-v1': { openai:'gpt-4o-mini', temp:0.2, system: [
      'You are Gomega v1 — a Math & Algebra specialist.',
      'Focus on equations, algebraic manipulation, factorization, linear/quadratic systems, and step clarity.',
      'Prefer exact forms (fractions, radicals) unless user asks decimals.'
    ].join(' ')
  },
  'gomega-v2': { openai:'gpt-4o-mini', temp:0.4, system: [
      'You are Gomega v2 — Reading/Writing/Humanities specialist.',
      'Summarize, analyze passages, explain literary devices, craft concise explanations with citations when asked.',
      'Prefer short, clear paragraphs and bullet points.'
    ].join(' ')
  },
  'gomega-v3': { openai:'gpt-4o', temp:0.25, system: [
      'You are Gomega v3 — STEM word-problem solver.',
      'Extract variables, set up equations, show key steps, check units, and provide a final boxed answer.',
      'Be concise; show steps if requested.'
    ].join(' ')
  },
  'gomega-v3-turbo': { openai:'gpt-4o-mini', temp:0.25, system: [
      'You are Gomega v3-turbo — fast general homework solver.',
      'Balance speed and accuracy; be concise; list assumptions explicitly when needed.'
    ].join(' ')
  },
  'gomega-vision': { openai:'gpt-4o-mini', temp:0.2, vision:true, system: [
      'You are Gomega Vision — solve questions from images of worksheets, diagrams, and problems.',
      'Read the image carefully; OCR and reason; return clean answers. Include steps if asked.'
    ].join(' ')
  }
};

/* ================== UI state & helpers ================== */
function todayKey(){ return new Date().toISOString().slice(0,10); }
function loadCounts(){
  const raw = JSON.parse(localStorage.getItem(COUNTS_STORAGE) || '{}');
  const k = todayKey();
  if(raw.date !== k){ Object.assign(raw, {date:k, solveSmarter:0, lookDeeper:0, feedbacks:[]}); }
  localStorage.setItem(COUNTS_STORAGE, JSON.stringify(raw));
  return raw;
}
function saveCounts(o){ localStorage.setItem(COUNTS_STORAGE, JSON.stringify(o)); updatePill(); }
function updatePill(){
  const c = loadCounts();
  const ss = Math.max(0, MAX_USES_PER_DAY - (c.solveSmarter||0));
  const ld = Math.max(0, MAX_USES_PER_DAY - (c.lookDeeper||0));
  document.getElementById('counterPill').textContent = `SS: ${ss} • LD: ${ld}`;
}
function setStatus(s){ document.getElementById('status').textContent = s; }
function setProgress(p){ document.getElementById('progBar').style.width = Math.max(0,Math.min(100,p)) + '%'; }
function toast(msg, timeout=2200){
  let t = document.querySelector('.toast');
  if(!t){ t = document.createElement('div'); t.className='toast'; document.body.appendChild(t); }
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), timeout);
}
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' })[c]); }

/* ================== Persisted controls ================== */
const siteKeyInput = document.getElementById('siteKeyInput');
const userKeyInput = document.getElementById('userKeyInput');
const saveSiteKeyBtn = document.getElementById('saveSiteKeyBtn');
const saveUserKeyBtn = document.getElementById('saveUserKeyBtn');
const modelSel = document.getElementById('modelSel');
const styleSel = document.getElementById('styleSel');
const modeSel = document.getElementById('modeSel');

(function initPersistent(){
  try{
    siteKeyInput.value = localStorage.getItem(SITE_KEY_STORAGE) ? '••••••••' : '';
    userKeyInput.value = localStorage.getItem(USER_KEY_STORAGE) ? '••••••••' : '';
    modelSel.value = localStorage.getItem(MODEL_STORAGE) || 'gomega-v3';
    styleSel.value = localStorage.getItem(STYLE_STORAGE) || 'concise';
  }catch(e){}
})();
saveSiteKeyBtn.addEventListener('click', ()=>{
  const raw = prompt('Paste the SITE OpenAI key (visible to everyone on this device). Commas will be ignored:', '');
  if(!raw) return;
  localStorage.setItem(SITE_KEY_STORAGE, stripCommas(raw));
  siteKeyInput.value = '••••••••';
  toast('Site key saved.');
});
saveUserKeyBtn.addEventListener('click', ()=>{
  const raw = prompt('Paste YOUR OpenAI key (overrides Site Key). Commas will be ignored:', '');
  if(!raw) return;
  localStorage.setItem(USER_KEY_STORAGE, stripCommas(raw));
  userKeyInput.value = '••••••••';
  toast('Your key saved.');
});
modelSel.addEventListener('change', ()=> localStorage.setItem(MODEL_STORAGE, modelSel.value));
styleSel.addEventListener('change', ()=> localStorage.setItem(STYLE_STORAGE, styleSel.value));

function getActiveKey(){
  const user = stripCommas(localStorage.getItem(USER_KEY_STORAGE) || '');
  const site = stripCommas(localStorage.getItem(SITE_KEY_STORAGE) || '');
  return user || site || '';
}

/* ================== File handling (same as before) ================== */
const filein = document.getElementById('filein');
const btnProcess = document.getElementById('btnProcess');
const btnFill = document.getElementById('btnFill');
const btnClear = document.getElementById('btnClear');
const btnUseCamera = document.getElementById('btnUseCamera');
const dropzone = document.getElementById('dropzone');
const extractedEl = document.getElementById('extracted');
const solutionEl = document.getElementById('solution');
const linksEl = document.getElementById('links');
const advancedNotes = document.getElementById('advancedNotes');
const pdfOut = document.getElementById('pdfOut');

function validateFile(file){
  const badExt = ['exe','bat','cmd','sh','js','msi'];
  const name = (file.name || '').toLowerCase();
  const ext = name.split('.').pop();
  if(badExt.includes(ext)) return `Files with .${ext} are not allowed.`;
  return null;
}

async function extractTextFromPDF(blob){
  const arrayBuf = await blob.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:arrayBuf}).promise;
  let full = '';
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const txt = await page.getTextContent({normalizeWhitespace:true});
    const pageText = txt.items.map(i => i.str).join(' ');
    full += pageText + '\n\n';
  }
  return full.trim();
}
async function extractTextFromDOCX(arrayBuffer){
  const result = await mammoth.extractRawText({arrayBuffer});
  return (result.value || '').trim();
}
async function ocrImage(blob, onProgress){
  return new Promise((resolve, reject) => {
    const worker = Tesseract.createWorker({ logger: m => {
      if(m.status === 'recognizing text' && onProgress) onProgress(Math.round(m.progress*100));
    }});
    (async () => {
      await worker.load(); await worker.loadLanguage('eng'); await worker.initialize('eng');
      const { data:{ text } } = await worker.recognize(blob);
      await worker.terminate(); resolve(text || '');
    })().catch(reject);
  });
}
async function readFile(file){
  const v = validateFile(file); if(v) throw new Error(v);
  if(file.type.startsWith('image/') || /\.(png|jpe?g|webp|gif)$/i.test(file.name||'')) return { kind:'image', blob:file };
  if(file.type==='application/pdf' || /\.pdf$/i.test(file.name||'')) return { kind:'pdf', blob:file };
  if(file.type==='text/plain' || /\.txt$/i.test(file.name||'')) return { kind:'text', text:await file.text() };
  if(file.type==='application/vnd.openxmlformats-officedocument.wordprocessingml.document' || /\.docx$/i.test(file.name||'')) return { kind:'docx', buffer:await file.arrayBuffer() };
  try{ return { kind:'text', text:await file.text() }; }catch(e){ throw new Error('Unsupported file type.'); }
}

function extractQuestionSnippet(text){
  if(!text) return '';
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  for(const ln of lines){ if(ln.endsWith('?')) return ln; }
  for(const ln of lines){ if(/\b(solve|find|what is|calculate|integrate|differentiate|explain)\b/i.test(ln)) return ln; }
  return lines.slice(0,6).join(' ').slice(0,800);
}
function isMathQuestion(text){
  const s=(text||'').toLowerCase();
  const kws=['solve','integrate','differentiate','derivative','integral','limit','sqrt','sin(','cos(','tan(','^','x','y','='];
  return kws.some(k=>s.includes(k)) || /[0-9]+\s*[\+\-\*\/\^]\s*[0-9]+/.test(s);
}
function buildSearchLinks(query){
  const q = encodeURIComponent(query||'homework question');
  return [
    {title:'Google', url:`https://www.google.com/search?q=${q}`},
    {title:'WolframAlpha', url:`https://www.wolframalpha.com/input?i=${q}`},
    {title:'YouTube', url:`https://www.youtube.com/results?search_query=${q}`},
    {title:'Scholar', url:`https://scholar.google.com/scholar?q=${q}`}
  ];
}
function showLinksForQuery(query){
  linksEl.innerHTML='';
  buildSearchLinks(query).forEach(l=>{
    const a = document.createElement('a'); a.href=l.url; a.target='_blank'; a.rel='noopener noreferrer'; a.textContent=l.title;
    linksEl.appendChild(a);
  });
}
function trySolveMath(text){
  try{
    const snippet=text.replace(/\r?\n/g,' ').trim();
    if(/\bsolve\b/i.test(snippet)){
      const m=snippet.match(/solve\s+(.+?)(?:\s+for\s+([a-zA-Z]\w*))?$/i);
      if(m){ return Algebrite.run(`roots(${m[1].trim()})`); }
    }
    if(snippet.includes('=')){
      let normalized=snippet.replace(/([0-9])([a-zA-Z])/g,'$1*$2').replace(/([a-zA-Z])([0-9])/g,'$1*$2');
      const v=(normalized.match(/([a-zA-Z])\b/)||[])[1]||'x';
      try{return Algebrite.run(`roots(${normalized})`);}catch(e){}
      try{return Algebrite.run(`solve(${normalized}, ${v})`);}catch(e2){}
      try{return String(math.evaluate(normalized));}catch(e3){}
    }
    try{return String(math.evaluate(snippet));}catch(e){}
  }catch(e){ return null; }
  return null;
}

/* ================== Gomega Intelligence (uses OpenAI endpoint) ================== */
async function gomegaAsk({modelKey, text, imageBlob, style}){
  const key = getActiveKey();
  if(!key) throw new Error('No API key found. Save a Site Key or Your Key first.');
  const spec = GOMEGA_MODELS[modelKey] || GOMEGA_MODELS['gomega-v3'];
  const wantSteps = (style === 'full');

  const messages = [
    {role:'system', content: spec.system + ' Always return JSON with an "answers" array of {number?:string, question?:string, answer:string, steps?:string}.'},
    {role:'user', content: buildUserContent(text, imageBlob, !!spec.vision) }
  ];

  const body = {
    model: spec.openai,
    temperature: spec.temp,
    response_format: { type: "json_object" },
    messages,
    max_tokens: 1500
  };

  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const t = await res.text().catch(()=>res.statusText);
    throw new Error('OpenAI error: ' + t);
  }
  const data = await res.json();
  let content = data?.choices?.[0]?.message?.content || '{}';
  try{ return JSON.parse(content); }catch(e){ return {answers:[{answer: content}]} }
}

function buildUserContent(text, imageBlob, wantsVision){
  const parts=[];
  if(text) parts.push({type:'text', text});
  if(wantsVision){
    if(imageBlob){
      // inline base64 data URL
      parts.push({type:'image_url', image_url:{url:'data:'+imageBlob.type+';base64,'+window.btoa(String.fromCharCode(...new Uint8Array(window.__tmp_last_img || []))) }});
    }else{
      parts.push({type:'text', text:'If the user provided an image, solve from it. If no image detected, work from the extracted text.'});
    }
  }
  return parts.length ? parts : [{type:'text', text: text || 'Solve:'}];
}

/* helper to cache last image bytes for dataURL */
async function blobToArrayBuffer(blob){ return await blob.arrayBuffer(); }

/* ================== Main processing ================== */
let lastExtractedText='';
async function processFile(file, {smart=false, forFill=false}={}){
  setStatus('processing'); setProgress(6);
  solutionEl.innerHTML=''; linksEl.innerHTML=''; advancedNotes.textContent=''; pdfOut.innerHTML=''; extractedEl.textContent='';

  const data = await readFile(file);
  setProgress(14);
  let fullText='';

  if(data.kind==='image'){
    setStatus('OCR on image');
    const ab = await blobToArrayBuffer(data.blob);
    window.__tmp_last_img = new Uint8Array(ab); // for dataURL encode
    fullText = await ocrImage(data.blob, p=>setProgress(14 + p*0.6));
  }else if(data.kind==='pdf'){
    setStatus('Extracting PDF text'); fullText = await extractTextFromPDF(data.blob); setProgress(45);
  }else if(data.kind==='docx'){
    setStatus('Extracting DOCX text'); fullText = await extractTextFromDOCX(data.buffer); setProgress(40);
  }else if(data.kind==='text'){
    fullText = data.text || ''; setProgress(38);
  }

  lastExtractedText = (fullText||'').trim();
  extractedEl.textContent = lastExtractedText || '[no readable text found]';
  const snippet = extractQuestionSnippet(lastExtractedText); setProgress(58);

  // quick local math
  if(!forFill && isMathQuestion(lastExtractedText || snippet)){
    setStatus('local math attempt');
    let sol = trySolveMath(snippet || lastExtractedText);
    setProgress(72);
    if(!sol && smart){
      const alt = (snippet || lastExtractedText).replace(/=/g,'==');
      try{ sol = trySolveMath(alt); }catch(e){}
    }
    if(sol){
      solutionEl.innerHTML = `<pre style="white-space:pre-wrap">${escapeHtml(String(sol))}</pre>`;
      showLinksForQuery(snippet||lastExtractedText);
      setStatus('math answer (local)'); setProgress(100);
      advancedNotes.textContent = 'Local solver used. You can also run Gomega Models (BETA) for steps/explanations.';
      return;
    }
  }

  // Gomega models (BETA)
  setStatus('asking Gomega model'); setProgress(76);
  const modelKey = modelSel.value;
  const style = styleSel.value;
  const ai = await gomegaAsk({
    modelKey,
    text: lastExtractedText || snippet || 'Solve:',
    imageBlob: (modelKey==='gomega-vision' ? (data.kind==='image' ? data.blob : null) : null),
    style
  });

  setProgress(88);
  const answers = ai.answers || [];
  if(!forFill || data.kind!=='pdf'){
    const out = Array.isArray(answers) ? answers : [answers];
    const html = out.map((a,i)=> {
      const q = a.question ? `<div style="color:#9cc5ff;margin-bottom:4px"><strong>Q${a.number||i+1}.</strong> ${escapeHtml(a.question||'')}</div>` : '';
      const steps = a.steps && style==='full' ? `<details style="margin-top:6px"><summary>Steps</summary><pre style="white-space:pre-wrap">${escapeHtml(a.steps)}</pre></details>` : '';
      return `<div style="padding:10px;border:1px solid rgba(255,255,255,.06);border-radius:10px;margin-bottom:10px">
        ${q}
        <div><strong>Answer:</strong> ${escapeHtml(a.answer || JSON.stringify(a))}</div>
        ${steps}
      </div>`;
    }).join('');
    solutionEl.innerHTML = html || `<pre>${escapeHtml(JSON.stringify(ai,null,2))}</pre>`;
    showLinksForQuery(snippet || lastExtractedText);
    setStatus('answers ready'); setProgress(100);
    advancedNotes.textContent = 'Answered by Gomega Models (BETA).';
    return;
  }

  // Fill PDF path
  setStatus('building answered PDF'); setProgress(92);
  const pdfBytes = await file.arrayBuffer();
  const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes, { updateMetadata:false });
  const form = pdfDoc.getForm ? pdfDoc.getForm() : null;

  const normalized = (Array.isArray(answers)?answers:[answers]).map((a,i)=>({
    num: a.number || (i+1).toString(),
    question: a.question || '',
    answer: (typeof a.answer==='string'? a.answer : JSON.stringify(a.answer||a)),
    steps: a.steps || ''
  }));

  let filled=false;
  try{
    if(form){
      const fields = form.getFields().map(f=>f.getName());
      normalized.forEach(a=>{
        const key = (fields.find(n=> n.toLowerCase().includes(('q'+a.num).toLowerCase())) || '').toString();
        if(key){
          try{ form.getTextField(key).setText(a.answer); filled=true; }catch(e){}
        }
      });
    }
  }catch(e){}

  if(!filled){
    let page = pdfDoc.addPage();
    const { width, height } = page.getSize();
    const margin = 40;
    const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
    const title = 'Gomega Intelligence — Answer Sheet (BETA)';
    page.drawText(title, { x: margin, y: height - margin - 10, size: 18, font, color: PDFLib.rgb(0.6,0.85,1) });
    let y = height - margin - 34;

    function drawWrapped(page, font, text, x, y, maxWidth, size, color){
      const words = String(text).split(/\s+/); let line=''; const lh=size+4;
      for(let i=0;i<words.length;i++){
        const test=(line?line+' ':'')+words[i];
        const w = font.widthOfTextAtSize(test, size);
        if(w>maxWidth && line){ page.drawText(line,{x,y,size,font,color}); y-=lh; line=words[i]; }
        else line=test;
        if(i===words.length-1){ page.drawText(line,{x,y,size,font,color}); y-=lh; }
      }
      return y;
    }

    for(let a of normalized){
      const qline = (a.question ? `Q${a.num}. ${a.question}` : `Q${a.num}`);
      y = drawWrapped(page, font, qline, margin, y, width - margin*2, 12, PDFLib.rgb(0.7,0.9,1));
      y -= 6;
      y = drawWrapped(page, font, `Answer: ${a.answer}`, margin+12, y, width - margin*2-12, 12, PDFLib.rgb(0.9,1,0.9));
      if(a.steps){
        y -= 4;
        y = drawWrapped(page, font, `Steps: ${a.steps}`, margin+12, y, width - margin*2-12, 11.5, PDFLib.rgb(0.85,0.92,1));
      }
      y -= 10;
      if(y < 80){
        page.drawText('— continued —', { x: margin, y: 30, size: 10, font, color: PDFLib.rgb(.7,.7,.8)});
        page = pdfDoc.addPage();
        const sz = page.getSize(); y = sz.height - margin;
        page.drawText(title+' (cont.)', { x: margin, y: y, size: 14, font, color: PDFLib.rgb(0.6,0.85,1) });
        y -= 22;
      }
    }
  }

  const outBytes = await pdfDoc.save();
  const blob = new Blob([outBytes], {type:'application/pdf'});
  const url = URL.createObjectURL(blob);
  pdfOut.innerHTML = `<a class="pill" href="${url}" download="answers.pdf">Download answered PDF</a>`;
  setStatus(filled ? 'PDF form filled' : 'Answer Sheet added'); setProgress(100);
  advancedNotes.textContent = filled ? 'Filled matching AcroForm fields.' : 'No fillable fields detected — appended Answer Sheet.';
}

/* ================== Buttons & interactions ================== */
btnProcess.addEventListener('click', async ()=>{
  const f = filein.files?.[0];
  if(!f) return alert('Choose a file first.');
  try{
    const forFill = (modeSel.value === 'fillpdf');
    await processFile(f, {smart:false, forFill});
  }catch(e){ setStatus('error'); setProgress(0); solutionEl.innerHTML = `<div style="color:#ff9b9b">Error: ${escapeHtml(e.message||e)}</div>`; }
});
btnFill.addEventListener('click', async ()=>{
  const f = filein.files?.[0];
  if(!f) return alert('Upload a PDF to fill.');
  if(!/\.pdf$/i.test(f.name||'') && f.type!=='application/pdf') return alert('Please select a PDF file.');
  try{ await processFile(f, {smart:true, forFill:true}); }catch(e){
    setStatus('error'); setProgress(0);
    pdfOut.innerHTML = `<div style="color:#ff9b9b">Error: ${escapeHtml(e.message||e)}</div>`;
  }
});
btnClear.addEventListener('click', ()=>{
  filein.value=''; extractedEl.textContent=''; solutionEl.innerHTML=''; linksEl.innerHTML='';
  pdfOut.innerHTML=''; setStatus('idle'); setProgress(0); advancedNotes.textContent='';
});
btnUseCamera.addEventListener('click', ()=>{
  const input = document.createElement('input');
  input.type='file'; input.accept='image/*'; input.capture='environment';
  input.onchange=()=>{ if(input.files?.[0]){ filein.files = input.files; } };
  input.click();
});
dropzone.addEventListener('dragover', e=>{ e.preventDefault(); dropzone.classList.add('drag'); });
dropzone.addEventListener('dragleave', ()=> dropzone.classList.remove('drag'));
dropzone.addEvent