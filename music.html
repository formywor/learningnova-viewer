<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gomega Music — music.html</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#060e19; --bg2:#0a1526; --panel:#0f1b2f;
    --glass:rgba(255,255,255,.06); --ink:#eaf2fa; --muted:#9aa6b2;
    --accent:#34d3ff; --accent2:#7c3aed; --danger:#ef4444; --good:#22c55e; --ring:rgba(52,211,255,.45);
    --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif; color:var(--ink);
    background:
      radial-gradient(1200px 600px at 10% 0%, #0b1b33 0%, transparent 55%),
      radial-gradient(1200px 600px at 90% 10%, #0b162b 0%, transparent 55%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
    display:flex; flex-direction:column;
  }
  .tabs{display:flex; gap:8px; padding:12px 18px}
  .tab{padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.04); cursor:pointer}
  .tab.on{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#06101b; font-weight:700; border-color:transparent}
  .app{display:grid; grid-template-columns: 320px 1fr 380px; grid-template-rows: auto 1fr auto; grid-template-areas:
      "tabs tabs tabs" "side main settings" "player player player"; gap:16px; padding:0 18px 18px; height:100%;}
  .panel{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow)}
  .side{grid-area:side}
  .brand{padding:0; overflow:hidden}
  .coverHero{
    min-height:150px; position:relative; display:flex; align-items:flex-end; gap:12px;
    background:linear-gradient(135deg, rgba(52,211,255,.18), rgba(124,58,237,.18));
  }
  .coverHero img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:.33}
  .coverHero .scrim{position:absolute; inset:auto 0 0 0; height:60%; background:linear-gradient(180deg,transparent,rgba(0,0,0,.6))}
  .heroInner{position:relative; padding:16px}
  .heroTitle{margin:0; font-size:22px; letter-spacing:.3px; font-weight:800}
  .heroSubtitle{margin:2px 0 0; color:#b9c7da}

  .library{display:flex; flex-direction:column; gap:12px; padding:12px; max-height:calc(100vh - 360px); overflow:auto}
  .search{display:flex; gap:8px; padding:12px}
  .search input{flex:1; padding:12px 12px 12px 40px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:var(--ink); outline:none}
  .search .wrap{position:relative; flex:1}
  .search svg{position:absolute; top:10px; left:10px; opacity:.7}
  .track{display:grid; grid-template-columns: 44px 1fr auto; gap:12px; align-items:center; padding:8px; border-radius:12px; border:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.04)}
  .track:hover{background:rgba(255,255,255,.07)}
  .cover{width:44px; height:44px; border-radius:10px; background:linear-gradient(135deg,#18283f,#10233b); border:1px solid rgba(255,255,255,.12); overflow:hidden; position:relative}
  .cover span{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:10px; color:#9fb6cf}
  .meta{display:flex; flex-direction:column; min-width:0}
  .title{font-weight:600; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .artist{color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .badges{display:flex; gap:6px; align-items:center}
  .badge{font-size:10px; padding:3px 6px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); color:#c7d4e6}
  .explicit{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); color:#fecaca}

  .main{grid-area:main; display:grid; grid-template-rows:auto 1fr; gap:12px}
  .now{display:grid; grid-template-columns: 220px 1fr; gap:18px; padding:14px}
  .art{width:220px; height:220px; border-radius:20px; background:linear-gradient(135deg,#1e3a8a,#312e81); border:1px solid rgba(255,255,255,.12); box-shadow:var(--shadow); position:relative; overflow:hidden}
  .art img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:.95}
  .scrim{position:absolute; inset:auto 0 0 0; height:50%; background:linear-gradient(180deg,transparent,rgba(0,0,0,.5))}
  .songmeta{display:flex; flex-direction:column; gap:6px}
  .songtitle{font-size:22px; font-weight:800; letter-spacing:.3px; margin:0}
  .songartist{margin:0; color:var(--muted); font-weight:500}
  .lyrics{white-space:pre-wrap; line-height:1.6; font-size:14px; color:#cfe0f6; max-height:160px; overflow:auto; padding:10px; border-radius:12px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08)}
  .controls{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:14px}
  .ctrls{display:flex; justify-content:center; gap:10px; align-items:center}
  .btn{border:1px solid rgba(255,255,255,.1); background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)); color:var(--ink); padding:10px 12px; border-radius:12px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; box-shadow:0 1px 0 rgba(255,255,255,.05) inset, var(--shadow); transition:transform .1s ease, filter .2s ease, border-color .2s ease; user-select:none}
  .btn:hover{filter:brightness(1.05)} .btn:active{transform:scale(.98)}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2)); border-color:transparent; color:#041019; font-weight:700}
  .btn.ghost{background:transparent; border-color:rgba(255,255,255,.12)}
  .btn.toggle.on{outline:2px solid var(--ring)}
  .big{width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center}
  .seek{display:flex; align-items:center; gap:10px}
  .time{font-variant-numeric:tabular-nums; color:#b8c5d8; font-size:12px; min-width:48px; text-align:center}
  input[type="range"]{-webkit-appearance:none; appearance:none; height:6px; background:rgba(255,255,255,.15); border-radius:999px; outline:none}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none; appearance:none; width:16px; height:16px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent2)); border:2px solid #06101b; box-shadow:0 0 0 3px rgba(52,211,255,.25); cursor:pointer}

  .queue{padding:12px; display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto}
  .mini{display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px dashed rgba(255,255,255,.15); border-radius:10px; background:rgba(255,255,255,.03)}
  .mini .title{font-size:13px}

  .settings{grid-area:settings; display:flex; flex-direction:column; gap:12px; padding:14px}
  .row{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px; padding:8px 10px; border-radius:12px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08)}
  .row label{color:#c7d4e6; font-size:14px}
  .switch{position:relative; width:50px; height:28px; background:rgba(255,255,255,.15); border-radius:999px; cursor:pointer; border:1px solid rgba(255,255,255,.2)}
  .switch:before{content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent2)); transition:transform .2s ease}
  .switch.on{background:rgba(52,211,255,.25)} .switch.on:before{transform:translateX(22px)}
  .num{display:flex; align-items:center; gap:10px}
  .num input, .textish{width:100%; padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06); color:var(--ink)}
  .textish{min-height:120px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12.5px}
  .player{grid-area:player; display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px; padding:12px 14px}
  .player.panel{position:sticky; bottom:0}
  .toast{position:fixed; right:18px; bottom:90px; background:#0d1a2c; border:1px solid rgba(255,255,255,.15); padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); display:none}
  .kbd{padding:2px 6px; border-radius:6px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06); font-size:12px}
  .hint{font-size:12px; color:#9fb3ca} .danger{color:#fecaca}
  .hidden{display:none !important}
  canvas{width:100%; height:80px; border-radius:12px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06)}
  /* drag-drop */
  .dropMask{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); border:2px dashed rgba(255,255,255,.4); z-index:50}
  .dropMask.on{display:flex}
</style>
</head>
<body>
  <div class="tabs" role="tablist" aria-label="Sections">
    <button class="tab on" data-tab="library">Library</button>
    <button class="tab" data-tab="foryou">For You</button>
    <button class="tab" data-tab="now">Now Playing</button>
    <button class="tab" data-tab="settings">Settings</button>
  </div>

  <div class="app">
    <aside class="side">
      <section class="panel brand">
        <div class="coverHero">
          <img id="pageCover" alt="">
          <div class="scrim"></div>
          <div class="heroInner">
            <h1 class="heroTitle" id="pageTitle">Gomega Music</h1>
            <p class="heroSubtitle">Gomega Intelligence — Personalized Listening</p>
          </div>
        </div>
      </section>

      <div class="panel search">
        <div class="wrap">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="7"/><path d="m20 20-3.5-3.5"/></svg>
          <input id="search" placeholder="Search your library (title or artist)">
        </div>
        <button id="btnClearSearch" class="tab">Clear</button>
      </div>

      <div class="panel" style="padding:10px; display:flex; align-items:center; justify-content:space-between">
        <div class="badges" style="display:flex; gap:6px; align-items:center">
          <span class="badge" id="countBadge">0 tracks</span>
          <span class="badge" id="explicitBadge">Explicit Off</span>
        </div>
        <div class="hint">Tip: drag & drop files to add fast</div>
      </div>

      <div class="panel library section" id="section-library"></div>

      <div class="panel library section hidden" id="section-foryou" style="padding:12px">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px">
          <div class="badges">
            <span class="badge">Smart Mix</span>
            <span class="badge" id="fyCount">0</span>
          </div>
          <button class="btn primary" id="btnPlayForYou">Play For You</button>
        </div>
        <div id="forYouList" style="display:flex; flex-direction:column; gap:10px"></div>
      </div>

      <div class="panel library section hidden" id="section-now" style="padding:12px">
        <div class="hint">Use the controls in the center panel. Lyrics show below when available.</div>
      </div>
    </aside>

    <main class="main">
      <section class="panel now">
        <div class="art" id="art"><div class="scrim"></div></div>
        <div style="display:flex; flex-direction:column; gap:12px">
          <div class="songmeta">
            <h2 class="songtitle" id="songTitle">Nothing playing</h2>
            <p class="songartist" id="songArtist">Add music to begin</p>
          </div>
          <canvas id="viz" height="80"></canvas>

          <div class="controls">
            <div class="toggles" style="justify-content:flex-start; display:flex; gap:8px; align-items:center">
              <button class="btn toggle" id="btnLike" title="Like">❤</button>
              <button class="btn toggle" id="btnShuffle" title="Shuffle">Shuffle</button>
              <button class="btn toggle" id="btnRepeat" title="Repeat">Repeat</button>
              <span class="badge">Smart Mix</span>
              <button class="btn toggle on" id="btnSmart" title="Gomega Intelligence Smart Mix">On</button>
            </div>

            <div class="ctrls">
              <button class="btn big" id="btnPrev" title="Previous">⏮</button>
              <button class="btn big primary" id="btnPlay"><span id="plTxt">▶</span></button>
              <button class="btn big" id="btnNext" title="Next">⏭</button>
            </div>

            <div class="seek">
              <span class="time" id="curTime">0:00</span>
              <input id="seek" type="range" min="0" max="1000" value="0">
              <span class="time" id="dur">0:00</span>
            </div>
          </div>

          <details id="lyricsWrap" class="hidden">
            <summary class="btn ghost">Show Lyrics</summary>
            <div class="lyrics" id="lyrics"></div>
          </details>
        </div>
      </section>

      <section class="panel queue">
        <div style="display:flex; align-items:center; justify-content:space-between">
          <div class="badges">
            <span class="badge">Up Next</span>
            <span class="badge" id="queueBadge">0</span>
          </div>
          <div class="hint">Shortcuts: <span class="kbd">Space</span> play/pause • <span class="kbd">N</span>/<span class="kbd">P</span> next/prev • <span class="kbd">←/→</span> seek</div>
        </div>
        <div id="queueList"></div>
      </section>
    </main>

    <aside class="settings panel section hidden" id="section-settings">
      <div style="display:flex; align-items:center; justify-content:space-between">
        <h3>Settings</h3>
        <div style="display:flex; gap:8px">
          <button class="btn" id="btnReset">Reset</button>
          <button class="btn" id="btnReload">Reload</button>
        </div>
      </div>

      <div class="row">
        <label>Allow Bad Words — Explicit content</label>
        <div class="switch" id="swExplicit"></div>
      </div>
      <div class="row">
        <label>Autoplay next</label>
        <div class="switch on" id="swAutoplay"></div>
      </div>
      <div class="row">
        <label>Personalize listening (Smart Mix by Gomega Intelligence)</label>
        <div class="switch on" id="swSmart"></div>
      </div>
      <div class="row">
        <label>Crossfade (seconds)</label>
        <div class="num"><input id="inpCrossfade" type="number" min="0" max="8" step="1" value="3"></div>
      </div>
      <div class="row">
        <label>Volume</label>
        <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8">
      </div>
      <div class="row">
        <label>Accent color</label>
        <input id="accent" type="color" value="#34d3ff">
      </div>
      <div class="row">
        <label>Theme</label>
        <div>
          <button class="btn toggle on" id="themeAurora">Aurora</button>
          <button class="btn toggle" id="themeMidnight">Midnight</button>
        </div>
      </div>

      <div class="row">
        <label>Page Title</label>
        <input id="inpPageTitle" class="textish" style="min-height:unset" placeholder="Gomega Music">
      </div>
      <div class="row">
        <label>Page Cover Image URL</label>
        <input id="inpPageCover" class="textish" style="min-height:unset" placeholder="https://.../cover.jpg">
      </div>

      <div class="row" style="grid-template-columns:1fr auto">
        <label>Playlist Source URL (JSON or CSV)</label>
        <div style="display:flex; gap:8px; align-items:center">
          <input id="inpSrcUrl" class="textish" style="min-height:unset; width:280px" placeholder="https://.../playlist.json">
          <button class="btn" id="btnLoadSrc">Load</button>
        </div>
      </div>

      <div class="row" style="grid-template-columns:1fr auto">
        <label>Paste Playlist JSON (then Import)</label>
        <div style="display:flex; flex-direction:column; gap:8px">
          <textarea id="inpJson" class="textish" placeholder='[{"title":"Song","artist":"Artist","url":"https://.../song.mp3","explicit":false,"cover":"https://.../img.jpg","lyrics":"optional text"}]'></textarea>
          <div style="display:flex; gap:8px">
            <button class="btn" id="btnImportJson">Import</button>
            <button class="btn primary" id="btnSave">Save</button>
          </div>
        </div>
      </div>

      <div class="footerNote hint">Formats: JSON array of tracks or CSV with columns: title,artist,url,explicit,cover,lyrics</div>
    </aside>

    <div class="player panel">
      <div class="seek" style="flex:1">
        <span class="time" id="curTime2">0:00</span>
        <input id="seek2" type="range" min="0" max="1000" value="0" style="flex:1">
        <span class="time" id="dur2">0:00</span>
      </div>
      <div style="display:flex; align-items:center; gap:8px">
        <span class="badge" id="nowBadge">Stopped</span>
        <input id="vol2" type="range" min="0" max="1" step="0.01" value="0.8" title="Volume">
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Saved</div>
  <div class="dropMask" id="dropMask"><div class="badge" style="font-size:16px">Drop audio files to add</div></div>

  <!-- Two audio elements for gapless + crossfade -->
  <audio id="audioA" crossorigin="anonymous"></audio>
  <audio id="audioB" crossorigin="anonymous"></audio>

<script>
(() => {
  const $ = s => document.querySelector(s), $$ = s => Array.from(document.querySelectorAll(s));
  const tabs = $$('.tab'); const sections = {
    library: $('#section-library'),
    foryou: $('#section-foryou'),
    now: $('#section-now'),
    settings: $('#section-settings')
  };
  tabs.forEach(t => t.onclick = () => {
    tabs.forEach(x=>x.classList.remove('on')); t.classList.add('on');
    Object.values(sections).forEach(x=>x.classList.add('hidden'));
    sections[t.dataset.tab].classList.remove('hidden');
  });

  const state = {
    settings: {
      allowExplicit:false, autoplay:true, smart:true, crossfade:3, volume:0.8,
      theme:'aurora', accent:'#34d3ff',
      pageTitle:'Gomega Music', pageCover:''
    },
    library: [], queue: [], current:-1, shuffle:false, repeat:'off', audioActive:'A',
    stats:{}, search:''
  };

  const els = {
    // library / ui
    lib: $('#section-library'), countBadge: $('#countBadge'), explicitBadge: $('#explicitBadge'),
    forYouList: $('#forYouList'), fyCount: $('#fyCount'),
    queueList: $('#queueList'), queueBadge: $('#queueBadge'),
    art: $('#art'), title: $('#songTitle'), artist: $('#songArtist'),
    likeBtn: $('#btnLike'), shuffle: $('#btnShuffle'), repeat: $('#btnRepeat'),
    smart: $('#btnSmart'), prev: $('#btnPrev'), next: $('#btnNext'), play: $('#btnPlay'), plTxt: $('#plTxt'),
    seek: $('#seek'), seek2: $('#seek2'), curTime: $('#curTime'), curTime2: $('#curTime2'), dur: $('#dur'), dur2: $('#dur2'),
    vol2: $('#vol2'), volume: $('#volume'), nowBadge: $('#nowBadge'), viz: $('#viz'),
    search: $('#search'), clearSearch: $('#btnClearSearch'),
    // settings
    swExplicit: $('#swExplicit'), swAutoplay: $('#swAutoplay'), swSmart: $('#swSmart'),
    inpCrossfade: $('#inpCrossfade'), accent: $('#accent'), themeAurora: $('#themeAurora'), themeMidnight: $('#themeMidnight'),
    btnSave: $('#btnSave'), btnReset: $('#btnReset'), btnReload: $('#btnReload'),
    inpSrcUrl: $('#inpSrcUrl'), btnLoadSrc: $('#btnLoadSrc'), inpJson: $('#inpJson'), btnImportJson: $('#btnImportJson'),
    inpPageTitle: $('#inpPageTitle'), inpPageCover: $('#inpPageCover'), pageTitle: $('#pageTitle'), pageCover: $('#pageCover'),
    // misc
    toast: $('#toast'), dropMask: $('#dropMask'), lyricsWrap: $('#lyricsWrap'), lyrics: $('#lyrics')
  };

  const uid = () => Math.random().toString(36).slice(2);
  const fmt = s => { if (!isFinite(s)) return '0:00'; const m = Math.floor(s/60), ss = Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; };
  const toast = (m='Saved') => { els.toast.textContent = m; els.toast.style.display = 'block'; setTimeout(()=> els.toast.style.display='none', 1400); };
  const escapeHtml = str => (str||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function saveAll(){
    try{
      localStorage.setItem('gomega.music.settings', JSON.stringify(state.settings));
      const persist = state.library.map(t => {
        const keep = {id:t.id,title:t.title,artist:t.artist,explicit:t.explicit,liked:t.liked,cover:t.cover,source:t.source,lyrics:t.lyrics};
        if (t.url) keep.url = t.url;
        return keep;
      });
      localStorage.setItem('gomega.music.library', JSON.stringify(persist));
      localStorage.setItem('gomega.music.stats', JSON.stringify(state.stats));
      toast('Saved');
    }catch(e){ console.warn(e); toast('Storage full?'); }
    applyAccent();
  }
  function loadAll(){
    try{
      const s = JSON.parse(localStorage.getItem('gomega.music.settings')||'null'); if (s) Object.assign(state.settings, s);
      const lib = JSON.parse(localStorage.getItem('gomega.music.library')||'null'); if (lib) state.library = lib.map(t=>({...t,duration:0}));
      const st = JSON.parse(localStorage.getItem('gomega.music.stats')||'null'); if (st) state.stats = st;
    }catch(e){ console.warn(e); }
  }

  // Theme & accent
  function applyTheme(){
    const root = document.documentElement;
    if (state.settings.theme==='midnight'){ root.style.setProperty('--bg1','#05070d'); root.style.setProperty('--bg2','#0a0d14'); root.style.setProperty('--panel','#0b101a'); }
    else { root.style.setProperty('--bg1','#060e19'); root.style.setProperty('--bg2','#0a1526'); root.style.setProperty('--panel','#0f1b2f'); }
  }
  function hexToRgba(hex,a){ const h=hex.replace('#',''); const b=parseInt(h,16); const r=(b>>16)&255,g=(b>>8)&255,bl=b&255; return `rgba(${r},${g},${bl},${a})`; }
  function applyAccent(){ const root=document.documentElement; root.style.setProperty('--accent', state.settings.accent); root.style.setProperty('--ring', hexToRgba(state.settings.accent,.45)); }

  // Visualizer
  let ctx, analyser, dataArray, sourceA, sourceB;
  try{
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    analyser = ctx.createAnalyser(); analyser.fftSize=256; dataArray = new Uint8Array(analyser.frequencyBinCount);
    const gain = ctx.createGain(); gain.gain.value=1; analyser.connect(gain).connect(ctx.destination);
  }catch(e){ console.warn('AudioContext unavailable'); }
  const canvas = els.viz, g = canvas.getContext('2d');
  function drawViz(){ requestAnimationFrame(drawViz); if (!analyser) return;
    analyser.getByteFrequencyData(dataArray); g.clearRect(0,0,canvas.width,canvas.height);
    const w = canvas.width/dataArray.length;
    for(let i=0;i<dataArray.length;i++){ const v=dataArray[i], h=(v/255)*canvas.height; g.fillStyle=`rgba(255,255,255,${0.08+v/255*0.5})`; g.fillRect(i*w, canvas.height-h, w*0.8, h); }
  } drawViz();

  const audioA=$('#audioA'), audioB=$('#audioB'); [audioA,audioB].forEach(a=>{ a.preload='metadata'; a.crossOrigin='anonymous'; });
  const activeAudio=()=> state.audioActive==='A'?audioA:audioB, idleAudio=()=> state.audioActive==='A'?audioB:audioA;
  function connectToAnalyser(el){ if (!ctx||!analyser) return; try{ const src = ctx.createMediaElementSource(el); (el===audioA?sourceA=src:sourceB=src); src.connect(analyser);}catch(e){} }
  connectToAnalyser(audioA); connectToAnalyser(audioB);

  // Ranking (For You)
  function ensureStats(t){ if(!state.stats[t.id]) state.stats[t.id]={plays:0,skips:0,liked:false,lastPlayed:0}; return state.stats[t.id]; }
  function rankTracks(ids){
    const hour = new Date().getHours(), evening=(hour>=18||hour<=7);
    return ids.sort((a,b)=>{ const ta=getById(a), tb=getById(b); const sa=ensureStats(ta), sb=ensureStats(tb);
      const la=(ta.liked?2:0)+(state.search&&(ta.title.toLowerCase().includes(state.search.toLowerCase()))?1:0)-sa.skips*0.5+sa.plays*0.05;
      const lb=(tb.liked?2:0)+(state.search&&(tb.title.toLowerCase().includes(state.search.toLowerCase()))?1:0)-sb.skips*0.5+sb.plays*0.05;
      const fa=evening?(Date.now()-sa.lastPlayed<3600e3?-0.2:0.3):0, fb=evening?(Date.now()-sb.lastPlayed<3600e3?-0.2:0.3):0;
      return (lb+fb)-(la+fa);
    });
  }

  // Library / rendering
  function getById(id){ return state.library.find(t=>t.id===id); }
  function renderLibrary(){
    const q=state.search.toLowerCase(), allow=state.settings.allowExplicit;
    const list = state.library.filter(t=>{
      if(!allow && t.explicit) return false;
      if(!q) return true;
      return (t.title||'').toLowerCase().includes(q) || (t.artist||'').toLowerCase().includes(q);
    });
    els.lib.innerHTML='';
    list.forEach(t=>{
      const row=document.createElement('div'); row.className='track';
      row.innerHTML=`
        <div class="cover">${t.cover?`<img src="${t.cover}" style="width:100%;height:100%;object-fit:cover">`:`<span>${(t.title||'').slice(0,2).toUpperCase()||'♪'}</span>`}</div>
        <div class="meta">
          <div class="title">${escapeHtml(t.title||'(untitled)')}</div>
          <div class="artist">${escapeHtml(t.artist||'Unknown')}</div>
          <div class="badges">${t.explicit?'<span class="badge explicit">E</span>':''}${t.liked?'<span class="badge">Liked</span>':''}${t.lyrics?'<span class="badge">Lyrics</span>':''}</div>
        </div>
        <div class="badges">
          <button class="btn ghost like ${t.liked?'on':''}" title="Like">❤</button>
          <button class="btn ghost" title="Toggle explicit">E</button>
          <button class="btn" title="Play">Play</button>
        </div>`;
      const [likeBtn, expBtn, playBtn] = row.querySelectorAll('button');
      likeBtn.onclick = e=>{ e.stopPropagation(); t.liked=!t.liked; ensureStats(t).liked=t.liked; renderLibrary(); renderForYou(); saveAll(); };
      expBtn.onclick = e=>{ e.stopPropagation(); t.explicit=!t.explicit; renderLibrary(); renderForYou(); saveAll(); };
      playBtn.onclick = ()=> { enqueue([t.id], true); };
      row.onclick = ()=> { enqueue([t.id], true); };
      els.lib.appendChild(row);
    });
    els.countBadge.textContent = `${list.length} ${list.length===1?'track':'tracks'}`;
    els.explicitBadge.textContent = state.settings.allowExplicit ? 'Explicit On' : 'Explicit Off';
  }

  function renderForYou(){
    const allow = state.settings.allowExplicit;
    const ids = state.library.filter(t=> allow || !t.explicit).map(t=>t.id);
    const ranked = rankTracks(ids).slice(0, 50);
    els.fyCount.textContent = ranked.length;
    const root = els.forYouList; root.innerHTML='';
    ranked.forEach(id=>{
      const t = getById(id); if (!t) return;
      const row=document.createElement('div'); row.className='track';
      row.innerHTML=`
        <div class="cover">${t.cover?`<img src="${t.cover}" style="width:100%;height:100%;object-fit:cover">`:`<span>${(t.title||'').slice(0,2).toUpperCase()}</span>`}</div>
        <div class="meta">
          <div class="title">${escapeHtml(t.title)}</div>
          <div class="artist">${escapeHtml(t.artist||'')}</div>
          <div class="badges">${t.explicit?'<span class="badge explicit">E</span>':''}${t.liked?'<span class="badge">Liked</span>':''}</div>
        </div>
        <div class="badges">
          <button class="btn" title="Play">Play</button>
        </div>`;
      row.querySelector('button').onclick = ()=> enqueue([t.id], true);
      row.onclick = ()=> enqueue([t.id], true);
      root.appendChild(row);
    });
  }
  $('#btnPlayForYou').onclick = ()=>{
    const allow = state.settings.allowExplicit;
    const ids = state.library.filter(t=> allow || !t.explicit).map(t=>t.id);
    const ranked = state.settings.smart ? rankTracks(ids) : ids;
    enqueue(ranked, true);
  };

  // Queue
  function renderQueue(){
    const q = $('#queueList'); q.innerHTML='';
    state.queue.forEach((idx,i)=>{
      const t = state.library[idx]; if (!t) return;
      const row=document.createElement('div'); row.className='mini';
      row.innerHTML=`
        <div class="cover" style="width:36px;height:36px">${t.cover?`<img src="${t.cover}" style="width:100%;height:100%;object-fit:cover">`:`<span>${(t.title||'').slice(0,2).toUpperCase()}</span>`}</div>
        <div class="meta" style="min-width:0">
          <div class="title">${escapeHtml(t.title)}</div>
          <div class="artist">${escapeHtml(t.artist||'')}</div>
        </div>
        <div class="badges"><button class="btn ghost" title="Remove">×</button></div>`;
      row.querySelector('button').onclick = e=>{ e.stopPropagation(); if (i<state.current) state.current--; state.queue.splice(i,1); renderQueue(); updateQueueBadge(); };
      row.onclick = ()=>{ state.current = i; playFromQueue(); };
      q.appendChild(row);
    });
    updateQueueBadge();
  }
  function updateQueueBadge(){ $('#queueBadge').textContent = state.queue.length; }

  // Search
  $('#search').addEventListener('input', e=>{ state.search = e.target.value; renderLibrary(); renderForYou(); });
  $('#btnClearSearch').onclick = ()=>{ state.search=''; $('#search').value=''; renderLibrary(); renderForYou(); };

  // Bulk import helpers
  function normalizeTrack(x){
    const t = {
      id: x.id || uid(),
      title: (x.title||'').toString(),
      artist: (x.artist||'').toString(),
      url: x.url || '',
      explicit: !!(x.explicit==='true'||x.explicit===true||x.explicit===1||x.explicit==='1'),
      cover: x.cover || '',
      lyrics: x.lyrics ? x.lyrics.toString() : '',
      liked: !!x.liked,
      duration: 0,
      source: x.url ? 'url' : (x.source||'import')
    };
    return t;
  }
  function importJson(json){
    let arr = []; try{ arr = JSON.parse(json); }catch(e){ toast('Invalid JSON'); return; }
    if (!Array.isArray(arr)) { toast('JSON must be an array'); return; }
    arr.forEach(obj => state.library.push(normalizeTrack(obj)));
    saveAll(); renderLibrary(); renderForYou(); toast(`${arr.length} imported`);
  }
  function parseCsv(csv){
    const lines = csv.split(/\r?\n/).filter(l=>l.trim()); if (!lines.length) return [];
    const headers = lines[0].split(',').map(h=>h.trim());
    const rows = lines.slice(1).map(line=>{
      const cells = []; let cur='', inQ=false;
      for (let i=0;i<line.length;i++){
        const c=line[i];
        if (c==='"' && line[i+1]==='"'){ cur+='"'; i++; }
        else if (c==='"'){ inQ=!inQ; }
        else if (c===',' && !inQ){ cells.push(cur); cur=''; }
        else cur+=c;
      }
      cells.push(cur);
      const obj={}; headers.forEach((h,j)=> obj[h.trim()] = (cells[j]||'').trim());
      return obj;
    });
    return rows;
  }
  async function loadFromUrl(url){
    try{
      const res = await fetch(url); const text = await res.text();
      if (url.endsWith('.csv')) {
        const rows = parseCsv(text); rows.forEach(r=> state.library.push(normalizeTrack(r)));
        toast(`${rows.length} imported from CSV`);
      } else {
        importJson(text); // handles toast
        return;
      }
      saveAll(); renderLibrary(); renderForYou();
    }catch(e){ console.warn(e); toast('Failed to load'); }
  }
  els.btnImportJson.onclick = ()=> importJson(els.inpJson.value||'[]');
  els.btnLoadSrc.onclick = ()=> { const u=(els.inpSrcUrl.value||'').trim(); if (!u) return toast('Enter a URL'); loadFromUrl(u); };

  // Drag & drop (fast bulk add without any button)
  const mask = els.dropMask;
  ['dragenter','dragover'].forEach(ev=> document.addEventListener(ev, e=>{ e.preventDefault(); mask.classList.add('on'); }));
  ;['dragleave','drop'].forEach(ev=> document.addEventListener(ev, e=>{ e.preventDefault(); if (ev==='drop') handleDrop(e); mask.classList.remove('on'); }));
  async function handleDrop(e){
    const files = Array.from(e.dataTransfer.files||[]).filter(f=> f.type.startsWith('audio/'));
    if (!files.length) return;
    for (const f of files){
      const url = URL.createObjectURL(f);
      state.library.push({ id: uid(), title: f.name.replace(/\.[^.]+$/,''), artist:'Local file', url, explicit:false, cover:'', lyrics:'', liked:false, duration:0, source:'local' });
    }
    renderLibrary(); renderForYou(); toast(`${files.length} added`);
  }

  // Playback & controls (with crossfade)
  const audioA=$('#audioA'), audioB=$('#audioB');
  let fadeTimer=null;
  function updateArt(t){
    const holder = els.art; holder.innerHTML='';
    const div=document.createElement('div'); div.className='art';
    if (t && t.cover){ const img=document.createElement('img'); img.src=t.cover; div.appendChild(img); }
    else { div.style.background = `linear-gradient(135deg, ${state.settings.accent}, #1b2b44)`; }
    const scr=document.createElement('div'); scr.className='scrim'; div.appendChild(scr);
    holder.replaceWith(div); els.art=div;
  }
  function currentTrack(){ const idx = state.queue[state.current]; return state.library[idx]; }
  function onStarted(t){ const s=ensureStats(t); s.plays++; s.lastPlayed=Date.now(); saveAll(); showLyrics(t); }
  function showLyrics(t){
    if (t && t.lyrics){ els.lyrics.textContent = t.lyrics; els.lyricsWrap.classList.remove('hidden'); }
    else { els.lyrics.textContent=''; els.lyricsWrap.classList.add('hidden'); }
  }
  function playFromQueue(){
    const idx = state.queue[state.current]; const t = state.library[idx]; if (!t){ stop(); return; }
    if (!state.settings.allowExplicit && t.explicit){ next(); return; }

    const cur = activeAudio(), nxt = idleAudio();
    nxt.src = t.url; nxt.currentTime=0; nxt.volume=0; nxt.playbackRate=1;

    nxt.onloadedmetadata = ()=>{
      const fade=Math.max(0, state.settings.crossfade|0);
      try{ nxt.play(); }catch(e){}
      clearInterval(fadeTimer);
      const step=50, steps=Math.max(1, Math.floor(fade*1000/step));
      let i=0; fadeTimer=setInterval(()=>{ i++; const k=Math.min(1, i/steps);
        nxt.volume = state.settings.volume * k; cur.volume = state.settings.volume * (1-k);
        if (i>=steps){ clearInterval(fadeTimer); cur.pause(); nxt.volume=state.settings.volume; cur.volume=state.settings.volume; state.audioActive = state.audioActive==='A'?'B':'A'; onStarted(t); }
      }, step);
      if (fade===0){ cur.pause(); nxt.volume=state.settings.volume; state.audioActive = state.audioActive==='A'?'B':'A'; onStarted(t); }
    };
    nxt.onended = ()=> { if (state.settings.autoplay) next(); else stop(); };

    els.title.textContent = t.title||'(untitled)'; els.artist.textContent = t.artist||'';
    els.likeBtn.classList.toggle('on', !!t.liked);
    els.plTxt.textContent='⏸'; els.nowBadge.textContent='Playing';
    updateArt(t);
  }
  function stop(){ audioA.pause(); audioB.pause(); els.plTxt.textContent='▶'; els.nowBadge.textContent='Stopped'; }
  function togglePlay(){
    const a=activeAudio();
    if (!a.src){ if (state.queue.length) playFromQueue(); else if (state.library.length) { enqueue([state.library[0].id], true); } return; }
    if (a.paused){ try{ a.play(); }catch(e){} els.plTxt.textContent='⏸'; els.nowBadge.textContent='Playing'; }
    else { a.pause(); els.plTxt.textContent='▶'; els.nowBadge.textContent='Paused'; }
  }
  function prev(){ if (state.current>0){ state.current--; playFromQueue(); } else if (state.repeat==='all' && state.queue.length){ state.current=state.queue.length-1; playFromQueue(); } }
  function next(){
    const tcur=currentTrack(); if (tcur){ const s=ensureStats(tcur); s.skips++; saveAll(); }
    if (state.repeat==='one'){ playFromQueue(); return; }
    if (state.current < state.queue.length-1){ state.current++; playFromQueue(); }
    else if (state.repeat==='all' && state.queue.length){ state.current=0; playFromQueue(); }
    else stop();
  }
  function enqueue(ids, playNow=false){
    const allow=state.settings.allowExplicit;
    let filtered = ids.map(id => state.library.findIndex(t=>t.id===id)).filter(i=>i>=0).filter(i => allow || !state.library[i].explicit);
    if (state.settings.smart){ const ranked = rankTracks(filtered.map(i=>state.library[i].id)); filtered = ranked.map(id=> state.library.findIndex(t=>t.id===id)); }
    state.queue = filtered; state.current=0; renderQueue(); if (playNow) playFromQueue();
  }

  // Seek/volume
  function syncSeek(){
    const a=activeAudio(), cur=a.currentTime||0, dur=isFinite(a.duration)?a.duration:0;
    const val = dur ? Math.floor((cur/dur)*1000) : 0;
    els.seek.value=val; els.seek2.value=val;
    els.curTime.textContent=fmt(cur); els.curTime2.textContent=fmt(cur);
    els.dur.textContent=fmt(dur); els.dur2.textContent=fmt(dur);
  }
  setInterval(syncSeek, 250);
  const onSeek = e=>{ const a=activeAudio(), dur=isFinite(a.duration)?a.duration:0; a.currentTime = (e.target.value/1000)*(dur||0); };
  els.seek.oninput=onSeek; els.seek2.oninput=onSeek;
  function applyVolume(v){ [audioA,audioB].forEach(a=> a.volume=v); els.volume.value=v; els.vol2.value=v; }
  els.volume.oninput=e=>{ state.settings.volume=+e.target.value; applyVolume(state.settings.volume); };
  els.vol2.oninput=e=>{ state.settings.volume=+e.target.value; applyVolume(state.settings.volume); };

  // toggles
  function bindSwitch(el, getter, setter){ const apply=()=> el.classList.toggle('on', !!getter()); apply();
    el.onclick=()=>{ setter(!getter()); apply(); renderLibrary(); renderForYou(); saveAll(); if (el===els.swExplicit) maybeSkipExplicit(); };
  }
  bindSwitch(els.swExplicit, ()=>state.settings.allowExplicit, v=>state.settings.allowExplicit=v);
  bindSwitch(els.swAutoplay, ()=>state.settings.autoplay, v=>state.settings.autoplay=v);
  bindSwitch(els.swSmart, ()=>state.settings.smart, v=>{ state.settings.smart=v; els.smart.classList.toggle('on',v); });

  els.inpCrossfade.oninput=e=> state.settings.crossfade = Math.max(0, Math.min(8, +e.target.value||0));
  els.accent.oninput=e=>{ state.settings.accent=e.target.value; applyAccent(); };
  els.themeAurora.onclick=()=>{ state.settings.theme='aurora'; els.themeAurora.classList.add('on'); els.themeMidnight.classList.remove('on'); applyTheme(); };
  els.themeMidnight.onclick=()=>{ state.settings.theme='midnight'; els.themeMidnight.classList.add('on'); els.themeAurora.classList.remove('on'); applyTheme(); };
  els.btnSave.onclick = saveAll;
  els.btnReset.onclick = ()=>{ localStorage.removeItem('gomega.music.settings'); localStorage.removeItem('gomega.music.library'); localStorage.removeItem('gomega.music.stats'); location.reload(); };
  els.btnReload.onclick = ()=> location.reload();

  function maybeSkipExplicit(){ if (state.settings.allowExplicit) return; const t=currentTrack(); if (t && t.explicit) next(); }

  // page title/cover
  function applyPageMeta(){
    els.pageTitle.textContent = state.settings.pageTitle || 'Gomega Music';
    const url = state.settings.pageCover||''; els.pageCover.src = url || '';
    els.pageCover.style.display = url ? 'block' : 'none';
  }
  els.inpPageTitle.oninput = e=>{ state.settings.pageTitle = e.target.value; applyPageMeta(); };
  els.inpPageCover.oninput = e=>{ state.settings.pageCover = e.target.value; applyPageMeta(); };

  // keyboard
  window.addEventListener('keydown', (e)=>{
    if (['INPUT','TEXTAREA'].includes((e.target||{}).tagName)) return;
    if (e.code==='Space'){ e.preventDefault(); togglePlay(); }
    else if (e.key==='n'||e.key==='N'){ next(); }
    else if (e.key==='p'||e.key==='P'){ prev(); }
    else if (e.key==='ArrowRight'){ const a=activeAudio(); a.currentTime=Math.min((a.duration||0), a.currentTime+5); }
    else if (e.key==='ArrowLeft'){ const a=activeAudio(); a.currentTime=Math.max(0, a.currentTime-5); }
  });

  // Init
  loadAll();
  // Apply settings to UI
  els.swExplicit.classList.toggle('on', state.settings.allowExplicit);
  els.swAutoplay.classList.toggle('on', state.settings.autoplay);
  els.swSmart.classList.toggle('on', state.settings.smart);
  els.inpCrossfade.value = state.settings.crossfade;
  els.volume.value = state.settings.volume; els.vol2.value = state.settings.volume;
  els.accent.value = state.settings.accent;
  els.inpPageTitle.value = state.settings.pageTitle || '';
  els.inpPageCover.value = state.settings.pageCover || '';
  $('#explicitBadge').textContent = state.settings.allowExplicit ? 'Explicit On' : 'Explicit Off';
  applyTheme(); applyAccent(); applyPageMeta(); applyVolume(state.settings.volume);

  // Initial renders
  renderLibrary(); renderForYou(); renderQueue();
  const allIds = state.library.map(t=>t.id); if (allIds.length) enqueue(allIds,false);

  // canvas DPR
  const rescale=()=>{ const dpr=window.devicePixelRatio||1; canvas.width=canvas.clientWidth*dpr; canvas.height=canvas.clientHeight*dpr; };
  window.addEventListener('resize', rescale); rescale();
  document.addEventListener('visibilitychange', ()=>{ if (ctx && ctx.state==='suspended') ctx.resume().catch(()=>{}); });
})();
</script>
</body>
</html>
