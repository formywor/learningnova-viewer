<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gomega Music — music.html</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#060e19; --bg2:#0a1526; --panel:#0f1b2f;
    --glass:rgba(255,255,255,.06); --ink:#eaf2fa; --muted:#9aa6b2;
    --accent:#34d3ff; --accent2:#7c3aed; --danger:#ef4444; --ring:rgba(52,211,255,.45);
    --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif; color:var(--ink);
    background:
      radial-gradient(1200px 600px at 10% 0%, #0b1b33 0%, transparent 55%),
      radial-gradient(1200px 600px at 90% 10%, #0b162b 0%, transparent 55%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
    display:flex; flex-direction:column;
  }

  /* tabs */
  .tabs{display:flex; gap:8px; padding:12px 18px}
  .tab{padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
       background:rgba(255,255,255,.06); cursor:pointer; user-select:none}
  .tab.on{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#06101b; font-weight:700; border-color:transparent}

  .app{display:grid; grid-template-columns: 320px 1fr 380px; grid-template-rows: auto 1fr auto;
       grid-template-areas:"tabs tabs tabs" "side main settings" "player player player";
       gap:16px; padding:0 18px 18px; height:100%;}
  .panel{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
         border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow)}
  .hidden{display:none !important}

  /* left pane */
  .side{grid-area:side}
  .brand{padding:0; overflow:hidden}
  .coverHero{min-height:150px; position:relative; display:flex; align-items:flex-end;
             background:linear-gradient(135deg, rgba(52,211,255,.18), rgba(124,58,237,.18))}
  .coverHero img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:.33}
  .coverHero .scrim{position:absolute; inset:auto 0 0 0; height:60%; background:linear-gradient(180deg,transparent,rgba(0,0,0,.6))}
  .heroInner{position:relative; padding:16px}
  .heroTitle{margin:0; font-size:22px; letter-spacing:.3px; font-weight:800}
  .heroSubtitle{margin:2px 0 0; color:#b9c7da}

  .search{display:flex; gap:8px; padding:12px}
  .search .wrap{position:relative; flex:1}
  .search input{flex:1; padding:12px 12px 12px 40px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:var(--ink); outline:none}
  .search svg{position:absolute; top:10px; left:10px; opacity:.7}

  .library{display:flex; flex-direction:column; gap:12px; padding:12px; max-height:calc(100vh - 360px); overflow:auto}
  .track{display:grid; grid-template-columns: 44px 1fr auto; gap:12px; align-items:center; padding:8px; border-radius:12px; border:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.04)}
  .track:hover{background:rgba(255,255,255,.07)}
  .cover{width:44px; height:44px; border-radius:10px; background:linear-gradient(135deg,#18283f,#10233b); border:1px solid rgba(255,255,255,.12); overflow:hidden; position:relative}
  .cover span{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:10px; color:#9fb6cf}
  .meta{display:flex; flex-direction:column; min-width:0}
  .title{font-weight:600; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .artist{color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .badges{display:flex; gap:6px; align-items:center}
  .badge{font-size:10px; padding:3px 6px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); color:#c7d4e6}
  .explicit{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); color:#fecaca}

  /* main */
  .main{grid-area:main; display:grid; grid-template-rows:auto 1fr; gap:12px}
  .now{display:grid; grid-template-columns: 220px 1fr; gap:18px; padding:14px}
  .art{width:220px; height:220px; border-radius:20px; background:linear-gradient(135deg,#1e3a8a,#312e81); border:1px solid rgba(255,255,255,.12); box-shadow:var(--shadow); position:relative; overflow:hidden}
  .art img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:.95}
  .scrim{position:absolute; inset:auto 0 0 0; height:50%; background:linear-gradient(180deg,transparent,rgba(0,0,0,.5))}
  .songmeta{display:flex; flex-direction:column; gap:6px}
  .songtitle{font-size:22px; font-weight:800; letter-spacing:.3px; margin:0}
  .songartist{margin:0; color:var(--muted); font-weight:500}
  .lyrics{white-space:pre-wrap; line-height:1.6; font-size:14px; color:#cfe0f6; max-height:160px; overflow:auto; padding:10px; border-radius:12px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08)}
  .controls{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:14px}
  .ctrls{display:flex; justify-content:center; gap:10px; align-items:center}
  .btn{border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)); color:var(--ink); padding:10px 12px; border-radius:12px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; user-select:none}
  .btn:hover{filter:brightness(1.05)} .btn:active{transform:scale(.98)}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2)); border-color:transparent; color:#041019; font-weight:700}
  .btn.toggle.on{outline:2px solid var(--ring)}
  .big{width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center}
  .seek{display:flex; align-items:center; gap:10px}
  .time{font-variant-numeric:tabular-nums; color:#b8c5d8; font-size:12px; min-width:48px; text-align:center}
  input[type="range"]{-webkit-appearance:none; appearance:none; height:6px; background:rgba(255,255,255,.15); border-radius:999px; outline:none}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none; appearance:none; width:16px; height:16px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent2)); border:2px solid #06101b; box-shadow:0 0 0 3px rgba(52,211,255,.25); cursor:pointer}

  .queue{padding:12px; display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto}
  .mini{display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px dashed rgba(255,255,255,.15); border-radius:10px; background:rgba(255,255,255,.03)}
  .mini .title{font-size:13px}

  /* settings */
  .settings{grid-area:settings; display:flex; flex-direction:column; gap:12px; padding:14px}
  .row{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px; padding:8px 10px; border-radius:12px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08)}
  .row label{color:#c7d4e6; font-size:14px}
  .switch{position:relative; width:50px; height:28px; background:rgba(255,255,255,.15); border-radius:999px; cursor:pointer; border:1px solid rgba(255,255,255,.2)}
  .switch:before{content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent2)); transition:transform .2s ease}
  .switch.on{background:rgba(52,211,255,.25)} .switch.on:before{transform:translateX(22px)}

  .player{grid-area:player; display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px; padding:12px 14px}
  .player.panel{position:sticky; bottom:0}

  .hint{font-size:12px; color:#9fb3ca}
</style>
</head>
<body>
  <div class="tabs" role="tablist" aria-label="Sections">
    <button class="tab on" data-tab="library">Library</button>
    <button class="tab" data-tab="foryou">For You</button>
    <button class="tab" data-tab="now">Now Playing</button>
    <button class="tab" data-tab="settings">Settings</button>
  </div>

  <div class="app">
    <aside class="side">
      <section class="panel brand">
        <div class="coverHero">
          <img id="pageCover" alt="">
          <div class="scrim"></div>
          <div class="heroInner">
            <h1 class="heroTitle" id="pageTitle">Gomega Music</h1>
            <p class="heroSubtitle">Gomega Intelligence — Personalized Listening</p>
          </div>
        </div>
      </section>

      <div class="panel search">
        <div class="wrap">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="7"/><path d="m20 20-3.5-3.5"/></svg>
          <input id="search" placeholder="Search your library (title or artist)">
        </div>
        <span class="hint">Read-only library</span>
      </div>

      <div class="panel" style="padding:10px; display:flex; align-items:center; justify-content:space-between">
        <div class="badges" style="display:flex; gap:6px; align-items:center">
          <span class="badge" id="countBadge">0 tracks</span>
          <span class="badge" id="explicitBadge">Explicit Off</span>
        </div>
      </div>

      <div class="panel library section" id="section-library"></div>

      <div class="panel library section hidden" id="section-foryou" style="padding:12px">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px">
          <div class="badges">
            <span class="badge">Smart Mix</span>
            <span class="badge" id="fyCount">0</span>
          </div>
          <button class="btn primary" id="btnPlayForYou">Play For You</button>
        </div>
        <div id="forYouList" style="display:flex; flex-direction:column; gap:10px"></div>
      </div>

      <div class="panel library section hidden" id="section-now" style="padding:12px">
        <div class="hint">Use the controls in the center panel. Lyrics show below when available.</div>
      </div>
    </aside>

    <main class="main">
      <section class="panel now">
        <div class="art" id="art"><div class="scrim"></div></div>
        <div style="display:flex; flex-direction:column; gap:12px">
          <div class="songmeta">
            <h2 class="songtitle" id="songTitle">Nothing playing</h2>
            <p class="songartist" id="songArtist">Library is loading…</p>
          </div>
          <canvas id="viz" height="80"></canvas>

          <div class="controls">
            <div class="toggles" style="justify-content:flex-start; display:flex; gap:8px; align-items:center">
              <button class="btn toggle" id="btnLike" title="Like">❤</button>
              <button class="btn toggle" id="btnShuffle" title="Shuffle">Shuffle</button>
              <button class="btn toggle" id="btnRepeat" title="Repeat">Repeat</button>
              <span class="badge">Smart Mix</span>
              <button class="btn toggle on" id="btnSmart" title="Gomega Intelligence Smart Mix">On</button>
            </div>

            <div class="ctrls">
              <button class="btn big" id="btnPrev" title="Previous">⏮</button>
              <button class="btn big primary" id="btnPlay"><span id="plTxt">▶</span></button>
              <button class="btn big" id="btnNext" title="Next">⏭</button>
            </div>

            <div class="seek">
              <span class="time" id="curTime">0:00</span>
              <input id="seek" type="range" min="0" max="1000" value="0">
              <span class="time" id="dur">0:00</span>
            </div>
          </div>

          <details id="lyricsWrap" class="hidden">
            <summary class="btn">Show Lyrics</summary>
            <div class="lyrics" id="lyrics"></div>
          </details>
        </div>
      </section>

      <section class="panel queue">
        <div style="display:flex; align-items:center; justify-content:space-between">
          <div class="badges">
            <span class="badge">Up Next</span>
            <span class="badge" id="queueBadge">0</span>
          </div>
          <div class="hint">Shortcuts: Space / N / P / ← →</div>
        </div>
        <div id="queueList"></div>
      </section>
    </main>

    <aside class="settings panel section hidden" id="section-settings">
      <div style="display:flex; align-items:center; justify-content:space-between">
        <h3>Settings</h3>
        <div style="display:flex; gap:8px">
          <button class="btn" id="btnReset">Reset</button>
          <button class="btn" id="btnReload">Reload</button>
        </div>
      </div>

      <div class="row">
        <label>Allow Bad Words — Explicit content</label>
        <div class="switch" id="swExplicit"></div>
      </div>
      <div class="row">
        <label>Autoplay next</label>
        <div class="switch on" id="swAutoplay"></div>
      </div>
      <div class="row">
        <label>Personalize listening (Smart Mix by Gomega Intelligence)</label>
        <div class="switch on" id="swSmart"></div>
      </div>
      <div class="row">
        <label>Crossfade (seconds)</label>
        <input id="inpCrossfade" type="number" min="0" max="8" step="1" value="3" style="width:100px; padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06); color:var(--ink)">
      </div>
      <div class="row">
        <label>Volume</label>
        <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8">
      </div>

      <!-- Admin-only (hidden in UI; configured in code) -->
      <div class="row">
        <label>Catalog Source (admin only)</label>
        <div class="hint" id="catalogHint">Set CATALOG_URL in code</div>
      </div>
    </aside>

    <div class="player panel">
      <div class="seek" style="flex:1">
        <span class="time" id="curTime2">0:00</span>
        <input id="seek2" type="range" min="0" max="1000" value="0" style="flex:1">
        <span class="time" id="dur2">0:00</span>
      </div>
      <div style="display:flex; align-items:center; gap:8px">
        <span class="badge" id="nowBadge">Stopped</span>
        <input id="vol2" type="range" min="0" max="1" step="0.01" value="0.8" title="Volume">
      </div>
    </div>
  </div>

  <!-- audio elements for crossfade -->
  <audio id="audioA" crossorigin="anonymous"></audio>
  <audio id="audioB" crossorigin="anonymous"></audio>

<script>
/* ====== CONFIG (admin) ====== */
const CATALOG_URL = "https://learningnova.site/path/to/catalog.json"; // <-- set to your hosted JSON
const ADMIN_MODE = false; // leave false in production; true shows console notices
/* ============================ */

(() => {
  const $ = s => document.querySelector(s), $$ = s => Array.from(document.querySelectorAll(s));
  const tabs = $$('.tab'); const sections = {
    library: $('#section-library'), foryou: $('#section-foryou'),
    now: $('#section-now'), settings: $('#section-settings')
  };
  tabs.forEach(t => t.onclick = () => {
    tabs.forEach(x=>x.classList.remove('on')); t.classList.add('on');
    Object.values(sections).forEach(x=>x.classList.add('hidden'));
    sections[t.dataset.tab].classList.remove('hidden');
  });

  const state = {
    settings:{ allowExplicit:false, autoplay:true, smart:true, crossfade:3, volume:0.8,
               pageTitle:'Gomega Music', pageCover:'' },
    library:[], queue:[], current:-1, shuffle:false, repeat:'off', audioActive:'A',
    stats:{}, search:''
  };

  const els = {
    lib: $('#section-library'), countBadge: $('#countBadge'), explicitBadge: $('#explicitBadge'),
    forYouList: $('#forYouList'), fyCount: $('#fyCount'),
    queueList: $('#queueList'), queueBadge: $('#queueBadge'),
    art: $('#art'), title: $('#songTitle'), artist: $('#songArtist'),
    likeBtn: $('#btnLike'), shuffle: $('#btnShuffle'), repeat: $('#btnRepeat'),
    smart: $('#btnSmart'), prev: $('#btnPrev'), next: $('#btnNext'), play: $('#btnPlay'), plTxt: $('#plTxt'),
    seek: $('#seek'), seek2: $('#seek2'), curTime: $('#curTime'), curTime2: $('#curTime2'), dur: $('#dur'), dur2: $('#dur2'),
    vol2: $('#vol2'), volume: $('#volume'), nowBadge: $('#nowBadge'),
    search: $('#search'), lyrics: $('#lyrics'), lyricsWrap: $('#lyricsWrap'),
    btnPlayForYou: $('#btnPlayForYou')
  };

  const audioA=$('#audioA'), audioB=$('#audioB');
  const activeAudio=()=> state.audioActive==='A'?audioA:audioB, idleAudio=()=> state.audioActive==='A'?audioB:audioA;
  const uid = () => Math.random().toString(36).slice(2);
  const fmt = s => { if (!isFinite(s)) return '0:00'; const m = Math.floor(s/60), ss = Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; };
  const toast = m => ADMIN_MODE && console.log(m);

  /* storage */
  function saveAll(){
    try{
      localStorage.setItem('gomega.music.settings', JSON.stringify(state.settings));
      localStorage.setItem('gomega.music.stats', JSON.stringify(state.stats));
    }catch(e){ /* ignore */ }
  }
  function loadAll(){
    try{
      const s = JSON.parse(localStorage.getItem('gomega.music.settings')||'null'); if (s) Object.assign(state.settings, s);
      const st = JSON.parse(localStorage.getItem('gomega.music.stats')||'null'); if (st) state.stats = st;
    }catch(e){}
  }

  /* render */
  function renderLibrary(){
    const q=state.search.toLowerCase(), allow=state.settings.allowExplicit;
    const list = state.library.filter(t=>{
      if(!allow && t.explicit) return false;
      if(!q) return true;
      return (t.title||'').toLowerCase().includes(q) || (t.artist||'').toLowerCase().includes(q);
    });
    els.lib.innerHTML='';
    list.forEach(t=>{
      const row=document.createElement('div'); row.className='track';
      row.innerHTML=`
        <div class="cover">${t.cover?`<img src="${t.cover}" style="width:100%;height:100%;object-fit:cover">`:`<span>${(t.title||'').slice(0,2).toUpperCase()||'♪'}</span>`}</div>
        <div class="meta">
          <div class="title">${escapeHtml(t.title||'(untitled)')}</div>
          <div class="artist">${escapeHtml(t.artist||'Unknown')}</div>
          <div class="badges">${t.explicit?'<span class="badge explicit">E</span>':''}${t.lyrics?'<span class="badge">Lyrics</span>':''}</div>
        </div>
        <div class="badges"><button class="btn" title="Play">Play</button></div>`;
      row.querySelector('button').onclick = ()=> enqueue([t.id], true);
      row.onclick = ()=> enqueue([t.id], true);
      els.lib.appendChild(row);
    });
    els.countBadge.textContent = `${list.length} ${list.length===1?'track':'tracks'}`;
    els.explicitBadge.textContent = state.settings.allowExplicit ? 'Explicit On' : 'Explicit Off';
  }

  function renderForYou(){
    const allow = state.settings.allowExplicit;
    const ids = state.library.filter(t=> allow || !t.explicit).map(t=>t.id);
    const ranked = state.settings.smart ? rankTracks(ids) : ids;
    const top = ranked.slice(0, 50);
    $('#fyCount').textContent = top.length;
    const root = $('#forYouList'); root.innerHTML='';
    top.forEach(id=>{
      const t = getById(id); if (!t) return;
      const row=document.createElement('div'); row.className='track';
      row.innerHTML=`
        <div class="cover">${t.cover?`<img src="${t.cover}" style="width:100%;height:100%;object-fit:cover">`:`<span>${(t.title||'').slice(0,2).toUpperCase()}</span>`}</div>
        <div class="meta">
          <div class="title">${escapeHtml(t.title)}</div>
          <div class="artist">${escapeHtml(t.artist||'')}</div>
          <div class="badges">${t.explicit?'<span class="badge explicit">E</span>':''}</div>
        </div>
        <div class="badges"><button class="btn" title="Play">Play</button></div>`;
      row.querySelector('button').onclick = ()=> enqueue([t.id], true);
      row.onclick = ()=> enqueue([t.id], true);
      root.appendChild(row);
    });
  }

  function renderQueue(){
    const q = $('#queueList'); q.innerHTML='';
    state.queue.forEach((idx,i)=>{
      const t = state.library[idx]; if (!t) return;
      const row=document.createElement('div'); row.className='mini';
      row.innerHTML=`
        <div class="cover" style="width:36px;height:36px">${t.cover?`<img src="${t.cover}" style="width:100%;height:100%;object-fit:cover">`:`<span>${(t.title||'').slice(0,2).toUpperCase()}</span>`}</div>
        <div class="meta" style="min-width:0">
          <div class="title">${escapeHtml(t.title)}</div>
          <div class="artist">${escapeHtml(t.artist||'')}</div>
        </div>
        <div class="badges"><span class="badge">${i===state.current?'Now':'Queue'}</span></div>`;
      row.onclick = ()=>{ state.current = i; playFromQueue(); };
      q.appendChild(row);
    });
    $('#queueBadge').textContent = state.queue.length;
  }

  /* helpers */
  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m => ({'&':'&','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function getById(id){ return state.library.find(t=>t.id===id); }
  function ensureStats(t){ const s = state.stats[t.id] ||= {plays:0,skips:0,liked:false,lastPlayed:0}; return s; }
  function rankTracks(ids){
    const hour = new Date().getHours(), evening=(hour>=18||hour<=7);
    return ids.slice().sort((a,b)=>{
      const ta=getById(a), tb=getById(b), sa=ensureStats(ta), sb=ensureStats(tb);
      const la=(ta.liked?2:0)-sa.skips*0.5+sa.plays*0.05, lb=(tb.liked?2:0)-sb.skips*0.5+sb.plays*0.05;
      const fa=evening?(Date.now()-sa.lastPlayed<3600e3?-0.2:0.3):0, fb=evening?(Date.now()-sb.lastPlayed<3600e3?-0.2:0.3):0;
      return (lb+fb)-(la+fa);
    });
  }

  /* search */
  $('#search').addEventListener('input', e=>{ state.search = e.target.value; renderLibrary(); renderForYou(); });

  /* toggles */
  function bindSwitch(el, getter, setter){ const apply=()=> el.classList.toggle('on', !!getter()); apply();
    el.onclick=()=>{ setter(!getter()); apply(); renderLibrary(); renderForYou(); saveAll(); if (el===$('#swExplicit')) maybeSkipExplicit(); };
  }
  bindSwitch($('#swExplicit'), ()=>state.settings.allowExplicit, v=>state.settings.allowExplicit=v);
  bindSwitch($('#swAutoplay'), ()=>state.settings.autoplay, v=>state.settings.autoplay=v);
  bindSwitch($('#swSmart'), ()=>state.settings.smart, v=>{ state.settings.smart=v; $('#btnSmart').classList.toggle('on',v); });

  $('#btnReset').onclick = ()=>{ localStorage.removeItem('gomega.music.settings'); localStorage.removeItem('gomega.music.stats'); location.reload(); };
  $('#btnReload').onclick = ()=> location.reload();

  /* like/shuffle/repeat/play */
  $('#btnShuffle').onclick = ()=>{ state.shuffle = !state.shuffle; $('#btnShuffle').classList.toggle('on',state.shuffle); };
  $('#btnRepeat').onclick = ()=>{ state.repeat = state.repeat==='off' ? 'all' : state.repeat==='all' ? 'one' : 'off'; $('#btnRepeat').classList.toggle('on', state.repeat!=='off'); };
  $('#btnSmart').onclick  = ()=>{ state.settings.smart = !state.settings.smart; $('#btnSmart').classList.toggle('on', state.settings.smart); $('#swSmart').classList.toggle('on', state.settings.smart); saveAll(); };
  $('#btnPlayForYou').onclick = ()=>{
    const allow=state.settings.allowExplicit, ids = state.library.filter(t=> allow || !t.explicit).map(t=>t.id);
    const ranked = state.settings.smart ? rankTracks(ids) : ids; enqueue(ranked, true);
  };

  /* volume & seek */
  function applyVolume(v){ [audioA,audioB].forEach(a=> a.volume=v); $('#volume').value=v; $('#vol2').value=v; }
  $('#volume').oninput = e=>{ state.settings.volume=+e.target.value; applyVolume(state.settings.volume); saveAll(); };
  $('#vol2').oninput   = e=>{ state.settings.volume=+e.target.value; applyVolume(state.settings.volume); saveAll(); };
  function syncSeek(){
    const a=activeAudio(), cur=a.currentTime||0, dur=isFinite(a.duration)?a.duration:0;
    const val = dur ? Math.floor((cur/dur)*1000) : 0;
    $('#seek').value=val; $('#seek2').value=val;
    $('#curTime').textContent=fmt(cur); $('#curTime2').textContent=fmt(cur);
    $('#dur').textContent=fmt(dur); $('#dur2').textContent=fmt(dur);
  }
  setInterval(syncSeek, 250);
  const onSeek = e=>{ const a=activeAudio(), dur=isFinite(a.duration)?a.duration:0; a.currentTime = (e.target.value/1000)*(dur||0); };
  $('#seek').oninput=onSeek; $('#seek2').oninput=onSeek;

  /* keyboard */
  window.addEventListener('keydown', (e)=>{
    if (['INPUT','TEXTAREA'].includes((e.target||{}).tagName)) return;
    if (e.code==='Space'){ e.preventDefault(); togglePlay(); }
    else if (e.key==='n'||e.key==='N'){ next(); }
    else if (e.key==='p'||e.key==='P'){ prev(); }
    else if (e.key==='ArrowRight'){ const a=activeAudio(); a.currentTime=Math.min((a.duration||0), a.currentTime+5); }
    else if (e.key==='ArrowLeft'){ const a=activeAudio(); a.currentTime=Math.max(0, a.currentTime-5); }
  });

  /* player */
  function escapeCover(t, el){
    el.innerHTML='';
    const div=document.createElement('div'); div.className='art';
    if (t && t.cover){ const img=document.createElement('img'); img.src=t.cover; div.appendChild(img); }
    else { div.style.background = `linear-gradient(135deg, var(--accent), #1b2b44)`; }
    const scr=document.createElement('div'); scr.className='scrim'; div.appendChild(scr);
    el.replaceWith(div); return div;
  }
  function currentTrack(){ const idx = state.queue[state.current]; return state.library[idx]; }
  function showLyrics(t){ if (t && t.lyrics){ els.lyrics.textContent = t.lyrics; els.lyricsWrap.classList.remove('hidden'); } else { els.lyrics.textContent=''; els.lyricsWrap.classList.add('hidden'); } }
  function onStarted(t){ const s=ensureStats(t); s.plays++; s.lastPlayed=Date.now(); saveAll(); showLyrics(t); }
  function maybeSkipExplicit(){ if (state.settings.allowExplicit) return; const t=currentTrack(); if (t && t.explicit) next(); }

  let fadeTimer=null;
  function playFromQueue(){
    const idx = state.queue[state.current]; const t = state.library[idx]; if (!t){ stop(); return; }
    if (!state.settings.allowExplicit && t.explicit){ next(); return; }

    const cur = activeAudio(), nxt = idleAudio();
    nxt.src = t.url; nxt.currentTime=0; nxt.volume=0;

    nxt.onloadedmetadata = ()=>{
      const fade = Math.max(0, state.settings.crossfade|0);
      try{ nxt.play(); }catch(e){}
      clearInterval(fadeTimer);
      const step=50, steps=Math.max(1, Math.floor(fade*1000/step));
      let i=0; fadeTimer=setInterval(()=>{ i++; const k=Math.min(1, i/steps);
        nxt.volume = state.settings.volume * k; cur.volume = state.settings.volume * (1-k);
        if (i>=steps){ clearInterval(fadeTimer); cur.pause(); nxt.volume=state.settings.volume; state.audioActive = state.audioActive==='A'?'B':'A'; onStarted(t); }
      }, step);
      if (fade===0){ cur.pause(); nxt.volume=state.settings.volume; state.audioActive = state.audioActive==='A'?'B':'A'; onStarted(t); }
    };
    nxt.onended = ()=> { if (state.settings.autoplay) next(); else stop(); };

    els.title.textContent = t.title||'(untitled)'; els.artist.textContent = t.artist||'';
    els.plTxt.textContent='⏸'; els.nowBadge.textContent='Playing';
    els.art = escapeCover(t, els.art);
  }
  function togglePlay(){
    const a=activeAudio();
    if (!a.src){ if (state.queue.length) playFromQueue(); else if (state.library.length) { enqueue([state.library[0].id], true); } return; }
    if (a.paused){ try{ a.play(); }catch(e){} els.plTxt.textContent='⏸'; els.nowBadge.textContent='Playing'; }
    else { a.pause(); els.plTxt.textContent='▶'; els.nowBadge.textContent='Paused'; }
  }
  function stop(){ audioA.pause(); audioB.pause(); els.plTxt.textContent='▶'; els.nowBadge.textContent='Stopped'; }
  function prev(){ if (state.current>0){ state.current--; playFromQueue(); } else if (state.repeat==='all' && state.queue.length){ state.current=state.queue.length-1; playFromQueue(); } }
  function next(){
    const tcur=currentTrack(); if (tcur){ const s=ensureStats(tcur); s.skips++; saveAll(); }
    if (state.repeat==='one'){ playFromQueue(); return; }
    if (state.current < state.queue.length-1){ state.current++; playFromQueue(); }
    else if (state.repeat==='all' && state.queue.length){ state.current=0; playFromQueue(); }
    else stop();
  }
  $('#btnPrev').onclick=prev; $('#btnNext').onclick=next; $('#btnPlay').onclick=togglePlay;

  /* queue */
  function enqueue(ids, playNow=false){
    const allow=state.settings.allowExplicit;
    let filtered = ids.map(id => state.library.findIndex(t=>t.id===id)).filter(i=>i>=0).filter(i => allow || !state.library[i].explicit);
    if (state.settings.smart){ const ranked = rankTracks(filtered.map(i=>state.library[i].id)); filtered = ranked.map(id=> state.library.findIndex(t=>t.id===id)); }
    state.queue = filtered; state.current=0; renderQueue(); if (playNow) playFromQueue();
  }

  /* init: load catalog */
  loadAll();
  applyVolume(state.settings.volume);
  $('#explicitBadge').textContent = state.settings.allowExplicit ? 'Explicit On' : 'Explicit Off';

  if (!CATALOG_URL){ ADMIN_MODE && console.warn('Set CATALOG_URL!'); }
  else {
    fetch(CATALOG_URL).then(r=>r.json()).then(arr=>{
      state.library = (Array.isArray(arr)?arr:[]).map(x=>({
        id: uid(),
        title: (x.title||'').toString(),
        artist: (x.artist||'').toString(),
        url: x.url||'',
        explicit: !!(x.explicit===true || x.explicit==='true' || x.explicit===1 || x.explicit==='1'),
        cover: x.cover||'',
        lyrics: x.lyrics? String(x.lyrics) : ''
      }));
      renderLibrary(); renderForYou();
      const allIds = state.library.map(t=>t.id); if (allIds.length) enqueue(allIds,false);
      if (!allIds.length) { els.artist.textContent = 'Catalog is empty'; }
    }).catch(()=> { els.artist.textContent = 'Failed to load catalog'; });
  }

  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
})();
</script>
</body>
</html>
