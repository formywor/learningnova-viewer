<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Gomega Intelligence — Overview & Access</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root{
    --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#94a3b8;
    --accent:#22c55e; --accent2:#0ea5e9; --warn:#ef4444; --info:#60a5fa;
    --border:rgba(148,163,184,.25)
  }
  html,body{height:100%;margin:0;background:linear-gradient(135deg,#0f172a 0%,#1f2937 40%,#0ea5e9 100%);font-family:Segoe UI,Arial,sans-serif;color:var(--ink)}
  a{color:#7dd3fc;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .card{background:rgba(17,24,39,.72);border:1px solid var(--border);border-radius:16px;padding:16px 16px 20px;backdrop-filter:blur(10px);box-shadow:0 12px 40px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.04)}
  .header{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .logo{width:44px;height:44px;border-radius:12px;background:conic-gradient(from 0deg,#22c55e 0 25%,#0ea5e9 0 50%,#7c3aed 0 75%,#22c55e)}
  h1{margin:0;font-size:22px}
  p{margin:4px 0;color:var(--muted);font-size:14px}
  .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--border);font-size:12px}
  .ok{color:var(--accent)} .warn{color:var(--warn)} .info{color:var(--info)}
  #stage{position:relative;display:flex;justify-content:center;align-items:center;margin-top:12px}
  video{width:100%;max-width:980px;border-radius:14px;background:#000;aspect-ratio:16/9;object-fit:cover}
  canvas{position:absolute;inset:0;width:100%;max-width:980px;height:100%;border-radius:14px;pointer-events:none}
  .row{display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap}
  .btn{border:1px solid rgba(148,163,184,.35);background:#0b1220;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:active{transform:scale(.99)}
  .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);margin:18px 0}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  .tile{grid-column:span 12;background:rgba(2,6,23,.6);border:1px solid var(--border);border-radius:16px;padding:16px}
  @media(min-width:900px){
    .tile.span-6{grid-column:span 6}
    .tile.span-4{grid-column:span 4}
    .tile.span-8{grid-column:span 8}
  }
  .kicker{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:#cbd5e1;margin-bottom:6px}
  h2{margin:0 0 6px;font-size:18px}
  ul{margin:8px 0 0 18px;color:var(--muted);font-size:14px}
  .callout{border-left:3px solid var(--accent);background:rgba(34,197,94,.06);padding:12px;border-radius:12px}
  .foot{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .linkbtn{display:inline-flex;align-items:center;gap:8px;background:rgba(125,211,252,.08);border:1px solid rgba(125,211,252,.3);padding:10px 12px;border-radius:12px}
  .hidden{display:none !important}

  /* Welcome overlay */
  .overlay{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(2,6,23,.5);backdrop-filter:blur(6px);z-index:50
  }
  .overlay.show{display:flex}
  .welcome{
    width:min(640px,92vw);border-radius:18px;padding:20px;background:rgba(17,24,39,.9);
    border:1px solid var(--border);box-shadow:0 12px 40px rgba(0,0,0,.45),inset 0 1px 0 rgba(255,255,255,.04)
  }
  .welcome h3{margin:0 0 8px;font-size:22px}
  .welcome p{font-size:14px;color:var(--muted)}
  input[type="range"]{accent-color:#7dd3fc}
</style>

<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
</head>
<body>
  <div class="wrap">
    <!-- Access / Scanner Card -->
    <div class="card" id="gate">
      <div class="header">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Gomega Intelligence — Secure Overview</h1>
          <p id="desc">Loading camera for barcode access…</p>
          <div class="badges">
            <span class="badge" id="status">Initializing…</span>
            <span class="badge" id="hint">Show your barcode to the camera.</span>
            <span class="badge info" id="reading" hidden>Reading barcode…</span>
            <span class="badge" id="idsState" hidden>IDs: 0</span>
          </div>
        </div>
      </div>

      <div id="stage">
        <video id="preview" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="row">
        <button class="btn" id="flip" hidden>Switch Camera</button>
        <button class="btn" id="torchBtn" hidden>Torch</button>
        <input id="zoomRange" type="range" min="1" max="1" step="0.1" value="1" style="width:180px;display:none" />
        <button class="btn" id="captureBtn">Capture Photo</button>
        <label class="btn" for="uploadInput">Upload Image</label>
        <input id="uploadInput" type="file" accept="image/*" style="display:none" />
        <button class="btn" id="lock" hidden>Lock & Re-Scan</button>
      </div>
    </div>

    <!-- CONTENT (hidden until unlocked) -->
    <div id="content" class="hidden">
      <div class="divider"></div>

      <div class="grid">
        <div class="tile span-8">
          <div class="kicker">About</div>
          <h2>What is Gomega Intelligence?</h2>
          <p>
            Gomega Intelligence is the core decision and understanding engine that powers the Gomega ecosystem.
            It provides fast, context-aware reasoning, safe execution paths, and a consistent experience across
            apps and platforms. Whether you’re opening the Gomega Browser, getting step-by-step help in
            Homework Helper (BETA), or chatting in Gomega AI, Intelligence is the layer that interprets your intent,
            routes tasks, and composes helpful results.
          </p>
          <p>
            Designed for reliability and extensibility, Gomega Intelligence blends local signals, cloud models, and
            policy-driven tools to deliver answers with traceable steps and transparent controls.
          </p>
        </div>

        <div class="tile span-4">
          <div class="kicker">Status</div>
          <h2>Where It’s Used Right Now</h2>
          <ul>
            <li><strong>Gomega Browser</strong> — launch experience & guarded entry.</li>
            <li><strong>Homework Helper (BETA)</strong> — structured explanations and guided solving.</li>
            <li><strong>Gomega AI</strong> — conversational interface with smart actions.</li>
          </ul>
          <p class="callout" style="margin-top:8px">
            We’re actively expanding Intelligence across more pages and tools, moving toward a
            <em>barcode-first</em> access layer for every page.
          </p>
        </div>

        <div class="tile span-6">
          <div class="kicker">Access</div>
          <h2>Barcode-First Security</h2>
          <p>
            This page uses the same camera-based scanning approach as your verification page. After a valid code is
            detected and matched in <code>browser/ids.csv</code>, restricted content is revealed locally. The scanner
            never exposes page content until unlock is confirmed.
          </p>
          <ul>
            <li>On-device camera decode with TRY_HARDER.</li>
            <li>Live polygon highlight and “Reading barcode…” feedback.</li>
            <li>Dismiss closes the camera and enters the experience.</li>
          </ul>
        </div>

        <div class="tile span-6">
          <div class="kicker">Principles</div>
          <h2>Design Pillars</h2>
          <ul>
            <li><strong>Helpful</strong>: intent-aligned assistance.</li>
            <li><strong>Transparent</strong>: clear states and controls.</li>
            <li><strong>Guarded</strong>: gated content until verified.</li>
            <li><strong>Extensible</strong>: pluggable skills/domain packs.</li>
          </ul>
        </div>

        <div class="tile span-6">
          <div class="kicker">Homework Helper (BETA)</div>
          <h2>How Intelligence Assists Learning</h2>
          <ul>
            <li>Breaks problems into human-readable steps with hints.</li>
            <li>Detects when to scaffold vs. when to summarize.</li>
            <li>Supports algebraic checks and definition lookups.</li>
          </ul>
        </div>

        <div class="tile span-6">
          <div class="kicker">Gomega AI</div>
          <h2>Conversations That Do Things</h2>
          <ul>
            <li>Understands goals, not just sentences.</li>
            <li>Coordinates multi-step tasks with guardrails.</li>
            <li>Integrates with Plus memberships and advanced modes.</li>
          </ul>
        </div>

        <div class="tile span-8">
          <div class="kicker">Architecture</div>
          <h2>How It Works (High-Level)</h2>
          <ul>
            <li><strong>Perception</strong> → parse inputs and state.</li>
            <li><strong>Planning</strong> → choose skills/data ordering.</li>
            <li><strong>Execution</strong> → run steps with fallbacks.</li>
            <li><strong>Explanation</strong> → answer + optional trace.</li>
          </ul>
          <p>The same flow powers the Browser launch, Homework Helper, and Gomega AI task orchestration.</p>
        </div>

        <div class="tile span-4">
          <div class="kicker">Roadmap</div>
          <h2>What’s Next</h2>
          <ul>
            <li>Barcode-gated access on every core page.</li>
            <li>Richer skill library and adapters.</li>
            <li>Optional personalized context packs.</li>
          </ul>
        </div>

        <div class="tile span-12">
          <div class="foot">
            <a class="linkbtn" href="https://gomega.watch/Intelligence" target="_blank" rel="noopener">
              <span>Want more from Gomega Intelligence?</span> <strong>Visit gomega.watch/Intelligence →</strong>
            </a>
          </div>
        </div>
      </div>
    </div><!-- /content -->
  </div>

  <!-- Welcome Overlay -->
  <div class="overlay" id="welcomeOverlay" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle">
    <div class="welcome">
      <h3 id="welcomeTitle">Welcome</h3>
      <p id="welcomeMsg">Access granted.</p>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="dismissBtn">Dismiss</button>
        <button class="btn" id="relockBtn">Lock & Re-Scan</button>
      </div>
    </div>
  </div>

<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<script>
(function(){
  const IDS_URL = 'browser/ids.csv'; // number,name pairs
  const CONFIRM_HITS = 3;

  const statusEl   = document.getElementById('status');
  const hintEl     = document.getElementById('hint');
  const descEl     = document.getElementById('desc');
  const readingEl  = document.getElementById('reading');
  const idsState   = document.getElementById('idsState');
  const video      = document.getElementById('preview');
  const overlay    = document.getElementById('overlay');
  const ctx        = overlay.getContext('2d');
  const flipBtn    = document.getElementById('flip');
  const torchBtn   = document.getElementById('torchBtn');
  const zoomRange  = document.getElementById('zoomRange');
  const captureBtn = document.getElementById('captureBtn');
  const uploadIn   = document.getElementById('uploadInput');
  const stage      = document.getElementById('stage');
  const content    = document.getElementById('content');
  const lockBtn    = document.getElementById('lock');

  const welcomeOverlay = document.getElementById('welcomeOverlay');
  const welcomeTitle   = document.getElementById('welcomeTitle');
  const welcomeMsg     = document.getElementById('welcomeMsg');
  const dismissBtn     = document.getElementById('dismissBtn');
  const relockBtn      = document.getElementById('relockBtn');

  const idMap = new Map();
  let reader, controlsRef = null, mediaStream = null;
  let currentDeviceId = null, preferMode = 'fhd'; // ladder: fhd -> hd
  let unlocked = false;
  let lastDraw = 0, lastText = '', repeatCount = 0;
  let heartbeatTimer = null;

  // ---------- UI helpers ----------
  function setStatus(text, cls){
    statusEl.textContent = text;
    statusEl.className = 'badge' + (cls ? ' ' + cls : '');
  }

  function fitCanvasIntrinsic(){
    const vw = video.videoWidth || video.clientWidth || 640;
    const vh = video.videoHeight || video.clientHeight || 360;
    overlay.width  = Math.max(1, vw);
    overlay.height = Math.max(1, vh);
    // Keep CSS size matched to the video element
    overlay.style.width  = video.clientWidth + 'px';
    overlay.style.height = video.clientHeight + 'px';
  }

  function drawPoly(points, color, width=4){
    if(!points || !points.length) return;
    const now = performance.now();
    if(now - lastDraw < 50) return; // throttle draws
    lastDraw = now;

    const sx = overlay.width / (video.videoWidth || overlay.width);
    const sy = overlay.height / (video.videoHeight || overlay.height);

    ctx.clearRect(0,0,overlay.width,overlay.height);
    ctx.lineWidth = width;
    ctx.strokeStyle = color;
    ctx.beginPath();
    ctx.moveTo(points[0].x*sx, points[0].y*sy);
    for(let i=1;i<points.length;i++) ctx.lineTo(points[i].x*sx, points[i].y*sy);
    ctx.closePath();
    ctx.stroke();
  }

  function faintGuide(){
    ctx.clearRect(0,0,overlay.width,overlay.height);
    ctx.strokeStyle = "rgba(255,255,255,.25)";
    ctx.lineWidth = 2;
    const w = overlay.width*.6, h = overlay.height*.3;
    const x = (overlay.width-w)/2, y = (overlay.height-h)/2;
    ctx.strokeRect(x,y,w,h);
  }

  function outlineUnlocked(){
    ctx.clearRect(0,0,overlay.width,overlay.height);
    drawPoly([{x:20,y:20},{x:overlay.width-20,y:20},{x:overlay.width-20,y:overlay.height-20},{x:20,y:overlay.height-20}], '#22c55e', 5);
  }

  // ---------- CSV load ----------
  async function loadIds(){
    try{
      const res = await fetch(IDS_URL, { cache:'no-store' });
      const text = await res.text();
      idMap.clear();
      text.split(/\r?\n/).forEach(line=>{
        const raw = line.trim();
        if(!raw) return;
        const idx = raw.indexOf(',');
        const code = (idx>=0 ? raw.slice(0,idx) : raw).trim();
        const name = (idx>=0 ? raw.slice(idx+1) : '').trim();
        if(/^\d{6,20}$/.test(code)) idMap.set(code, name || '');
      });
      idsState.hidden = false;
      idsState.textContent = `IDs: ${idMap.size}`;
    }catch(e){
      idsState.hidden = false;
      idsState.textContent = 'IDs: load error';
    }
  }

  // ---------- Camera plumbing ----------
  async function pickBackCamera(){
    const devs = await navigator.mediaDevices.enumerateDevices();
    const cams = devs.filter(d=>d.kind==='videoinput');
    if(!cams.length) return null;
    const byLabel = cams.find(c => /back|rear|environment/i.test(c.label));
    return (byLabel || cams[0]).deviceId || null;
  }

  async function startCamera(){
    setStatus('Requesting camera…','info');
    // pick device
    currentDeviceId = currentDeviceId || await pickBackCamera();

    const base = (preferMode === 'fhd')
      ? { width:{ideal:1920}, height:{ideal:1080} }
      : { width:{ideal:1280}, height:{ideal:720} };

    const constraints = {
      audio:false,
      video:{
        deviceId: currentDeviceId ? {exact:currentDeviceId} : undefined,
        facingMode:{ideal:'environment'},
        frameRate:{ideal:30, min:10},
        ...base
      }
    };

    try{
      mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
    }catch(e){
      // Fallback to any camera without exact device
      delete constraints.video.deviceId;
      mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
    }

    video.srcObject = mediaStream;
    await video.play();
    fitCanvasIntrinsic();

    // Autofocus/torch/zoom
    try{
      const track = mediaStream.getVideoTracks()[0];
      const caps = track.getCapabilities?.() || {};
      // torch
      torchBtn.hidden = !caps.torch;
      // zoom
      if(caps.zoom){
        zoomRange.min = caps.zoom.min ?? 1;
        zoomRange.max = caps.zoom.max ?? 5;
        zoomRange.step = caps.zoom.step ?? 0.1;
        zoomRange.value = caps.zoom.min ?? 1;
        zoomRange.style.display = 'inline-block';
      }else{
        zoomRange.style.display = 'none';
      }
      // continuous focus
      if(caps.focusMode && caps.focusMode.includes('continuous')){
        await track.applyConstraints({ advanced:[{ focusMode:'continuous' }] });
      }
      // reconnect if track dies
      track.onended = () => {
        // Auto-restart when camera stops
        safeRestartCamera();
      };
    }catch(e){}

    // show flip if more than one
    const cams = (await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
    flipBtn.hidden = cams.length <= 1;

    startHeartbeat();
    setStatus('Reading…','info');
  }

  function stopCamera(){
    stopHeartbeat();
    if(controlsRef && controlsRef.stop){ try{ controlsRef.stop(); }catch(e){} }
    if(controlsRef && controlsRef.reset){ try{ controlsRef.reset(); }catch(e){} }
    controlsRef = null;
    mediaStream?.getTracks?.().forEach(t=>{ try{ t.stop(); }catch(e){} });
    mediaStream = null;
    video.srcObject = null;
  }

  let restarting = false;
  async function safeRestartCamera(){
    if(restarting) return;
    restarting = true;
    try{
      stopCamera();
      // ladder down if we were at fhd and having trouble
      if(preferMode === 'fhd') preferMode = 'hd';
      await startCamera();
      await startDecoding();
    }catch(e){
      // try once more with hd
      preferMode = 'hd';
      try{
        await startCamera();
        await startDecoding();
      }catch(_){}
    }finally{
      restarting = false;
    }
  }

  // Heartbeat to recover if track stalls without firing onended
  function startHeartbeat(){
    stopHeartbeat();
    heartbeatTimer = setInterval(()=>{
      const track = mediaStream?.getVideoTracks?.()[0];
      if(!track || track.readyState === 'ended' || video.readyState === 0){
        safeRestartCamera();
      }
    }, 2000);
  }
  function stopHeartbeat(){
    if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer = null; }
  }

  // ---------- ZXing setup ----------
  function initReader(){
    reader = new ZXing.BrowserMultiFormatReader();
    try{
      const hints = new Map();
      hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
        ZXing.BarcodeFormat.QR_CODE,
        ZXing.BarcodeFormat.CODE_128,
        ZXing.BarcodeFormat.CODE_39,
        ZXing.BarcodeFormat.CODE_93,
        ZXing.BarcodeFormat.EAN_13,
        ZXing.BarcodeFormat.EAN_8,
        ZXing.BarcodeFormat.UPC_A,
        ZXing.BarcodeFormat.ITF,
        ZXing.BarcodeFormat.CODABAR
      ]);
      reader.setHints(hints);
    }catch(e){}
  }

  function verifyLocally(code){
    if(!/^\d{6,20}$/.test(code)) return { ok:false, name:null };
    if(!idMap.has(code)) return { ok:false, name:null };
    return { ok:true, name:idMap.get(code) || null };
  }

  function showWelcome(name){
    welcomeTitle.textContent = name ? `Welcome, ${name}` : 'Welcome';
    welcomeMsg.textContent   = 'Access granted to Gomega Intelligence.';
    welcomeOverlay.classList.add('show');
  }

  function unlockUI(){
    setStatus('Unlocked — content revealed','ok');
    hintEl.textContent = 'Access granted.';
    outlineUnlocked();
    content.classList.remove('hidden');
    lockBtn.hidden = false;
    readingEl.hidden = true;
  }

  async function startDecoding(){
    const inputs = await reader.listVideoInputDevices();
    // prefer existing deviceId, else pick a back camera
    currentDeviceId = currentDeviceId || (await pickBackCamera()) || (inputs[0] && inputs[0].deviceId) || undefined;

    controlsRef = reader.decodeFromConstraints({
      audio:false,
      video:{
        deviceId: currentDeviceId ? {exact: currentDeviceId} : undefined,
        facingMode: {ideal:'environment'},
        width: {ideal: (preferMode==='fhd'?1920:1280)},
        height:{ideal: (preferMode==='fhd'?1080:720)},
        frameRate:{ideal:30, min:10}
      }
    }, 'preview', (result, err, controls) => {
      if(unlocked) return;

      if(result && result.getText){
        const txt = (result.getText() || '').trim();
        const pts = (result.resultPoints || []).map(p => ({x:p.getX(), y:p.getY()}));
        // Intrinsic overlay sizing can change once metadata arrives
        fitCanvasIntrinsic();

        drawPoly(pts, /^\d{6,20}$/.test(txt) ? '#60a5fa' : '#ef4444');
        readingEl.hidden = false;
        readingEl.textContent = 'Reading barcode…';

        if(/^\d{6,20}$/.test(txt)){
          // consecutive hit confirmation
          if(txt === lastText){ repeatCount++; } else { lastText = txt; repeatCount = 1; }
          if(repeatCount >= CONFIRM_HITS){
            const { ok, name } = verifyLocally(txt);
            if(ok){
              unlocked = true;
              controls && controls.stop();
              drawPoly(pts, '#22c55e');
              unlockUI();
              showWelcome(name);
              // stop camera when dismissed
            }else{
              setStatus('Code not recognized','warn');
              drawPoly(pts, '#ef4444');
              readingEl.hidden = true;
            }
          }
        }else{
          setStatus('Invalid code format','warn');
        }
      }else if(err && !(err instanceof ZXing.NotFoundException)){
        setStatus('Camera decode error','warn');
        readingEl.hidden = true;
        // try stepping down resolution once
        if(preferMode === 'fhd'){
          preferMode = 'hd';
          safeRestartCamera();
        }
      }else if(!unlocked){
        faintGuide();
      }
    });
  }

  // ---------- Image decoding (optional) ----------
  async function decodeFromImageBitmap(bitmap){
    // Draw to offscreen canvas at intrinsic size for best decode
    const cnv = document.createElement('canvas');
    cnv.width = bitmap.width; cnv.height = bitmap.height;
    const c = cnv.getContext('2d');
    c.drawImage(bitmap, 0, 0);
    const img = new Image();
    img.src = cnv.toDataURL('image/png');
    await img.decode();
    try{
      const result = await reader.decodeFromImage(img);
      return result.getText ? String(result.getText()).trim() : '';
    }catch(e){
      return '';
    }
  }

  captureBtn.addEventListener('click', async ()=>{
    try{
      if(!video.srcObject){ return; }
      // capture current frame
      const bmp = await createImageBitmap(video);
      const txt = await decodeFromImageBitmap(bmp);
      if(txt){
        handleManualDecode(txt);
      }else{
        setStatus('No code found in photo','warn');
      }
    }catch(e){
      setStatus('Capture failed','warn');
    }
  });

  uploadIn.addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    try{
      const bmp = await createImageBitmap(file);
      const txt = await decodeFromImageBitmap(bmp);
      if(txt){
        handleManualDecode(txt);
      }else{
        setStatus('No code found in image','warn');
      }
    }catch(err){
      setStatus('Image load failed','warn');
    }finally{
      e.target.value = '';
    }
  });

  function handleManualDecode(txt){
    if(/^\d{6,20}$/.test(txt)){
      const { ok, name } = verifyLocally(txt);
      if(ok){
        unlocked = true;
        if(controlsRef && controlsRef.stop) controlsRef.stop();
        stopCamera();
        fitCanvasIntrinsic();
        drawPoly([{x:20,y:20},{x:overlay.width-20,y:20},{x:overlay.width-20,y:overlay.height-20},{x:20,y:overlay.height-20}], '#22c55e');
        unlockUI();
        showWelcome(name);
      }else{
        setStatus('Code not recognized','warn');
      }
    }else{
      setStatus('Invalid code format','warn');
    }
  }

  // ---------- Controls ----------
  flipBtn.onclick = async () => {
    try{
      const list = await navigator.mediaDevices.enumerateDevices();
      const cams = list.filter(d => d.kind==='videoinput');
      if(!cams.length) return;
      // rotate through devices
      const idx = currentDeviceId ? Math.max(0, cams.findIndex(d=>d.deviceId===currentDeviceId)) : -1;
      const next = cams[(idx+1) % cams.length];
      currentDeviceId = next.deviceId;
      await safeRestartCamera();
    }catch(e){}
  };

  torchBtn.onclick = async ()=>{
    try{
      const track = mediaStream?.getVideoTracks?.()[0];
      if(!track) return;
      const on = torchBtn.dataset.on === '1';
      await track.applyConstraints({ advanced:[{ torch: !on }] });
      torchBtn.dataset.on = (!on ? '1' : '0');
      torchBtn.textContent = (!on ? 'Torch (On)' : 'Torch');
    }catch(e){}
  };

  zoomRange.addEventListener('input', async (e)=>{
    try{
      const track = mediaStream?.getVideoTracks?.()[0];
      if(!track) return;
      await track.applyConstraints({ advanced:[{ zoom: Number(e.target.value) }] });
    }catch(e){}
  });

  lockBtn.onclick = async ()=>{
    unlocked = false;
    setStatus('Locked','warn');
    hintEl.textContent = 'Show your barcode to the camera.';
    content.classList.add('hidden');
    lockBtn.hidden = true;
    welcomeOverlay.classList.remove('show');
    ctx.clearRect(0,0,overlay.width,overlay.height);
    readingEl.hidden = true;
    stage.classList.remove('hidden');
    await safeRestartCamera();
  };

  dismissBtn.onclick = ()=>{
    stopCamera();
    stage.classList.add('hidden');
    welcomeOverlay.classList.remove('show');
  };
  relockBtn.onclick = ()=> lockBtn.onclick();

  // Page visibility (pause camera when hidden; restart when visible)
  document.addEventListener('visibilitychange', async ()=>{
    if(document.hidden){
      stopCamera();
    }else if(!unlocked){
      await safeRestartCamera();
    }
  });

  // ---------- Boot ----------
  (async ()=>{
    descEl.textContent = 'Gomega Intelligence is loading your camera…';
    await loadIds();
    initReader();
    await startCamera();
    await startDecoding();
  })();
})();
</script>
</body>
</html>
