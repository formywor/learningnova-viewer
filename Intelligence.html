<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Gomega Intelligence — Overview & Access</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root{
    --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#94a3b8;
    --accent:#22c55e; --accent2:#0ea5e9; --warn:#ef4444; --info:#60a5fa;
    --glass:rgba(255,255,255,.06); --border:rgba(148,163,184,.25)
  }
  html,body{height:100%;margin:0;background:linear-gradient(135deg,#0f172a 0%,#1f2937 40%,#0ea5e9 100%);font-family:Segoe UI,Arial,sans-serif;color:var(--ink)}
  a{color:#7dd3fc;text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .card{background:rgba(17,24,39,.72);border:1px solid var(--border);border-radius:16px;padding:16px 16px 20px;backdrop-filter:blur(10px);box-shadow:0 12px 40px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.04)}
  .header{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .logo{width:44px;height:44px;border-radius:12px;background:conic-gradient(from 0deg,#22c55e 0 25%,#0ea5e9 0 50%,#7c3aed 0 75%,#22c55e);box-shadow:0 8px 24px rgba(34,197,94,.35),0 0 0 1px rgba(255,255,255,.08) inset}
  h1{margin:0;font-size:22px;letter-spacing:.2px}
  p{margin:4px 0;color:var(--muted);font-size:14px;line-height:1.5}
  .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--border);font-size:12px}
  .ok{color:var(--accent)} .warn{color:var(--warn)} .info{color:var(--info)}
  #stage{position:relative;display:flex;justify-content:center;align-items:center;margin-top:12px}
  video{width:100%;max-width:980px;border-radius:14px;background:#000;aspect-ratio:16/9;object-fit:cover}
  canvas{position:absolute;inset:0;width:100%;max-width:980px;height:100%;border-radius:14px;pointer-events:none}
  .row{display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap}
  .btn{border:1px solid rgba(148,163,184,.35);background:#0b1220;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:active{transform:scale(.99)} .btn[hidden]{display:none}
  .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);margin:18px 0}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  .tile{grid-column:span 12;background:rgba(2,6,23,.6);border:1px solid var(--border);border-radius:16px;padding:16px}
  @media(min-width:900px){
    .tile.span-6{grid-column:span 6}
    .tile.span-4{grid-column:span 4}
    .tile.span-8{grid-column:span 8}
  }
  .kicker{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:#cbd5e1;margin-bottom:6px}
  h2{margin:0 0 6px;font-size:18px}
  ul{margin:8px 0 0 18px;color:var(--muted);font-size:14px}
  .callout{border-left:3px solid var(--accent);background:rgba(34,197,94,.06);padding:12px;border-radius:12px}
  .foot{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .linkbtn{display:inline-flex;align-items:center;gap:8px;background:rgba(125,211,252,.08);border:1px solid rgba(125,211,252,.3);padding:10px 12px;border-radius:12px}
  .hidden{display:none !important}

  /* Welcome overlay */
  .overlay{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(2,6,23,.5);backdrop-filter:blur(6px);z-index:50
  }
  .overlay.show{display:flex}
  .welcome{
    width:min(640px,92vw);border-radius:18px;padding:20px;background:rgba(17,24,39,.9);
    border:1px solid var(--border);box-shadow:0 12px 40px rgba(0,0,0,.45),inset 0 1px 0 rgba(255,255,255,.04)
  }
  .welcome h3{margin:0 0 8px;font-size:22px}
  .welcome p{font-size:14px;color:var(--muted)}
</style>

<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
</head>
<body>
  <div class="wrap">
    <!-- Access / Scanner Card -->
    <div class="card" id="gate">
      <div class="header">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Gomega Intelligence — Secure Overview</h1>
          <p id="desc">Loading camera for barcode access…</p>
          <div class="badges">
            <span class="badge" id="status">Initializing…</span>
            <span class="badge" id="hint">Show your barcode to the camera.</span>
            <span class="badge info" id="reading" hidden>Reading barcode…</span>
            <span class="badge" id="idsState" hidden>IDs: 0</span>
          </div>
        </div>
      </div>

      <div id="stage">
        <video id="preview" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="row">
        <button class="btn" id="flip" hidden>Switch Camera</button>
        <button class="btn" id="lock" hidden>Lock & Re-Scan</button>
      </div>
    </div>

    <!-- CONTENT (hidden until unlocked) -->
    <div id="content" class="hidden">
      <div class="divider"></div>

      <div class="grid">
        <div class="tile span-8">
          <div class="kicker">About</div>
          <h2>What is Gomega Intelligence?</h2>
          <p>
            Gomega Intelligence is the core decision and understanding engine that powers the Gomega ecosystem.
            It provides fast, context-aware reasoning, safe execution paths, and a consistent experience across
            apps and platforms. Whether you’re opening the Gomega Browser, getting step-by-step help in
            Homework Helper (BETA), or chatting in Gomega AI, Intelligence is the layer that interprets your intent,
            routes tasks, and composes helpful results.
          </p>
          <p>
            Designed for reliability and extensibility, Gomega Intelligence blends local signals, cloud models, and
            policy-driven tools to deliver answers with traceable steps and transparent controls.
          </p>
        </div>

        <div class="tile span-4">
          <div class="kicker">Status</div>
          <h2>Where It’s Used Right Now</h2>
          <ul>
            <li><strong>Gomega Browser</strong> — launch experience & guarded entry.</li>
            <li><strong>Homework Helper (BETA)</strong> — structured explanations and guided solving.</li>
            <li><strong>Gomega AI</strong> — conversational interface with smart actions.</li>
          </ul>
          <p class="callout" style="margin-top:8px">
            We’re actively expanding Intelligence across more pages and tools, moving toward a
            <em>barcode-first</em> access layer for every page.
          </p>
        </div>

        <div class="tile span-6">
          <div class="kicker">Access</div>
          <h2>Barcode-First Security</h2>
          <p>
            This page uses the same camera-based scanning approach as your verification page. After a valid code is
            detected and matched in <code>browser/ids.csv</code>, restricted content is revealed locally. The scanner
            never exposes page content until unlock is confirmed.
          </p>
          <ul>
            <li>On-device camera decode with TRY_HARDER.</li>
            <li>Live polygon highlight and “Reading barcode…” feedback.</li>
            <li>Dismiss closes the camera and enters the experience.</li>
          </ul>
        </div>

        <div class="tile span-6">
          <div class="kicker">Principles</div>
          <h2>Design Pillars</h2>
          <ul>
            <li><strong>Helpful</strong>: intent-aligned assistance.</li>
            <li><strong>Transparent</strong>: clear states and controls.</li>
            <li><strong>Guarded</strong>: gated content until verified.</li>
            <li><strong>Extensible</strong>: pluggable skills/domain packs.</li>
          </ul>
        </div>

        <div class="tile span-6">
          <div class="kicker">Homework Helper (BETA)</div>
          <h2>How Intelligence Assists Learning</h2>
          <ul>
            <li>Breaks problems into human-readable steps with hints.</li>
            <li>Detects when to scaffold vs. when to summarize.</li>
            <li>Supports algebraic checks and definition lookups.</li>
          </ul>
        </div>

        <div class="tile span-6">
          <div class="kicker">Gomega AI</div>
          <h2>Conversations That Do Things</h2>
          <ul>
            <li>Understands goals, not just sentences.</li>
            <li>Coordinates multi-step tasks with guardrails.</li>
            <li>Integrates with Plus memberships and advanced modes.</li>
          </ul>
        </div>

        <div class="tile span-8">
          <div class="kicker">Architecture</div>
          <h2>How It Works (High-Level)</h2>
          <ul>
            <li><strong>Perception</strong> → parse inputs and state.</li>
            <li><strong>Planning</strong> → choose skills/data ordering.</li>
            <li><strong>Execution</strong> → run steps with fallbacks.</li>
            <li><strong>Explanation</strong> → answer + optional trace.</li>
          </ul>
          <p>The same flow powers the Browser launch, Homework Helper, and Gomega AI task orchestration.</p>
        </div>

        <div class="tile span-4">
          <div class="kicker">Roadmap</div>
          <h2>What’s Next</h2>
          <ul>
            <li>Barcode-gated access on every core page.</li>
            <li>Richer skill library and adapters.</li>
            <li>Optional personalized context packs.</li>
          </ul>
        </div>

        <div class="tile span-12">
          <div class="foot">
            <a class="linkbtn" href="https://gomega.watch/Intelligence" target="_blank" rel="noopener">
              <span>Want more from Gomega Intelligence?</span> <strong>Visit gomega.watch/Intelligence →</strong>
            </a>
          </div>
        </div>
      </div>
    </div><!-- /content -->
  </div>

  <!-- Welcome Overlay -->
  <div class="overlay" id="welcomeOverlay" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle">
    <div class="welcome">
      <h3 id="welcomeTitle">Welcome</h3>
      <p id="welcomeMsg">Access granted.</p>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="dismissBtn">Dismiss</button>
        <button class="btn" id="relockBtn">Lock & Re-Scan</button>
      </div>
    </div>
  </div>

<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<script>
(function(){
  const IDS_URL = 'browser/ids.csv'; // same-origin CSV: number,name

  const qs = new URLSearchParams(location.search);
  const session = qs.get('session') || '';

  const statusEl = document.getElementById('status');
  const hintEl   = document.getElementById('hint');
  const descEl   = document.getElementById('desc');
  const readingEl= document.getElementById('reading');
  const idsState = document.getElementById('idsState');
  const video    = document.getElementById('preview');
  const overlay  = document.getElementById('overlay');
  const ctx      = overlay.getContext('2d');
  const flipBtn  = document.getElementById('flip');
  const lockBtn  = document.getElementById('lock');
  const stage    = document.getElementById('stage');
  const content  = document.getElementById('content');

  const welcomeOverlay = document.getElementById('welcomeOverlay');
  const welcomeTitle   = document.getElementById('welcomeTitle');
  const welcomeMsg     = document.getElementById('welcomeMsg');
  const dismissBtn     = document.getElementById('dismissBtn');
  const relockBtn      = document.getElementById('relockBtn');

  // Scanner robustness
  let currentDeviceId = null;
  let controlsRef = null;
  let mediaStream = null;
  let unlocked = false;
  let lastDraw = 0;
  let lastText = '';
  let repeatCount = 0;
  const CONFIRM_HITS = 3; // require 3 identical reads before accepting

  // ID map loaded from CSV
  const idMap = new Map();

  function setStatus(text, cls){
    statusEl.textContent = text;
    statusEl.classList.remove('ok','warn','info');
    if(cls === 'ok') statusEl.classList.add('ok');
    if(cls === 'warn') statusEl.classList.add('warn');
    if(cls === 'info') statusEl.classList.add('info');
  }

  function fitCanvas(){
    const r = video.getBoundingClientRect();
    overlay.width  = Math.max(1, r.width * devicePixelRatio);
    overlay.height = Math.max(1, r.height* devicePixelRatio);
    overlay.style.width  = r.width + 'px';
    overlay.style.height = r.height+ 'px';
  }
  addEventListener('resize', fitCanvas);

  async function enumerate(){
    try{
      const list = await navigator.mediaDevices.enumerateDevices();
      const cams = list.filter(d => d.kind === 'videoinput');
      if(cams.length > 1) flipBtn.hidden = false;
    }catch(e){}
  }

  async function startCamera(preferBack=true){
    setStatus('Requesting camera…','info');
    const constraints = {
      audio: false,
      video: {
        facingMode: preferBack ? { ideal:'environment' } : 'user',
        width: { ideal: 1920 },
        height:{ ideal: 1080 },
        frameRate: { ideal: 30, min: 10 }
      }
    };
    try{
      mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
    }catch(e){
      mediaStream = await navigator.mediaDevices.getUserMedia({ video:true });
    }
    video.srcObject = mediaStream;
    await video.play();
    await enumerate();
    await tuneTrackForFocus(mediaStream);
    fitCanvas();
    setStatus('Reading…','info');
  }

  async function tuneTrackForFocus(stream){
    try{
      const track = stream.getVideoTracks()[0];
      const caps = track.getCapabilities ? track.getCapabilities() : {};
      if(caps.focusMode && caps.focusMode.includes('continuous')){
        await track.applyConstraints({ advanced:[{ focusMode:'continuous' }] });
      }
      if(caps.width && caps.height){
        await track.applyConstraints({
          width: { ideal: Math.min(1920, caps.width.max || 1920) },
          height:{ ideal: Math.min(1080, caps.height.max || 1080) }
        });
      }
    }catch(e){}
  }

  flipBtn.onclick = async () => {
    try{ stopCamera(); }catch(e){}
    const list = await navigator.mediaDevices.enumerateDevices();
    const cams = list.filter(d => d.kind==='videoinput');
    if(!cams.length){ return; }
    const idx = currentDeviceId ? Math.max(0, cams.findIndex(d=>d.deviceId===currentDeviceId)) : -1;
    const next = cams[(idx+1) % cams.length];
    currentDeviceId = next.deviceId;
    await startCamera(true);
    await startDecoding();
  };

  function drawPoly(points, color, width=4){
    if(!points || !points.length) return;
    const now = performance.now();
    if(now - lastDraw < 40) return;
    lastDraw = now;

    const r = video.getBoundingClientRect();
    const sx = overlay.width / r.width;
    const sy = overlay.height/ r.height;

    ctx.clearRect(0,0,overlay.width,overlay.height);
    ctx.lineWidth = width;
    ctx.strokeStyle = color;
    ctx.beginPath();
    ctx.moveTo(points[0].x*sx, points[0].y*sy);
    for(let i=1;i<points.length;i++) ctx.lineTo(points[i].x*sx, points[i].y*sy);
    ctx.closePath();
    ctx.stroke();
  }

  function faintGuide(){
    ctx.clearRect(0,0,overlay.width,overlay.height);
    ctx.strokeStyle = "rgba(255,255,255,.25)";
    ctx.lineWidth = 2;
    const w = overlay.width*.6, h = overlay.height*.3;
    const x = (overlay.width-w)/2, y = (overlay.height-h)/2;
    ctx.strokeRect(x,y,w,h);
  }

  function outlineUnlocked(){
    ctx.clearRect(0,0,overlay.width,overlay.height);
    drawPoly([
      {x:20,y:20},
      {x:overlay.width-20,y:20},
      {x:overlay.width-20,y:overlay.height-20},
      {x:20,y:overlay.height-20}
    ], '#22c55e', 5);
  }

  function stopCamera(){
    if(controlsRef && controlsRef.stop) { try{ controlsRef.stop(); }catch(e){} }
    if(controlsRef && controlsRef.reset){ try{ controlsRef.reset(); }catch(e){} }
    controlsRef = null;
    if(mediaStream){
      try{ mediaStream.getTracks().forEach(t=>t.stop()); }catch(e){}
    }
    mediaStream = null;
    video.srcObject = null;
  }

  function reLock(){
    unlocked = false;
    setStatus('Locked','warn');
    hintEl.textContent = 'Show your barcode to the camera.';
    content.classList.add('hidden');
    lockBtn.hidden = true;
    welcomeOverlay.classList.remove('show');
    ctx.clearRect(0,0,overlay.width,overlay.height);
    readingEl.hidden = true;
    (async()=>{ await startCamera(true); await startDecoding(); })();
  }

  lockBtn.onclick = reLock;
  relockBtn.onclick = reLock;

  // Dismiss = close camera preview and proceed to info
  dismissBtn.onclick = () => {
    stopCamera();
    stage.classList.add('hidden');
    welcomeOverlay.classList.remove('show');
  };

  // ---- CSV LOAD ----
  async function loadIds(){
    try{
      const res = await fetch(IDS_URL, { cache:'no-store' });
      if(!res.ok) throw new Error('Failed to fetch ids.csv');
      const text = await res.text();
      idMap.clear();
      text.split(/\r?\n/).forEach(line => {
        const raw = line.trim();
        if(!raw) return;
        // Split by first comma: number,name (names may contain commas later if you want)
        const idx = raw.indexOf(',');
        let code, name;
        if(idx >= 0){
          code = raw.slice(0, idx).trim();
          name = raw.slice(idx+1).trim();
        }else{
          code = raw.trim();
          name = '';
        }
        if(/^\d{6,20}$/.test(code)){
          idMap.set(code, name || '');
        }
      });
      idsState.hidden = false;
      idsState.textContent = `IDs: ${idMap.size}`;
    }catch(e){
      idsState.hidden = false;
      idsState.textContent = 'IDs: load error';
    }
  }

  // ---- ZXing setup ----
  const reader = new ZXing.BrowserMultiFormatReader();
  try{
    const hints = new Map();
    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
    // Limit to formats commonly used for numeric barcodes + QR (QR often used to encode numbers too)
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
      ZXing.BarcodeFormat.QR_CODE,
      ZXing.BarcodeFormat.CODE_128,
      ZXing.BarcodeFormat.CODE_39,
      ZXing.BarcodeFormat.CODE_93,
      ZXing.BarcodeFormat.EAN_13,
      ZXing.BarcodeFormat.EAN_8,
      ZXing.BarcodeFormat.UPC_A,
      ZXing.BarcodeFormat.ITF,
      ZXing.BarcodeFormat.CODABAR
    ]);
    reader.setHints(hints);
  }catch(e){}

  function stableHit(txt){
    if(txt === lastText){ repeatCount++; } else { lastText = txt; repeatCount = 1; }
    return repeatCount >= CONFIRM_HITS;
  }

  function verifyLocally(numericCode){
    // Only codes present in ids.csv are accepted
    if(!/^\d{6,20}$/.test(numericCode)) return { ok:false, name:null };
    if(!idMap.has(numericCode)) return { ok:false, name:null };
    return { ok:true, name:idMap.get(numericCode) || null };
  }

  function showWelcome(name){
    welcomeTitle.textContent = name ? `Welcome, ${name}` : 'Welcome';
    welcomeMsg.textContent = 'Access granted to Gomega Intelligence.';
    welcomeOverlay.classList.add('show');
  }

  function unlockUI(){
    setStatus('Unlocked — content revealed','ok');
    hintEl.textContent = 'Access granted.';
    outlineUnlocked();
    content.classList.remove('hidden');
    lockBtn.hidden = false;
    readingEl.hidden = true;
  }

  async function startDecoding(){
    try{
      const inputs = await reader.listVideoInputDevices();
      let deviceId = (inputs && inputs.length) ? inputs[0].deviceId : undefined;

      controlsRef = reader.decodeFromConstraints({
        audio: false,
        video: {
          deviceId: deviceId ? { exact: deviceId } : undefined,
          facingMode: { ideal: 'environment' },
          width: { ideal: 1920 }, height: { ideal: 1080 },
          frameRate: { ideal: 30, min: 10 }
        }
      }, 'preview', (result, err, controls) => {
        if(unlocked) return;

        if(result && result.getText){
          const txt = (result.getText() || '').trim();
          const pts = (result.resultPoints || []).map(p => ({x:p.getX(), y:p.getY()}));

          // numeric-only policy
          const isNumeric = /^\d{6,20}$/.test(txt);

          // blue while reading anything decodable; only proceed if numeric
          drawPoly(pts, isNumeric ? '#60a5fa' : '#ef4444');
          readingEl.hidden = false;
          readingEl.textContent = 'Reading barcode…';

          if(isNumeric && stableHit(txt)){
            const { ok, name } = verifyLocally(txt);
            if(ok){
              unlocked = true;
              controls && controls.stop();
              drawPoly(pts, '#22c55e');
              setStatus('Verified','ok');
              unlockUI();
              showWelcome(name);
            }else{
              setStatus('Code not recognized','warn');
              drawPoly(pts, '#ef4444');
              readingEl.hidden = true;
            }
          }else if(!isNumeric){
            setStatus('Invalid code format','warn');
          }
        }else if(err && !(err instanceof ZXing.NotFoundException)){
          setStatus('Camera decode error','warn');
          readingEl.hidden = true;
        }else if(!unlocked){
          faintGuide();
        }
      });
    }catch(e){
      setStatus('Failed to start scanner','warn');
      hintEl.textContent = (e && e.message) ? e.message : 'Check camera permissions.';
      readingEl.hidden = true;
    }
  }

  (async () => {
    descEl.textContent = 'Gomega Intelligence is loading your camera…';
    await loadIds();            // load browser/ids.csv first
    await startCamera(true);    // then open camera
    await startDecoding();      // and start decoding
  })();
})();
</script>
</body>
</html>
