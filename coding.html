<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coding Editor</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #toolbar {
            background: #333;
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #language {
            padding: 5px;
            background: #555;
            color: white;
            border: none;
            border-radius: 3px;
        }
        #run-btn {
            padding: 5px 10px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        #run-btn:hover {
            background: #005a9e;
        }
        #container {
            display: flex;
            flex: 1;
        }
        #editor-container {
            flex: 1;
            border-right: 1px solid #ccc;
        }
        #preview-container {
            flex: 1;
            padding: 10px;
            overflow: auto;
            background: #f5f5f5;
        }
        #output {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 3px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        #errors {
            margin-top: 10px;
            padding: 10px;
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 3px;
            color: #c62828;
            font-family: monospace;
        }
    </style>
    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <!-- Pyodide for Python -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
    <!-- Wasmoon for Lua -->
    <script src="https://cdn.jsdelivr.net/npm/wasmoon@1.2.0/dist/wasmoon.js"></script>
</head>
<body>
    <div id="toolbar">
        <label for="language">Language:</label>
        <select id="language">
            <option value="html">HTML</option>
            <option value="python">Python</option>
            <option value="lua">Lua</option>
        </select>
        <button id="run-btn">Run</button>
    </div>
    <div id="container">
        <div id="editor-container"></div>
        <div id="preview-container">
            <h3>Preview/Output</h3>
            <div id="preview"></div>
            <div id="output"></div>
            <div id="errors"></div>
        </div>
    </div>

    <script>
        let editor;
        let pyodide;
        let luaEngine;
        let currentOutput = '';
        let currentErrors = '';

        async function initPyodide() {
            pyodide = await loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.1/full/"
            });
            // Redirect stdout and stderr for Python
            pyodide.runPython(`
                import sys
                class StdoutRedirect:
                    def write(self, text):
                        js.stdout_callback(text)
                class StderrRedirect:
                    def write(self, text):
                        js.stderr_callback(text)
                sys.stdout = StdoutRedirect()
                sys.stderr = StderrRedirect()
            `);
        }

        async function initLua() {
            const { LuaFactory } = window.wasmoon;
            const factory = new LuaFactory();
            luaEngine = await factory.createEngine();
            // Override print for Lua
            luaEngine.global.set('print', (...args) => {
                let out = '';
                for (let i = 0; i < args.length; i++) {
                    if (i > 0) out += '\t';
                    // Simple conversion, assuming args are numbers or strings
                    let arg = args[i];
                    if (typeof arg === 'number') out += arg;
                    else if (typeof arg === 'string') out += arg;
                    else out += JSON.stringify(arg);
                }
                currentOutput += out + '\n';
                return 0;
            });
            // Also set a simple tostring if needed
            luaEngine.global.set('tostring', (arg) => {
                return typeof arg === 'number' ? arg.toString() : JSON.stringify(arg);
            });
        }

        function initEditor() {
            require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
            require(['vs/editor/editor.main'], function () {
                editor = monaco.editor.create(document.getElementById('editor-container'), {
                    value: [
                        lang === 'html' ? '<h1>Hello World!</h1>' :
                        lang === 'python' ? 'print("Hello, Python!")' :
                        'print("Hello, Lua!")'
                    ].join('\n'),
                    language: 'html',
                    theme: 'vs-dark',
                    automaticLayout: true
                });
                // Enable suggestions
                monaco.languages.registerCompletionItemProvider('python', {
                    provideCompletionItems: () => {
                        return {
                            suggestions: [
                                { label: 'print', kind: monaco.languages.CompletionItemKind.Function, insertText: 'print($1)' },
                                { label: 'def', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'def ${1:function}($2):\n    $0' }
                            ]
                        };
                    }
                });
                // Similar for Lua, but basic
                monaco.languages.registerCompletionItemProvider('lua', {
                    provideCompletionItems: () => {
                        return {
                            suggestions: [
                                { label: 'print', kind: monaco.languages.CompletionItemKind.Function, insertText: 'print($1)' },
                                { label: 'function', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'function ${1:name}($2)\n    $0\nend' }
                            ]
                        };
                    }
                });
            });
        }

        async function runCode() {
            const code = editor.getValue();
            const lang = document.getElementById('language').value;
            const preview = document.getElementById('preview');
            const outputDiv = document.getElementById('output');
            const errorsDiv = document.getElementById('errors');
            currentOutput = '';
            currentErrors = '';

            editor.setModelLanguage(monaco.editor.getModels()[0], lang);

            if (lang === 'html') {
                preview.innerHTML = `<iframe id="frame" style="width:100%; height:400px; border:1px solid #ccc;"></iframe>`;
                const frame = document.getElementById('frame');
                frame.srcdoc = code;
                outputDiv.innerHTML = '';
                errorsDiv.innerHTML = '';
            } else {
                preview.innerHTML = '<h4>Output:</h4>';
                outputDiv.innerHTML = '';
                errorsDiv.innerHTML = '';
                try {
                    if (lang === 'python') {
                        // Set callbacks
                        pyodide.runPython(`
                            def stdout_callback(text):
                                js.output_update.value += text
                            def stderr_callback(text):
                                js.errors_update.value += text
                        `);
                        await pyodide.runPythonAsync(code);
                    } else if (lang === 'lua') {
                        await luaEngine.doString(code);
                    }
                    outputDiv.innerHTML = currentOutput;
                } catch (err) {
                    errorsDiv.innerHTML = err.message || err;
                }
            }
        }

        // Global functions for Python callbacks
        window.stdout_callback = (text) => { currentOutput += text; };
        window.stderr_callback = (text) => { currentErrors += text; };
        window.output_update = { value: '' }; // Hack for JS to Python
        // Actually, since it's lambda, but to update, better use postMessage or something, but for simplicity, use global var and update after.

        // Better way for Python: use runPythonAsync with opts
        // Update the runCode for Python:
        // await pyodide.runPythonAsync(code, {
        //   stdout: (text) => { currentOutput += text; outputDiv.innerHTML = currentOutput; },
        //   stderr: (text) => { currentErrors += text; errorsDiv.innerHTML = currentErrors; }
        // });

        // Yes, Pyodide supports that in v0.20+.

        // Correct in code:
        // For Python:
        // try {
        //   const result = await pyodide.runPythonAsync(code, {
        //     stdout: (text) => { currentOutput += text; },
        //     stderr: (text) => { currentErrors += text; }
        //   });
        //   outputDiv.innerHTML = currentOutput;
        //   if (currentErrors) errorsDiv.innerHTML = currentErrors;
        // } catch (err) {
        //   errorsDiv.innerHTML = err.message;
        // }

        // For Lua, since doString is sync? Wait, example has await, so async.

        // Assume.

        // Init
        let lang = 'html';
        document.getElementById('language').addEventListener('change', (e) => {
            lang = e.target.value;
            const initialCode = lang === 'html' ? '<h1>Hello!</h1>' : lang === 'python' ? 'print("Hello Python!")\n' : 'print("Hello Lua!")\n';
            editor.setValue(initialCode);
            editor.setModelLanguage(monaco.editor.getModels()[0], lang);
        });

        document.getElementById('run-btn').addEventListener('click', runCode);

        // Start init
        async function start() {
            await initPyodide();
            await initLua();
            initEditor();
            runCode(); // Initial run
        }
        start();
    </script>
</body>
</html>
